<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Envio de Mensagens WhatsApp ‚Äî Vers√£o Melhorada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb;--card:#ffffff;--txt:#222;--muted:#6b7280;--primary:#2563eb;--primary-d:#1d4ed8;
      --success:#16a34a;--warn:#d97706;--danger:#dc2626;--outline:#e5e7eb;--radius:12px;
    }
    *{box-sizing:border-box}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      margin:0;padding:24px;background:var(--bg);color:var(--txt);
    }
    .container{max-width:1100px;margin:0 auto}
    .card{
      background:var(--card);border:1px solid var(--outline);padding:18px;border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.04);
    }
    h1{margin:0 0 10px;font-size:22px}
    h2{font-size:16px;margin:18px 0 8px;color:var(--muted);font-weight:600}
    label{display:block;font-weight:600;margin:10px 0 6px}

    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--outline);border-radius:8px;background:#fff;
    }
    textarea{resize:vertical;min-height:72px}

    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:start}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--outline);
      cursor:pointer;background:var(--primary);color:#fff;font-weight:600;
    }
    .btn:hover{background:var(--primary-d)}
    .btn.secondary{background:#fff;color:var(--txt)}
    .btn.secondary:hover{background:#f8fafc}
    .btn.success{background:var(--success)}
    .btn.warn{background:var(--warn)}
    .btn.danger{background:var(--danger)}

    #previewArea{
      background:#f1f5f9;border:1px dashed #cbd5e1;padding:12px;border-radius:10px;white-space:pre-wrap;
    }
    #output{
      background:#0b1220;color:#d1e6ff;padding:12px;border-radius:10px;min-height:140px;font-family:ui-monospace,monospace;
      white-space:pre-wrap;overflow-y:auto;
    }
    .muted{color:var(--muted);font-size:12px}

    .bar{background:#e5e7eb;border-radius:999px;height:12px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#22c55e);transition:width .3s ease}

    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:700;border:1px solid #c7d2fe;
    }
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .hide{display:none}
    details summary{cursor:pointer}
    .kbd{
      background:#e5e7eb;border:1px solid #cbd5e1;padding:1px 6px;border-radius:6px;font-family:ui-monospace,monospace;font-size:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Envio de Mensagens WhatsApp com Template <span class="pill">vers√£o 2025-08-14</span></h1>
      <div class="muted">
        Corrige envio sem header, mapeia m√∫ltiplos par√¢metros, pausa/retoma/cancela, pagina templates, melhora custos e CSV.
      </div>

      <!-- Credenciais -->
      <h2>Credenciais</h2>
      <div class="row">
        <div class="col-6">
          <label for="token">Token de Acesso</label>
          <input id="token" placeholder="Cole seu token" required />
        </div>
        <div class="col-6">
          <label for="wabaId">WhatsApp Business ID</label>
          <input id="wabaId" placeholder="Ex: 316717608975353" required />
        </div>
        <div class="col-6">
          <label for="phoneId">Phone Number ID</label>
          <input id="phoneId" placeholder="Ex: 752755661251472" required />
        </div>
        <div class="col-6">
          <label for="graphVersion">Vers√£o Graph API</label>
          <select id="graphVersion">
            <option value="v23.0">v23.0</option>
            <option value="v22.0">v22.0</option>
            <option value="v21.0">v21.0</option>
            <option value="v20.0">v20.0</option>
            <option value="v19.0">v19.0</option>
            <option value="v18.0" selected>v18.0</option>
          </select>
        </div>
      </div>

      <!-- Buscar templates -->
      <div class="row" style="margin-top:12px;align-items:end">
        <div class="col-6">
          <button class="btn" id="btnBuscar">üîç Buscar templates aprovados</button>
        </div>
        <div class="col-6">
          <label for="templateSelect">Template</label>
          <select id="templateSelect">
            <option value="">-- Selecione um template --</option>
          </select>
        </div>
      </div>

      <!-- Campos do Template -->
      <div class="row" style="margin-top:6px;">
        <div class="col-6">
          <label for="templateName">Nome do Template</label>
          <input id="templateName" readonly />
        </div>
        <div class="col-3">
          <label for="templateCategory">Categoria</label>
          <select id="templateCategory">
            <option value="">-- Selecione --</option>
            <option value="authentication">Authentication</option>
            <option value="marketing">Marketing</option>
            <option value="utility">Utility</option>
            <option value="service">Service</option>
          </select>
        </div>
        <div class="col-3">
          <label for="headerFormat">Formato de Header</label>
          <input id="headerFormat" readonly />
        </div>
      </div>

      <!-- Configura√ß√µes do HEADER (aparece conforme o formato) -->
      <div class="row" id="headerParams" style="margin-top:6px;">
        <div class="col-12" id="headerTextWrap" class="hide">
          <div class="muted">
            Header <b>TEXT</b> com vari√°veis: fa√ßa o mapeamento em <b>Mapeamento de Vari√°veis</b> (abaixo).
          </div>
        </div>
        <div class="col-12 hide" id="mediaLinkWrap">
          <label for="mediaLink">Link da M√≠dia do Header (quando HEADER = IMAGE/VIDEO/DOCUMENT)</label>
          <input id="mediaLink" placeholder="https://... (acess√≠vel publicamente)" />
          <div class="muted">Se informado, ser√° enviado como header de m√≠dia do template.</div>
        </div>
      </div>

      <!-- Pr√©-visualiza√ß√£o -->
      <div class="row" style="margin-top:6px;">
        <div class="col-12">
          <h2>Pr√©-visualiza√ß√£o</h2>
          <div id="previewArea">Selecione um template para ver a pr√©via aqui.</div>
        </div>
      </div>

      <!-- Contatos + Estrat√©gia + Mapeamento -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Contatos</h2>
          <div class="grid-2">
            <div>
              <label for="fileInput">Arquivo (.csv ou .txt)</label>
              <input id="fileInput" type="file" accept=".csv,.txt" />
            </div>
            <div>
              <label for="estrategiaSelect">Estrat√©gia (exemplo interno)</label>
              <select id="estrategiaSelect">
                <option value="">-- Nenhuma --</option>
                <option value="estrategia1">estrategia1</option>
                <option value="estrategia2">estrategia2</option>
              </select>
            </div>
          </div>
          <div id="contagemContatos" class="muted" style="margin-top:6px;">Nenhum contato ainda.</div>
        </div>
        <div class="col-6">
          <h2>Mapeamento de Vari√°veis</h2>
          <div id="mapArea" class="muted">Carregue contatos e selecione um template.</div>
        </div>
      </div>

      <!-- Custos -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Custo Estimado</h2>
          <div id="custoEstimado">üíµ Custo estimado: ‚Äî</div>
          <div id="custoReal">üí≥ Valor em Reais (com taxa): ‚Äî</div>
        </div>
        <div class="col-6">
          <label for="taxaConversaoExtra">Acr√©scimo (%)</label>
          <input id="taxaConversaoExtra" type="number" min="0" step="0.01" value="6" />
        </div>
      </div>

      <!-- Agendamento e Ritmo de Envio -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Modo de Envio</h2>
          <div class="grid-2">
            <div>
              <label for="modoEnvio">Modo</label>
              <select id="modoEnvio">
                <option value="imediato" selected>Imediato</option>
                <option value="agendar">Agendar</option>
              </select>
            </div>
            <div id="dataHoraWrap" class="hide">
              <label for="dataHoraEnvio">Data/Hora (agendamento)</label>
              <input id="dataHoraEnvio" type="datetime-local" />
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">Para agendar, mantenha a aba aberta at√© o envio ocorrer.</div>
        </div>
        <div class="col-6">
          <h2>Ritmo / Lotes</h2>
          <div class="grid-3">
            <div>
              <label for="tamanhoLote">Tamanho do Lote</label>
              <input id="tamanhoLote" type="number" min="1" placeholder="ex.: 50" />
            </div>
            <div>
              <label for="intervaloLote">Intervalo entre Lotes (min)</label>
              <input id="intervaloLote" type="number" min="0" value="0" />
            </div>
            <div>
              <label for="intervaloMsg">Intervalo entre Mensagens (s)</label>
              <input id="intervaloMsg" type="number" min="0" value="0" />
            </div>
          </div>
        </div>
      </div>

      <!-- Envio -->
      <div class="row" style="margin-top:16px;align-items:center;">
        <div class="col-8">
          <button class="btn success" id="btnEnviar">üöÄ Enviar</button>
          <button class="btn secondary" id="btnPausar">‚è∏Ô∏è Pausar</button>
          <button class="btn secondary" id="btnRetomar" disabled>‚ñ∂Ô∏è Retomar</button>
          <button class="btn danger" id="btnCancelar" disabled>üõë Cancelar</button>
          <button class="btn warn" id="btnNovoEnvio">üîÑ Novo Envio</button>
        </div>
        <div class="col-4" style="text-align:right">
          <div class="bar"><span id="progressBar"></span></div>
          <div class="muted" id="progressTxt">0/0</div>
        </div>
      </div>

      <!-- Logs -->
      <div class="row" style="margin-top:12px;">
        <div class="col-12">
          <h2>Logs</h2>
        </div>
        <div class="col-12">
          <div id="output">Pronto para enviar.</div>
          <div class="grid-3" style="margin-top:8px;">
            <div>‚úÖ Sucesso: <b id="okCount">0</b></div>
            <div>‚ùå Erros: <b id="errCount">0</b></div>
            <div><button class="btn secondary" id="btnBaixarLog">‚¨áÔ∏è Baixar log</button></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---------------------------- Estado ----------------------------
    const estrategias = {
      estrategia1: [
        { to: "5561993742606", vars: ["Joubert"] },
        { to: "5592991029242", vars: ["Savio"] },
        { to: "5561996777300", vars: ["Ayrton"] },
      ],
      estrategia2: [
        { to: "5561993742601", vars: ["Joubert"] },
        { to: "5561993742602", vars: ["JoubertC"] },
      ],
    };

    let contatos = [];              // [{ to: '55...', vars: ['v1','v2', ...] }]
    let csvHeaders = [];            // ['telefone','nome','codigo', ...]
    let custoEmDolar = 0;           // custo estimado
    let mapping = {                 // qual coluna alimenta cada {{n}}
      body: [],                     // array de √≠ndices (0-based) para {{1}}, {{2}} ...
      headerText: [],               // idem, para HEADER TEXT
      urlButtons: {},               // { index: 0 => [colIdxFor{{1}}] }
    };
    let tmpl = {                    // metadados do template selecionado
      name: "",
      category: "",
      components: [],
      bodyText: "",
      bodyVars: 0,
      headerType: null,             // null | TEXT | IMAGE | VIDEO | DOCUMENT
      headerText: "",
      headerVars: 0,
      urlButtons: [],               // lista de {index, url, hasVar}
    };

    let flags = { paused: false, cancelled: false };

    // ---------------------------- Utils ----------------------------
    const $ = (sel) => document.querySelector(sel);
    const byId = (id) => document.getElementById(id);

    function log(line){
      const out = byId('output');
      out.textContent += (out.textContent ? "\n" : "") + line;
      out.scrollTop = out.scrollHeight;
    }

    function setProgress(done, total){
      const pct = total > 0 ? (done / total) * 100 : 0;
      byId('progressBar').style.width = pct.toFixed(1) + '%';
      byId('progressTxt').textContent = `${done}/${total}`;
    }

    function countPlaceholders(text){
      if(!text) return 0;
      const matches = text.match(/\{\{\d+\}\}/g);
      return matches ? new Set(matches).size : 0;
    }

    function substitutePlaceholders(text, values){
      // values: array where index 0 is {{1}}, index 1 is {{2}}, ...
      if(!text) return '';
      return text.replace(/\{\{(\d+)\}\}/g, (_, n) => {
        const idx = parseInt(n,10) - 1;
        return values[idx] != null ? String(values[idx]) : `{{${n}}}`;
      });
    }

    function parseCSV(text){
      // CSV simples com , ou ; e aspas
      const delim = text.includes(';') && !text.includes(',') ? ';' : ',';
      const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l => l.trim().length>0);
      const rows = [];
      for(const line of lines){
        const row = [];
        let cur = '', inQ = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch === '"'){
            if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
            else { inQ = !inQ; }
          }else if(ch === delim && !inQ){
            row.push(cur); cur='';
          }else{
            cur += ch;
          }
        }
        row.push(cur);
        rows.push(row.map(c => c.trim()));
      }
      return rows;
    }

    function ensureNumber(v, fallback=0){
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // ---------------------------- UI Helpers ----------------------------
    function renderSelect(id, varIndex, current){
      let opts = '';
      if(csvHeaders.length>0){
        csvHeaders.forEach((h, idx) => {
          const sel = idx === current ? 'selected' : '';
          opts += `<option value="${idx}" ${sel}>${idx+1} ‚Äî ${escapeHtml(h)}</option>`;
        });
      }else{
        // fallback pelo n¬∫ de colunas detectado
        const maxCols = Math.max(1, ...(contatos.map(c => c.vars.length)));
        for(let idx=0; idx<maxCols; idx++){
          const sel = idx === current ? 'selected' : '';
          opts += `<option value="${idx}" ${sel}>${idx+1}</option>`;
        }
      }
      return `<label for="${id}">{{${varIndex+1}}} ‚ü∂ coluna</label><select id="${id}">${opts}</select>`;
    }

    function renderMapUI(){
      const area = byId('mapArea');
      const hasTemplate = !!tmpl.name;
      const hasContacts = contatos.length > 0;

      if(!hasTemplate || !hasContacts){
        area.innerHTML = '<span class="muted">Carregue contatos e selecione um template para configurar o mapeamento.</span>';
        return;
      }

      const headerPart = (() => {
        if(!tmpl.headerType) return '';
        if(tmpl.headerType === 'TEXT' && tmpl.headerVars > 0){
          let selects = '';
          for(let i=0;i<tmpl.headerVars;i++){
            selects += renderSelect(`map-header-${i}`, i, mapping.headerText[i]);
          }
          return `<h3>Header TEXT ‚Äî vari√°veis</h3>${selects}`;
        }
        if(['IMAGE','VIDEO','DOCUMENT'].includes(tmpl.headerType)){
          return '<div class="muted">Header de m√≠dia usa a URL informada em "Link da M√≠dia do Header".</div>';
        }
        return '';
      })();

      let bodySelects = '';
      if(tmpl.bodyVars > 0){
        bodySelects += '<h3>Body ‚Äî vari√°veis</h3>';
        for(let i=0;i<tmpl.bodyVars;i++){
          bodySelects += renderSelect(`map-body-${i}`, i, mapping.body[i]);
        }
      }else{
        bodySelects += '<div class="muted">Body sem vari√°veis.</div>';
      }

      let buttonsPart = '';
      if(tmpl.urlButtons.length > 0){
        buttonsPart += '<h3>Bot√µes URL ‚Äî vari√°veis</h3>';
        tmpl.urlButtons.forEach(btn => {
          if(btn.hasVar){
            buttonsPart += `<div style="margin:6px 0 10px"><b>Bot√£o #${btn.index+1}</b> ‚Äî URL base: <span class="kbd">${btn.url}</span><br/>` +
              renderSelect(`map-urlbtn-${btn.index}-0`, 0, mapping.urlButtons[btn.index]?.[0]) + '</div>';
          }
        });
      }

      const sample = contatos[0] || { to:'', vars:[] };
      const bodyPreviewVals = (mapping.body || []).map(ci => ci != null ? sample.vars[ci] : '');
      const bodyPrev = substitutePlaceholders(tmpl.bodyText, bodyPreviewVals);

      area.innerHTML = `
        ${headerPart}
        ${bodySelects}
        ${buttonsPart}
        <div style="margin-top:10px">
          <div class="muted">Pr√©via com o <b>primeiro contato</b>:</div>
          <div class="card" style="padding:10px;border:1px dashed #cbd5e1;">
            ${bodyPrev.replace(/\n/g,'<br/>')}
          </div>
        </div>
      `;

      // listeners dos selects
      if(tmpl.headerType === 'TEXT'){
        for(let i=0;i<tmpl.headerVars;i++){
          byId(`map-header-${i}`)?.addEventListener('change', (e) => {
            mapping.headerText[i] = ensureNumber(e.target.value, 0);
          });
        }
      }
      for(let i=0;i<tmpl.bodyVars;i++){
        byId(`map-body-${i}`)?.addEventListener('change', (e) => {
          mapping.body[i] = ensureNumber(e.target.value, 0);
          renderMapUI(); // refresh preview
        });
      }
      tmpl.urlButtons.forEach(btn => {
        if(btn.hasVar){
          byId(`map-urlbtn-${btn.index}-0`)?.addEventListener('change', (e) => {
            mapping.urlButtons[btn.index] = [ensureNumber(e.target.value, 0)];
          });
        }
      });
    }

    // ---------------------------- Custos ----------------------------
    async function calcularCusto(){
      const categoria = byId('templateCategory').value;
      const qtd = contatos.length;
      if(!categoria || !qtd){
        byId('custoEstimado').textContent = 'üíµ Custo estimado: ‚Äî';
        byId('custoReal').textContent = 'üí≥ Valor em Reais (com taxa): ‚Äî';
        return;
      }
      // valores aproximados ‚Äî ajuste conforme sua tabela vigente
      const price = (categoria === 'authentication' || categoria === 'utility') ? 0.0068 : (categoria === 'marketing' ? 0.0625 : 0);
      custoEmDolar = qtd * price;
      byId('custoEstimado').textContent = `üíµ Custo estimado: $${custoEmDolar.toFixed(4)}`;

      try{
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await res.json();
        const brl = data?.rates?.BRL ?? 5.0; // fallback
        const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
        const final = custoEmDolar * brl * taxa;
        byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa): R$${final.toFixed(2)}`;
      }catch(e){
        const brl = 5.0; // fallback
        const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
        const final = custoEmDolar * brl * taxa;
        byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa ‚Äì c√¢mbio offline): R$${final.toFixed(2)}`;
      }
    }

    // ---------------------------- Templates ----------------------------
    byId('btnBuscar').addEventListener('click', buscarTemplates);
    async function buscarTemplates(){
      const token = byId('token').value.trim();
      const wabaId = byId('wabaId').value.trim();
      const ver = byId('graphVersion').value;
      if(!token || !wabaId){ alert('Informe token e WABA ID.'); return; }

      const select = byId('templateSelect');
      select.innerHTML = '<option value="">Carregando...</option>';

      const urlBase = `https://graph.facebook.com/${ver}/${encodeURIComponent(wabaId)}/message_templates?limit=100&status=APPROVED`;
      const all = [];
      let next = urlBase;
      try{
        while(next){
          const r = await fetch(next, { headers:{ Authorization:`Bearer ${token}` }});
          const j = await r.json();
          if(Array.isArray(j.data)) all.push(...j.data);
          next = j?.paging?.next || null;
        }
      }catch(e){
        alert('Erro ao buscar templates: ' + e.message);
        select.innerHTML = '<option value="">-- Erro ao buscar --</option>';
        return;
      }

      if(all.length === 0){
        select.innerHTML = '<option value="">-- Nenhum template aprovado encontrado --</option>';
        return;
      }

      select.innerHTML = '<option value="">-- Selecione um template --</option>';
      all.sort((a,b) => a.name.localeCompare(b.name)).forEach(t => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(t);
        opt.textContent = `${t.name} ¬∑ ${t.category}`;
        select.appendChild(opt);
      });
    }

    byId('templateSelect').addEventListener('change', preencherTemplateInfo);
    function preencherTemplateInfo(){
      const val = byId('templateSelect').value;
      if(!val) return;
      const t = JSON.parse(val);

      tmpl.name = t.name;
      tmpl.category = t.category || '';
      tmpl.components = t.components || [];
      byId('templateName').value = tmpl.name;
      byId('templateCategory').value = tmpl.category || '';

      const header = tmpl.components.find(c => c.type === 'HEADER');
      const body = tmpl.components.find(c => c.type === 'BODY');
      const buttons = tmpl.components.find(c => c.type === 'BUTTONS');

      // Reset UI header
      tmpl.headerType = null;
      tmpl.headerText = '';
      tmpl.headerVars = 0;
      byId('headerFormat').value = '';
      byId('headerTextWrap').classList.add('hide');
      byId('mediaLinkWrap').classList.add('hide');

      // Header
      if(header){
        const fmt = header.format; // TEXT | IMAGE | VIDEO | DOCUMENT
        tmpl.headerType = fmt;
        byId('headerFormat').value = fmt || '';
        if(fmt === 'TEXT'){
          tmpl.headerText = header.text || '';
          tmpl.headerVars = countPlaceholders(tmpl.headerText);
          byId('headerTextWrap').classList.remove('hide');
        }else if(['IMAGE','VIDEO','DOCUMENT'].includes(fmt)){
          byId('mediaLinkWrap').classList.remove('hide');
        }
      }

      // Body
      tmpl.bodyText = body?.text || '';
      tmpl.bodyVars = countPlaceholders(tmpl.bodyText);

      // Buttons (apenas URL com {{1}})
      tmpl.urlButtons = [];
      if(buttons && Array.isArray(buttons.buttons)){
        buttons.buttons.forEach((b, idx) => {
          if(b.type === 'URL'){
            const hasVar = (b.url || '').includes('{{');
            tmpl.urlButtons.push({ index: idx, url: b.url || '', hasVar });
          }
        });
      }

      // Preview
      const exemplos = body?.example?.body_text?.[0] || [];
      const previewText = substitutePlaceholders(tmpl.bodyText, exemplos);
      byId('previewArea').textContent = previewText ? `üìÑ Pr√©-visualiza√ß√£o:\n${previewText}` : '‚Äî';

      // Mapeamento padr√£o
      mapping.body = Array.from({length: tmpl.bodyVars}, (_,i)=> i);
      mapping.headerText = Array.from({length: tmpl.headerVars}, (_,i)=> i);
      mapping.urlButtons = {};

      renderMapUI();
      calcularCusto();
    }

    // ---------------------------- Contatos ----------------------------
    byId('estrategiaSelect').addEventListener('change', function(){
      const selected = this.value;
      if(estrategias[selected]){
        contatos = JSON.parse(JSON.stringify(estrategias[selected]));
        csvHeaders = [];
        byId('contagemContatos').textContent = `‚úîÔ∏è Estrat√©gia "${selected}" carregada com ${contatos.length} contato(s).`;
        renderMapUI();
        calcularCusto();
      }
    });

    byId('fileInput').addEventListener('change', function(){
      const file = this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const rows = parseCSV(e.target.result);
        if(rows.length === 0) return;

        // Detecta cabe√ßalho
        const head = rows[0].map(c => (c||'').toLowerCase());
        const hasHeader = head.some(c => c.includes('telefone') || c === 'to' || c.includes('phone'));

        const dataRows = hasHeader ? rows.slice(1) : rows;
        csvHeaders = hasHeader ? rows[0] : (dataRows[0]?.map((_,i)=>`coluna_${i+1}`) || []);

        contatos = dataRows.map(r => ({
          to: (r[0] || '').replace(/\D+/g,''),
          vars: r.slice(1),
        })).filter(c => c.to);

        byId('contagemContatos').textContent = `‚úîÔ∏è Arquivo carregado com ${contatos.length} contato(s).`;
        renderMapUI();
        calcularCusto();
      };
      reader.readAsText(file);
    });

    byId('taxaConversaoExtra').addEventListener('change', calcularCusto);
    byId('templateCategory').addEventListener('change', calcularCusto);

    // ---------------------------- Agendamento UI ----------------------------
    byId('modoEnvio').addEventListener('change', () => {
      const isAgendar = byId('modoEnvio').value === 'agendar';
      byId('dataHoraWrap').classList.toggle('hide', !isAgendar);
    });

    // ---------------------------- Envio ----------------------------
    byId('btnEnviar').addEventListener('click', onEnviarClick);
    byId('btnPausar').addEventListener('click', () => {
      flags.paused = true; byId('btnRetomar').disabled = false; log('‚è∏Ô∏è Pausado.');
    });
    byId('btnRetomar').addEventListener('click', () => {
      flags.paused = false; byId('btnRetomar').disabled = true; log('‚ñ∂Ô∏è Retomado.');
    });
    byId('btnCancelar').addEventListener('click', () => {
      flags.cancelled = true; log('üõë Cancelado pelo usu√°rio.');
    });

    async function onEnviarClick(){
      const token = byId('token').value.trim();
      const phoneId = byId('phoneId').value.trim();
      const ver = byId('graphVersion').value;
      if(!token || !phoneId || !tmpl.name){ alert('Preencha token, phone ID e selecione um template.'); return; }
      if(contatos.length === 0){ alert('Nenhum contato carregado.'); return; }

      const modoEnvio = byId('modoEnvio').value;
      const dataHora = new Date(byId('dataHoraEnvio').value);

      const startSend = () => enviarMensagens({ token, phoneId, ver });

      if(modoEnvio === 'agendar'){
        const delay = dataHora - new Date();
        if(isNaN(delay) || delay <= 0){ alert('Informe uma data/hora futura para agendamento.'); return; }
        log(`üïí Envio agendado para ${dataHora.toLocaleString()} (a aba deve permanecer aberta).`);
        setTimeout(startSend, delay);
      }else{
        startSend();
      }
    }

    async function enviarMensagens({ token, phoneId, ver }){
      byId('btnCancelar').disabled = false;
      byId('okCount').textContent = '0';
      byId('errCount').textContent = '0';
      byId('output').textContent = '';
      flags.paused = false; flags.cancelled = false;

      const total = contatos.length;
      let enviados = 0, ok = 0, err = 0;
      const tamanhoLote = ensureNumber(byId('tamanhoLote').value, total) || total;
      const intervaloLoteMin = ensureNumber(byId('intervaloLote').value, 0);
      const intervaloMsgMs = Math.max(0, ensureNumber(byId('intervaloMsg').value, 0)) * 1000;

      const endpoint = (id) => `https://graph.facebook.com/${ver}/${id}/messages`;

      for(let i=0; i<total; i += tamanhoLote){
        const lote = contatos.slice(i, i + tamanhoLote);

        for(const contato of lote){
          if(flags.cancelled){ setProgress(enviados, total); break; }
          while(flags.paused){ await new Promise(r => setTimeout(r, 250)); }

          const payload = montarPayloadParaContato(contato);

          try{
            const res = await fetch(endpoint(phoneId), {
              method:'POST',
              headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
              body: JSON.stringify(payload),
            });
            const result = await res.json();
            if(res.ok){
              ok++;
              log(`‚úîÔ∏è ${contato.to}: enviado (status ${res.status}) ${result?.messages?.[0]?.id ? 'id ' + result.messages[0].id : ''}`);
            }else{
              err++;
              log(`‚ùå ${contato.to}: erro ${res.status} ${result?.error?.message || JSON.stringify(result)}`);
            }
          }catch(e){
            err++;
            log(`‚ùå ${contato.to}: falha de rede: ${e.message}`);
          }

          enviados++;
          byId('okCount').textContent = String(ok);
          byId('errCount').textContent = String(err);
          setProgress(enviados, total);
          if(intervaloMsgMs > 0) await new Promise(r => setTimeout(r, intervaloMsgMs));
        }

        if(flags.cancelled) break;
        if(i + tamanhoLote < total && intervaloLoteMin > 0){
          log(`‚è±Ô∏è Aguardando ${intervaloLoteMin} minuto(s) para o pr√≥ximo lote...`);
          await new Promise(r => setTimeout(r, intervaloLoteMin * 60 * 1000));
        }
      }

      byId('btnCancelar').disabled = true;
      log(`üèÅ Conclu√≠do. Sucessos: ${ok}, Erros: ${err}.`);
    }

    function montarPayloadParaContato(contato){
      const components = [];

      // HEADER
      if(tmpl.headerType === 'TEXT'){
        if(tmpl.headerVars > 0){
          const vals = mapping.headerText.map(ci => contato.vars[ci] ?? '');
          components.push({
            type:'header',
            parameters: vals.map(v => ({ type:'text', text:String(v) }))
          });
        }
        // se HEADER TEXT n√£o tem {{vari√°veis}}, n√£o enviar par√¢metros
      }else if(['IMAGE','VIDEO','DOCUMENT'].includes(tmpl.headerType)){
        const mediaLink = byId('mediaLink').value.trim();
        if(mediaLink){
          const key = tmpl.headerType.toLowerCase(); // image | video | document
          const mediaObj = {}; mediaObj[key] = { link: mediaLink };
          components.push({ type:'header', parameters:[ { type:key, ...mediaObj } ] });
        }
      }

      // BODY
      if(tmpl.bodyVars > 0){
        const vals = mapping.body.map(ci => contato.vars[ci] ?? '');
        components.push({
          type:'body',
          parameters: vals.map(v => ({ type:'text', text:String(v) }))
        });
      }

      // BUTTONS (apenas URL com {{1}})
      if(tmpl.urlButtons.length > 0){
        tmpl.urlButtons.forEach(btn => {
          if(btn.hasVar){
            const mapArr = mapping.urlButtons[btn.index] || [];
            const v = String(contato.vars[mapArr[0] ?? 0] ?? '');
            components.push({ type:'button', sub_type:'url', index:String(btn.index), parameters:[{ type:'text', text:v }] });
          }
        });
      }

      return {
        messaging_product:'whatsapp',
        to: contato.to,
        type:'template',
        template:{
          name: tmpl.name,
          language:{ code:'pt_BR' },
          components,
        },
      };
    }

    // ---------------------------- Novo Envio ----------------------------
    byId('btnNovoEnvio').addEventListener('click', () => {
      contatos = [];
      csvHeaders = [];
      mapping = { body:[], headerText:[], urlButtons:{} };
      flags = { paused:false, cancelled:false };
      byId('output').textContent = 'Pronto para novo envio.';
      byId('okCount').textContent = '0';
      byId('errCount').textContent = '0';
      byId('progressBar').style.width = '0%';
      byId('progressTxt').textContent = '0/0';
      byId('contagemContatos').textContent = 'Nenhum contato ainda.';
      renderMapUI();
      calcularCusto();
      log('üîÑ Novo envio iniciado, mantenha suas credenciais preenchidas.');
    });

    // ---------------------------- Baixar Log ----------------------------
    byId('btnBaixarLog').addEventListener('click', () => {
      const blob = new Blob([byId('output').textContent], { type:'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `log-whatsapp-${Date.now()}.txt`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    });
  </script>
</body>
</html>
