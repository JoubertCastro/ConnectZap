<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Envio de Mensagens WhatsApp ‚Äî Vers√£o Restaurada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb;--card:#ffffff;--txt:#222;--muted:#6b7280;--primary:#2563eb;--primary-d:#1d4ed8;
      --success:#16a34a;--warn:#d97706;--danger:#dc2626;--outline:#e5e7eb;--radius:12px;
    }
    *{box-sizing:border-box}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      margin:0;padding:24px;background:var(--bg);color:var(--txt);
    }
    .container{max-width:1100px;margin:0 auto}
    .card{
      background:var(--card);border:1px solid var(--outline);padding:18px;border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.04);
    }
    h1{margin:0 0 10px;font-size:22px}
    h2{font-size:16px;margin:18px 0 8px;color:var(--muted);font-weight:600}
    label{display:block;font-weight:600;margin:10px 0 6px}

    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--outline);border-radius:8px;background:#fff;
    }
    textarea{resize:vertical;min-height:72px}

    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:start}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--outline);
      cursor:pointer;background:var(--primary);color:#fff;font-weight:600;
    }
    .btn:hover{background:var(--primary-d)}
    .btn.secondary{background:#fff;color:var(--txt)}
    .btn.secondary:hover{background:#f8fafc}
    .btn.success{background:var(--success)}
    .btn.warn{background:var(--warn)}
    .btn.danger{background:var(--danger)}

    #previewArea{
      background:#f1f5f9;border:1px dashed #cbd5e1;padding:12px;border-radius:10px;white-space:pre-wrap;
    }
    #output{
      background:#0b1220;color:#d1e6ff;padding:12px;border-radius:10px;min-height:140px;font-family:ui-monospace,monospace;
      white-space:pre-wrap;overflow-y:auto;
    }
    .muted{color:var(--muted);font-size:12px}

    .bar{background:#e5e7eb;border-radius:999px;height:12px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#22c55e);transition:width .3s ease}

    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:700;border:1px solid #c7d2fe;
    }
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .hide{display:none}
    details summary{cursor:pointer}
    .kbd{
      background:#e5e7eb;border:1px solid #cbd5e1;padding:1px 6px;border-radius:6px;font-family:ui-monospace,monospace;font-size:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Envio de Mensagens WhatsApp com Template <span class="pill">vers√£o 2025-08-28</span></h1>
      <div class="muted">
        Restaura a pr√©-visualiza√ß√£o com substitui√ß√£o de vari√°veis, mapeamento e custo; mant√©m os novos campos e o envio via backend.
      </div>

      <!-- Credenciais -->
      <h2>Credenciais</h2>
      <div class="row">
        <div class="col-6">
          <label for="token">Token de Acesso</label>
          <input id="token" placeholder="Cole seu token (opcional se usar backend)" />
        </div>
        <div class="col-6">
          <label for="contaSelect">Conta</label>
          <select id="contaSelect">
            <option value="">-- Selecione a conta --</option>
            <option value="connectzap">ConnectZap</option>
            <option value="recoverypj">Recovery PJ</option>
            <option value="recoverypf">Recovery PF</option>
            <option value="mpcobranca">Mercado Pago Cobran√ßa</option>
            <option value="divzero">DivZero</option>
            <option value="arc4u">Arc4U</option>
            <option value="serasa">Serasa</option>
            <option value="mpvendas">Mercado Pago Vendas</option>
          </select>

        </div>
        <div class="col-6">
          <label for="wabaId">WhatsApp Business ID</label>
          <input id="wabaId" readonly />
        </div>
        <div class="col-6">
          <label for="phoneId">Phone Number ID</label>
          <input id="phoneId" readonly />
        </div>
        <div class="col-6">
          <label for="graphVersion">Vers√£o Graph API</label>
          <select id="graphVersion">
            <option value="v23.0" selected>v23.0</option>
            <option value="v22.0">v22.0</option>
            <option value="v21.0">v21.0</option>
            <option value="v20.0">v20.0</option>
            <option value="v19.0">v19.0</option>
            <option value="v18.0">v18.0</option>
          </select>
        </div>
      </div>

      <!-- Buscar templates -->
      <div class="row" style="margin-top:12px;align-items:end">
        <div class="col-6">
          <button class="btn" id="btnBuscar">üîç Buscar templates aprovados</button>
        </div>
        <div class="col-6">
          <label for="templateSelect">Template</label>
          <select id="templateSelect">
            <option value="">-- Selecione um template --</option>
          </select>
        </div>
      </div>

      <!-- Campos do Template -->
      <div class="row" style="margin-top:6px;">
        <div class="col-6">
          <label for="templateName">Nome do Template</label>
          <input id="templateName" readonly />
        </div>
        <div class="col-3">
          <label for="templateCategory">Categoria</label>
          <select id="templateCategory">
            <option value="">-- Selecione --</option>
            <option value="authentication">Authentication</option>
            <option value="marketing">Marketing</option>
            <option value="utility">Utility</option>
            <option value="service">Service</option>
          </select>
        </div>
        <div class="col-3">
          <label for="headerFormat">Formato de Header</label>
          <input id="headerFormat" readonly />
        </div>
      </div>

      <!-- Configura√ß√µes do HEADER (aparece conforme o formato) -->
      <div class="row" id="headerParams" style="margin-top:6px;">
        <div class="col-12" id="headerTextWrap" class="hide">
          <div class="muted">
            Header <b>TEXT</b> com vari√°veis: fa√ßa o mapeamento em <b>Mapeamento de Vari√°veis</b> (abaixo).
          </div>
        </div>
        <div class="col-12 hide" id="mediaLinkWrap">
          <label for="mediaLink">Link da M√≠dia do Header (quando HEADER = IMAGE/VIDEO/DOCUMENT)</label>
          <input id="mediaLink" placeholder="https://... (acess√≠vel publicamente)" />
          <div class="muted">Se informado, ser√° enviado como header de m√≠dia do template.</div>
        </div>
      </div>

      <!-- Pr√©-visualiza√ß√£o -->
      <div class="row" style="margin-top:6px;">
        <div class="col-12">
          <h2>Pr√©-visualiza√ß√£o</h2>
          <div id="previewArea">Selecione um template para ver a pr√©via aqui.</div>
        </div>
      </div>

      <!-- Contatos + Estrat√©gia + Mapeamento -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Contatos</h2>
          <div class="grid-2">
            <div>
              <label for="fileInput">Arquivo (.csv ou .txt)</label>
              <input id="fileInput" type="file" accept=".csv,.txt" />
            </div>
            <div>
              <label for="estrategiaSelect">Estrat√©gia (exemplo interno)</label>
              <select id="estrategiaSelect">
                <option value="">-- Nenhuma --</option>
                <option value="estrategia1">estrategia1</option>
                <option value="estrategia2">estrategia2</option>
              </select>
            </div>
          </div>
          <div id="contagemContatos" class="muted" style="margin-top:6px;">Nenhum contato ainda.</div>
        </div>
        <div class="col-6">
          <h2>Mapeamento de Vari√°veis</h2>
          <div id="mapArea" class="muted">Carregue contatos e selecione um template.</div>
        </div>
      </div>

      <!-- Custos -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Custo Estimado</h2>
          <div id="custoEstimado">üíµ Custo estimado: ‚Äî</div>
          <div id="custoReal">üí≥ Valor em Reais (com taxa): ‚Äî</div>
        </div>
        <div class="col-6">
          <label for="taxaConversaoExtra">Acr√©scimo (%)</label>
          <input id="taxaConversaoExtra" type="number" min="0" step="0.01" value="6" />
        </div>
      </div>

      <!-- Agendamento e Ritmo de Envio -->
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <h2>Modo de Envio</h2>
          <div class="grid-2">
            <div>
              <label for="modoEnvio">Modo</label>
              <select id="modoEnvio">
                <option value="imediato" selected>Imediato</option>
                <option value="agendar">Agendar</option>
              </select>
            </div>
            <div id="dataHoraWrap" class="hide">
              <label for="dataHoraEnvio">Data/Hora (agendamento)</label>
              <input id="dataHoraEnvio" type="datetime-local" />
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">Para agendar, mantenha a aba aberta at√© o envio ocorrer (se usando envio local). Para backend, o agendamento √© processado pelo servidor.</div>
        </div>
        <div class="col-6">
          <h2>Ritmo / Lotes</h2>
          <div class="grid-3">
            <div>
              <label for="tamanhoLote">Tamanho do Lote</label>
              <input id="tamanhoLote" type="number" min="1" placeholder="ex.: 50" />
            </div>
            <div>
              <label for="intervaloLote">Intervalo entre Lotes (min)</label>
              <input id="intervaloLote" type="number" min="0" value="0" />
            </div>
            <div>
              <label for="intervaloMsg">Intervalo entre Mensagens (s)</label>
              <input id="intervaloMsg" type="number" min="0" value="0" />
            </div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <div class="col-6">
          <label for="nomeDisparo">Nome do Disparo</label>
          <input id="nomeDisparo" placeholder="Campanha Agosto - Segmento X" required />
        </div>
        <div class="col-6">
          <label for="grupoTrabalho">Grupo de Trabalho</label>
          <input id="grupoTrabalho" placeholder="Equipe Comercial" required />
        </div>
      </div>

      <!-- Envio -->
      <div class="row" style="margin-top:16px;align-items:center;">
        <div class="col-8">
          <button class="btn success" id="btnEnviar">üöÄ Enviar</button>
          <button class="btn secondary" id="btnPausar">‚è∏Ô∏è Pausar</button>
          <button class="btn secondary" id="btnRetomar" disabled>‚ñ∂Ô∏è Retomar</button>
          <button class="btn danger" id="btnCancelar" disabled>üõë Cancelar</button>
          <button class="btn warn" id="btnNovoEnvio">üîÑ Novo Envio</button>
        </div>
        <div class="col-4" style="text-align:right">
          <div class="bar"><span id="progressBar"></span></div>
          <div class="muted" id="progressTxt">0/0</div>
        </div>
      </div>

      <!-- Logs -->
      <div class="row" style="margin-top:12px;">
        <div class="col-12">
          <h2>Logs</h2>
        </div>
        <div class="col-12">
          <div id="output">Pronto para enviar.</div>
          <div class="grid-3" style="margin-top:8px;">
            <div>‚úÖ Sucesso: <b id="okCount">0</b></div>
            <div>‚ùå Erros: <b id="errCount">0</b></div>
            <div><button class="btn secondary" id="btnBaixarLog">‚¨áÔ∏è Baixar log</button></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---------------------------- Estado ----------------------------
    const estrategias = {
      estrategia1: [
        { to: "5561993742606", vars: ["Joubert", "6/6", "250.23", "13.08.2025", "00191117200000369860000001559984036163546617", "000201010212..."] },
        { to: "5592991029242", vars: ["Savio", "1/1", "120.00", "25.09.2025", "237933812...", "000201010212..."] },
        { to: "5561996777300", vars: ["Ayrton", "2/3", "89.90", "01.10.2025", "03399111...", "000201010212..."] },
      ],
      estrategia2: [
        { to: "5561993742601", vars: ["Joubert", "6/6", "250.23", "13.08.2025", "0019...", "000201..."] },
        { to: "5561993742602", vars: ["JoubertC", "6/6", "250.23", "13.08.2025", "0019...", "000201..."] },
      ],
    };

    let contatos = [];              // [{ to: '55...', vars: ['v1','v2', ...] }]
    let csvHeaders = [];            // ['telefone','nome','codigo', ...]
    let custoEmDolar = 0;           // custo estimado
    let mapping = {                 // qual coluna alimenta cada {{n}}
      body: [],                     // array de √≠ndices (0-based) para {{1}}, {{2}} ...
      headerText: [],               // idem, para HEADER TEXT
      urlButtons: {},               // { index: 0 => [colIdxFor{{1}}] }
    };
    let tmpl = {                    // metadados do template selecionado
      name: "",
      category: "",
      components: [],
      bodyText: "",
      bodyVars: 0,
      headerType: null,             // null | TEXT | IMAGE | VIDEO | DOCUMENT
      headerText: "",
      headerVars: 0,
      urlButtons: [],               // lista de {index, url, hasVar}
    };

    let flags = { paused: false, cancelled: false };

    // ---------------------------- Utils ----------------------------
    const $ = (sel) => document.querySelector(sel);
    const byId = (id) => document.getElementById(id);

    function log(line){
      const out = byId('output');
      out.textContent += (out.textContent ? "\n" : "") + line;
      out.scrollTop = out.scrollHeight;
    }

    function setProgress(done, total){
      const pct = total > 0 ? (done / total) * 100 : 0;
      byId('progressBar').style.width = pct.toFixed(1) + '%';
      byId('progressTxt').textContent = `${done}/${total}`;
    }

    function countPlaceholders(text){
      if(!text) return 0;
      const matches = text.match(/\{\{\d+\}\}/g);
      return matches ? new Set(matches).size : 0;
    }

    function substitutePlaceholders(text, values){
      // values: array where index 0 is {{1}}, index 1 is {{2}}, ...
      if(!text) return '';
      return text.replace(/\{\{(\d+)\}\}/g, (_, n) => {
        const idx = parseInt(n,10) - 1;
        return values[idx] != null ? String(values[idx]) : `{{${n}}}`;
      });
    }

    function parseCSV(text){
      // CSV simples com , ou ; e aspas
      const delim = text.includes(';') && !text.includes(',') ? ';' : ',';
      const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l => l.trim().length>0);
      const rows = [];
      for(const line of lines){
        const row = [];
        let cur = '', inQ = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch === '"'){
            if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
            else { inQ = !inQ; }
          }else if(ch === delim && !inQ){
            row.push(cur); cur='';
          }else{
            cur += ch;
          }
        }
        row.push(cur);
        rows.push(row.map(c => c.trim()));
      }
      return rows;
    }

    function ensureNumber(v, fallback=0){
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // ---------------------------- UI Helpers ----------------------------
    function renderSelect(id, varIndex, current){
      let opts = '';
      if(csvHeaders.length>0){
        csvHeaders.forEach((h, idx) => {
          const sel = idx === current ? 'selected' : '';
          opts += `<option value="${idx}" ${sel}>${idx+1} ‚Äî ${escapeHtml(h)}</option>`;
        });
      }else{
        // fallback pelo n¬∫ de colunas detectado
        const maxCols = Math.max(1, ...(contatos.map(c => c.vars.length)));
        for(let idx=0; idx<maxCols; idx++){
          const sel = idx === current ? 'selected' : '';
          opts += `<option value="${idx}" ${sel}>${idx+1}</option>`;
        }
      }
      return `<label for="${id}">{{${varIndex+1}}} ‚ü∂ coluna</label><select id="${id}">${opts}</select>`;
    }

    function renderMapUI(){
      const area = byId('mapArea');
      const hasTemplate = !!tmpl.name;
      const hasContacts = contatos.length > 0;

      if(!hasTemplate || !hasContacts){
        area.innerHTML = '<span class="muted">Carregue contatos e selecione um template para configurar o mapeamento.</span>';
        updatePreview();
        return;
      }

      const headerPart = (() => {
        if(!tmpl.headerType) return '';
        if(tmpl.headerType === 'TEXT' && tmpl.headerVars > 0){
          let selects = '';
          for(let i=0;i<tmpl.headerVars;i++){
            selects += renderSelect(`map-header-${i}`, i, mapping.headerText[i]);
          }
          return `<h3>Header TEXT ‚Äî vari√°veis</h3>${selects}`;
        }
        if(['IMAGE','VIDEO','DOCUMENT'].includes(tmpl.headerType)){
          return '<div class="muted">Header de m√≠dia usa a URL informada em "Link da M√≠dia do Header".</div>';
        }
        return '';
      })();

      let bodySelects = '';
      if(tmpl.bodyVars > 0){
        bodySelects += '<h3>Body ‚Äî vari√°veis</h3>';
        for(let i=0;i<tmpl.bodyVars;i++){
          bodySelects += renderSelect(`map-body-${i}`, i, mapping.body[i]);
        }
      }else{
        bodySelects += '<div class="muted">Body sem vari√°veis.</div>';
      }

      let buttonsPart = '';
      if(tmpl.urlButtons.length > 0){
        buttonsPart += '<h3>Bot√µes URL ‚Äî vari√°veis</h3>';
        tmpl.urlButtons.forEach(btn => {
          if(btn.hasVar){
            buttonsPart += `<div style="margin:6px 0 10px"><b>Bot√£o #${btn.index+1}</b> ‚Äî URL base: <span class="kbd">${btn.url}</span><br/>` +
              renderSelect(`map-urlbtn-${btn.index}-0`, 0, mapping.urlButtons[btn.index]?.[0]) + '</div>';
          }
        });
      }

      const sample = contatos[0] || { to:'', vars:[] };
      const bodyPreviewVals = (mapping.body || []).map(ci => ci != null ? sample.vars[ci] : '');
      const bodyPrev = substitutePlaceholders(tmpl.bodyText, bodyPreviewVals);

      area.innerHTML = `
        ${headerPart}
        ${bodySelects}
        ${buttonsPart}
        <div style="margin-top:10px">
          <div class="muted">Pr√©via com o <b>primeiro contato</b>:</div>
          <div class="card" style="padding:10px;border:1px dashed #cbd5e1;">
            ${bodyPrev.replace(/\n/g,'<br/>')}
          </div>
        </div>
      `;

      // listeners dos selects
      if(tmpl.headerType === 'TEXT'){
        for(let i=0;i<tmpl.headerVars;i++){
          byId(`map-header-${i}`)?.addEventListener('change', (e) => {
            mapping.headerText[i] = ensureNumber(e.target.value, 0);
            updatePreview();
          });
        }
      }
      for(let i=0;i<tmpl.bodyVars;i++){
        byId(`map-body-${i}`)?.addEventListener('change', (e) => {
          mapping.body[i] = ensureNumber(e.target.value, 0);
          renderMapUI(); // refresh preview + UI
          updatePreview();
        });
      }
      tmpl.urlButtons.forEach(btn => {
        if(btn.hasVar){
          byId(`map-urlbtn-${btn.index}-0`)?.addEventListener('change', (e) => {
            mapping.urlButtons[btn.index] = [ensureNumber(e.target.value, 0)];
          });
        }
      });

      updatePreview();
    }

    // ---------------------------- Custos ----------------------------
    async function calcularCusto(){
      const categoria = byId('templateCategory').value;
      const qtd = contatos.length;
      if(!categoria || !qtd){
        byId('custoEstimado').textContent = 'üíµ Custo estimado: ‚Äî';
        byId('custoReal').textContent = 'üí≥ Valor em Reais (com taxa): ‚Äî';
        return;
      }
      // valores aproximados ‚Äî ajuste conforme sua tabela vigente
      const price = (categoria === 'authentication' || categoria === 'utility') ? 0.0068 : (categoria === 'marketing' ? 0.0625 : 0);
      custoEmDolar = qtd * price;
      byId('custoEstimado').textContent = `üíµ Custo estimado: $${custoEmDolar.toFixed(4)}`;

      try{
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await res.json();
        const brl = data?.rates?.BRL ?? 5.0; // fallback
        const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
        const final = custoEmDolar * brl * taxa;
        byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa): R$${final.toFixed(2)}`;
      }catch(e){
        const brl = 5.0; // fallback
        const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
        const final = custoEmDolar * brl * taxa;
        byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa ‚Äì c√¢mbio offline): R$${final.toFixed(2)}`;
      }
    }

    // ---------------------------- Pr√©-visualiza√ß√£o (restaurada) ----------------------------
    function updatePreview(){
      if(!tmpl.name){ byId('previewArea').textContent = '‚Äî'; return; }

      // 1) Se o template tem exemplos no BODY, usar;
      // 2) Caso contr√°rio, se houver contatos + mapping, usar o primeiro contato;
      // 3) Sen√£o, mostrar o body cru.
      const body = tmpl.bodyText || '';
      let values = [];

      // tenta exemplos do template
      const compBody = (tmpl.components || []).find(c => c.type === 'BODY');
      const exemploBody = compBody?.example?.body_text?.[0];
      if(Array.isArray(exemploBody) && exemploBody.length){
        values = exemploBody;
      }else if(contatos.length && tmpl.bodyVars > 0){
        // fallback: primeiro contato
        const sample = contatos[0];
        values = (mapping.body || []).map(ci => sample.vars[ci] ?? '');
      }

      const bodyPreview = values.length ? substitutePlaceholders(body, values) : body;

      // Header TEXT opcional
      let headerPreview = '';
      if(tmpl.headerType === 'TEXT'){
        const headerVals = [];
        if(tmpl.headerVars > 0 && contatos.length){
          const s = contatos[0];
          for(let i=0;i<tmpl.headerVars;i++) headerVals.push(s.vars[mapping.headerText[i] ?? i] ?? '');
        }
        headerPreview = substitutePlaceholders(tmpl.headerText || '', headerVals);
      }

      const parts = [];
      parts.push('üìÑ Pr√©-visualiza√ß√£o:');
      if(headerPreview){ parts.push(`*${headerPreview}*\n`); }
      parts.push(bodyPreview);

      // Bot√µes URL com vari√°vel ‚Äî exibe como anota√ß√£o
      if(tmpl.urlButtons?.length){
        const btns = tmpl.urlButtons.map((b, i) => {
          if(!b.hasVar) return `‚Ä¢ Bot√£o ${i+1}: URL fixa`;
          const colIdx = mapping.urlButtons[i]?.[0];
          const sampleVal = (contatos[0]?.vars || [])[colIdx ?? 0] ?? '{{1}}';
          const final = (b.url || '').replace(/\{\{1\}\}/g, sampleVal);
          return `‚Ä¢ Bot√£o ${i+1}: ${final}`;
        }).join('\n');
        if(btns) parts.push('\n[BOT√ïES]\n' + btns);
      }

      byId('previewArea').textContent = parts.join('\n\n');
    }

    // ---------------------------- Templates ----------------------------
    byId('btnBuscar').addEventListener('click', buscarTemplates);
    async function buscarTemplates(){
      const token = byId('token').value.trim();
      const wabaId = byId('wabaId').value.trim();
      const ver = byId('graphVersion').value;
      if(!token || !wabaId){ alert('Informe token e WABA ID.'); return; }

      const select = byId('templateSelect');
      select.innerHTML = '<option value="">Carregando...</option>';

      const urlBase = `https://graph.facebook.com/${ver}/${encodeURIComponent(wabaId)}/message_templates?limit=100&status=APPROVED`;
      const all = [];
      let next = urlBase;
      try{
        while(next){
          const r = await fetch(next, { headers:{ Authorization:`Bearer ${token}` }});
          const j = await r.json();
          if(Array.isArray(j.data)) all.push(...j.data);
          next = j?.paging?.next || null;
        }
      }catch(e){
        alert('Erro ao buscar templates: ' + e.message);
        select.innerHTML = '<option value="">-- Erro ao buscar --</option>';
        return;
      }

      if(all.length === 0){
        select.innerHTML = '<option value="">-- Nenhum template aprovado encontrado --</option>';
        return;
      }

      select.innerHTML = '<option value="">-- Selecione um template --</option>';
      all.sort((a,b) => a.name.localeCompare(b.name)).forEach(t => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(t);
        opt.textContent = `${t.name} ¬∑ ${t.category}`;
        select.appendChild(opt);
      });
    }

    byId('templateSelect').addEventListener('change', preencherTemplateInfo);
    function preencherTemplateInfo(){
      const val = byId('templateSelect').value;
      if(!val) return;
      const t = JSON.parse(val);

      tmpl.name = t.name;
      tmpl.category = t.category || '';
      tmpl.components = t.components || [];
      byId('templateName').value = tmpl.name;
      byId('templateCategory').value = tmpl.category || '';

      const header = tmpl.components.find(c => c.type === 'HEADER');
      const body = tmpl.components.find(c => c.type === 'BODY');
      const buttons = tmpl.components.find(c => c.type === 'BUTTONS');

      // Reset UI header
      tmpl.headerType = null;
      tmpl.headerText = '';
      tmpl.headerVars = 0;
      byId('headerFormat').value = '';
      byId('headerTextWrap').classList.add('hide');
      byId('mediaLinkWrap').classList.add('hide');

      // Header
      if(header){
        const fmt = header.format; // TEXT | IMAGE | VIDEO | DOCUMENT
        tmpl.headerType = fmt;
        byId('headerFormat').value = fmt || '';
        if(fmt === 'TEXT'){
          tmpl.headerText = header.text || '';
          tmpl.headerVars = countPlaceholders(tmpl.headerText);
          byId('headerTextWrap').classList.remove('hide');
        }else if(['IMAGE','VIDEO','DOCUMENT'].includes(fmt)){
          byId('mediaLinkWrap').classList.remove('hide');
        }
      }

      // Body
      tmpl.bodyText = body?.text || '';
      tmpl.bodyVars = countPlaceholders(tmpl.bodyText);

      // Buttons (apenas URL com {{1}})
      tmpl.urlButtons = [];
      if(buttons && Array.isArray(buttons.buttons)){
        buttons.buttons.forEach((b, idx) => {
          if(b.type === 'URL'){
            const hasVar = (b.url || '').includes('{{');
            tmpl.urlButtons.push({ index: idx, url: b.url || '', hasVar });
          }
        });
      }

      // Mapeamento padr√£o
      mapping.body = Array.from({length: tmpl.bodyVars}, (_,i)=> i);
      mapping.headerText = Array.from({length: tmpl.headerVars}, (_,i)=> i);
      mapping.urlButtons = {};

      renderMapUI();
      calcularCusto();
      updatePreview();
    }

    // ---------------------------- Contatos ----------------------------
    byId('estrategiaSelect').addEventListener('change', function(){
      const selected = this.value;
      if(estrategias[selected]){
        contatos = JSON.parse(JSON.stringify(estrategias[selected]));
        csvHeaders = [];
        byId('contagemContatos').textContent = `‚úîÔ∏è Estrat√©gia "${selected}" carregada com ${contatos.length} contato(s).`;
        renderMapUI();
        calcularCusto();
      }
    });

    byId('fileInput').addEventListener('change', function(){
      const file = this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const rows = parseCSV(e.target.result);
        if(rows.length === 0) return;

        // Detecta cabe√ßalho
        const head = rows[0].map(c => (c||'').toLowerCase());
        const hasHeader = head.some(c => c.includes('telefone') || c === 'to' || c.includes('phone'));

        const dataRows = hasHeader ? rows.slice(1) : rows;
        csvHeaders = hasHeader ? rows[0] : (dataRows[0]?.map((_,i)=>`coluna_${i+1}`) || []);

        contatos = dataRows.map(r => ({
          to: (r[0] || '').replace(/\D+/g,''),
          vars: r.slice(1),
        })).filter(c => c.to);

        byId('contagemContatos').textContent = `‚úîÔ∏è Arquivo carregado com ${contatos.length} contato(s).`;
        renderMapUI();
        calcularCusto();
      };
      reader.readAsText(file);
    });

    byId('taxaConversaoExtra').addEventListener('change', calcularCusto);
    byId('templateCategory').addEventListener('change', calcularCusto);

    // ---------------------------- Agendamento UI ----------------------------
    byId('modoEnvio').addEventListener('change', () => {
      const isAgendar = byId('modoEnvio').value === 'agendar';
      byId('dataHoraWrap').classList.toggle('hide', !isAgendar);
    });

    // ---------------------------- Envio via BACKEND (novo) ----------------------------
    async function onEnviarClick(){
      if(contatos.length === 0){ 
        alert('Nenhum contato carregado.'); 
        return; 
      }

      const payload = {
        token: byId("token").value.trim(),
        phone_id: byId("phoneId").value.trim(),
        waba_id: byId("wabaId").value.trim(),
        nome_disparo: byId("nomeDisparo").value.trim(),
        grupo_trabalho: byId("grupoTrabalho").value.trim(),
        modo_envio: byId("modoEnvio").value,
        data_hora_agendamento: byId("dataHoraEnvio").value || null,
        intervalo_msg: Number(byId("intervaloMsg").value || 0),
        tamanho_lote: Number(byId("tamanhoLote").value || 0),
        intervalo_lote: Number(byId("intervaloLote").value || 0),
        template: {
          name: tmpl.name,
          language: "pt_BR",
          headerType: tmpl.headerType,
          bodyText: tmpl.bodyText,
          bodyVars: tmpl.bodyVars,
          headerVars: tmpl.headerVars,
          urlButtons: tmpl.urlButtons,
          mapping: mapping,
          mediaLink: byId("mediaLink").value.trim()
        },
        contatos: contatos.map(c => ({
          telefone: c.to,
          conteudo: c.vars.join(",")   // simples para o worker processar
        }))
      };

      try {
        const res = await fetch("https://whatsapp-webhook-production-9a27.up.railway.app/api/envios", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.ok){
          log(`‚úîÔ∏è Disparo "${payload.nome_disparo}" cadastrado com sucesso (ID ${data.id}).`);
        }else{
          log("‚ùå Erro ao salvar disparo: " + (data.erro || JSON.stringify(data)));
        }
      } catch(e) {
        log("‚ùå Falha de rede ao salvar disparo: " + e.message);
      }
    }

    document.getElementById("btnEnviar").addEventListener("click", onEnviarClick);

    // Bot√µes de pausa/retomar/cancelar ‚Äî apenas UI (backend controla o envio)
    byId('btnPausar').addEventListener('click', () => {
      flags.paused = true; byId('btnRetomar').disabled = false; log('‚è∏Ô∏è Pausa solicitada (se aplic√°vel ao backend).');
    });
    byId('btnRetomar').addEventListener('click', () => {
      flags.paused = false; byId('btnRetomar').disabled = true; log('‚ñ∂Ô∏è Retomar solicitado (se aplic√°vel ao backend).');
    });
    byId('btnCancelar').addEventListener('click', () => {
      flags.cancelled = true; log('üõë Cancelamento solicitado (se aplic√°vel ao backend).');
    });

    // ---------------------------- Novo Envio ----------------------------
    byId('btnNovoEnvio').addEventListener('click', () => {
      contatos = [];
      csvHeaders = [];
      mapping = { body:[], headerText:[], urlButtons:{} };
      flags = { paused:false, cancelled:false };
      byId('output').textContent = 'Pronto para novo envio.';
      byId('okCount').textContent = '0';
      byId('errCount').textContent = '0';
      byId('progressBar').style.width = '0%';
      byId('progressTxt').textContent = '0/0';
      byId('contagemContatos').textContent = 'Nenhum contato ainda.';
      renderMapUI();
      calcularCusto();
      log('üîÑ Novo envio iniciado, mantenha suas credenciais preenchidas se for buscar templates.');
    });
    // --- Preencher IDs ao selecionar conta ---
    const contas = {
      connectzap:   { phone: "732661079928516", waba: "1910445533050310" },
      recoverypj:   { phone: "727586317113885", waba: "844006574616797" },
      recoverypf:   { phone: "802977069563598", waba: "825347669829173" },
      mpcobranca:   { phone: "821562937700669", waba: "1989071868573988" },
      divzero:      { phone: "779797401888141", waba: "1714740535849713" },
      arc4u:        { phone: "829210283602406", waba: "757728786687884" },
      serasa:       { phone: "713021321904495", waba: "803987045361450" },
      mpvendas:     { phone: "803535039503723", waba: "760293050103603" }
    };

    document.getElementById("contaSelect").addEventListener("change", function() {
      const conta = contas[this.value];
      if (conta) {
        document.getElementById("phoneId").value = conta.phone;
        document.getElementById("wabaId").value = conta.waba;
      } else {
        document.getElementById("phoneId").value = "";
        document.getElementById("wabaId").value = "";
      }
    });
    
    // ---------------------------- Baixar Log ----------------------------
    byId('btnBaixarLog').addEventListener('click', () => {
      const blob = new Blob([byId('output').textContent], { type:'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `log-whatsapp-${Date.now()}.txt`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    });
  </script>
</body>
</html>