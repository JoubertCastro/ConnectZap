<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>Envio de Mensagens WhatsApp ‚Äî ConnectZap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --txt: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-d: #1d4ed8;
      --success: #16a34a;
      --warn: #d97706;
      --danger: #dc2626;
      --outline: #e5e7eb;
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top left, #e0ebff 0, #f5f7fb 45%, #eef2ff 100%);
      color: var(--txt);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--outline);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: 0 6px 24px rgba(15, 23, 42, .06);
    }

    /* Evita "card dentro de card" muito fundo nas abas */
    .card .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    .card .card {
      border: none;
      box-shadow: none;
      padding: 0;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h2 {
      font-size: 15px;
      margin: 20px 0 10px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    label {
      display: block;
      font-weight: 600;
      margin: 8px 0 6px;
      font-size: 13px;
      color: #111827;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--outline);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      color: var(--txt);
      transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
      font-size: 13px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background-color: #f9fafb;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%),
        linear-gradient(to right, #e5e7eb, #e5e7eb);
      background-position:
        calc(100% - 16px) calc(50% - 2px),
        calc(100% - 11px) calc(50% - 2px),
        calc(100% - 32px) 50%;
      background-size:
        6px 6px,
        6px 6px,
        1px 22px;
      background-repeat: no-repeat;
      padding-right: 36px;
    }

    textarea {
      resize: vertical;
      min-height: 72px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      align-items: flex-start;
    }

    .row + .row {
      margin-top: 10px;
    }

    .col-3 {
      grid-column: span 3;
    }

    .col-4 {
      grid-column: span 4;
    }

    .col-5 {
      grid-column: span 5;
    }

    .col-6 {
      grid-column: span 6;
    }

    .col-8 {
      grid-column: span 8;
    }

    .col-12 {
      grid-column: span 12;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--outline);
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      transition: background-color .15s ease, transform .05s ease, box-shadow .15s ease, border-color .15s ease;
    }

    .btn:hover {
      background: var(--primary-d);
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
      border-color: rgba(37, 99, 235, 0.5);
    }

    .btn:disabled {
      opacity: .6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn.secondary {
      background: #fff;
      color: #111827;
    }

    .btn.secondary:hover {
      background: #f8fafc;
      border-color: #d1d5db;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.06);
    }

    .btn.success {
      background: var(--success);
      border-color: #16a34a;
    }

    .btn.success:hover {
      background: #15803d;
      border-color: #15803d;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
    }

    .btn.warn {
      background: var(--warn);
      border-color: #d97706;
    }

    .btn.danger {
      background: var(--danger);
      border-color: #dc2626;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .btn-row .btn {
      margin-top: 4px;
    }

    #previewArea,
    #previewArea_ind {
      background: #f1f5f9;
      border: 1px dashed #cbd5e1;
      padding: 12px;
      border-radius: 10px;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.4;
    }

    #output,
    #output_ind {
      background: #020617;
      color: #d1e6ff;
      padding: 12px;
      border-radius: 10px;
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      overflow-y: auto;
      font-size: 12px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .bar {
      background: #e5e7eb;
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }

    .bar>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), #22c55e);
      transition: width .3s ease;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid #c7d2fe;
      text-transform: uppercase;
      letter-spacing: .06em;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .hide {
      display: none !important;
    }

    details summary {
      cursor: pointer;
    }

    .kbd {
      background: #e5e7eb;
      border: 1px solid #cbd5e1;
      padding: 1px 6px;
      border-radius: 6px;
      font-family: ui-monospace, monospace;
      font-size: 12px;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(2px);
    }

    .modal.open {
      display: flex;
    }

    .modal .card {
      max-height: 90vh;
      overflow: auto;
    }

    .tabs {
      display: inline-flex;
      gap: 8px;
      margin: 12px 0 4px;
      padding: 4px;
      background: #eef2ff;
      border-radius: 999px;
    }

    .tab-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color .15s ease, color .15s ease, border-color .15s ease, transform .05s ease;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #111827;
      border-color: #c7d2fe;
      box-shadow: 0 2px 6px rgba(129, 140, 248, 0.25);
      transform: translateY(-0.5px);
    }

    .tab-content {
      display: none;
      margin-top: 14px;
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 13px;
      vertical-align: middle;
    }

    th {
      background: #f1f5f9;
      text-transform: uppercase;
      font-size: 11px;
      color: #64748b;
      letter-spacing: .04em;
    }

    table button {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 13px;
    }

    table button:hover {
      background: #e5e7eb;
    }

    /* Responsivo */
    @media (max-width: 900px) {
      body {
        padding: 16px;
      }

      .row {
        grid-template-columns: repeat(6, 1fr);
      }

      .col-6,
      .col-8,
      .col-5,
      .col-4,
      .col-3 {
        grid-column: span 6;
      }

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }

      .btn-row {
        justify-content: flex-start;
      }
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 18px;
        flex-wrap: wrap;
      }

      .tabs {
        width: 100%;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .tab-btn {
        flex: 1 1 auto;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>Envio de Mensagens WhatsApp <span class="pill">ConnectZap</span></h1>
      <div class="tabs">
        <button class="tab-btn active" data-tab="novo">‚ûï Novo envio</button>
        <button class="tab-btn" data-tab="individual">üë§ Envio individual</button>
        <button class="tab-btn" data-tab="agendamentos">üìÖ Agendamentos</button>
      </div>

      <!-- Aba: Novo envio -->
      <div id="tab-novo" class="tab-content active">
        <div class="container">
          <div class="card">
            <h1>Envio de Mensagens WhatsApp com Template <span class="pill">vers√£o 2025-11-07</span></h1>
            <div class="muted">
              Pr√©via com vari√°veis, mapeamento, custos e envio via backend.
            </div>

            <!-- Credenciais -->
            <h2>Credenciais</h2>
            <div class="row">
              <div class="col-6">
                <label for="token">Token de Acesso</label>
                <input id="token" placeholder="Cole seu token" />
              </div>
              <div class="col-6">
                <label for="contaSelect">Conta</label>
                <select id="contaSelect">
                  <option value="">-- Selecione a conta --</option>
                  <option value="connectzap">ConnectZap</option>
                  <option value="bancopan">Banco PAN</option>
                  <option value="recoverypj">Recovery PJ</option>
                  <option value="recoverypf">Recovery PF</option>
                  <option value="recoverypf_prev">Recovery Preventivo</option>
                  <option value="recoverypf_man">Recovery Manuten√ß√£o</option>
                  <option value="mpcobranca">Mercado Pago Cobran√ßa</option>
                  <option value="divzero">DivZero</option>
                  <option value="arc4u">Arc4U</option>
                  <option value="arc4u_veiculos">Arc4U Veiculos</option>
                  <option value="serasa">Serasa</option>
                  <option value="mpvendas">Mercado Pago Vendas</option>
                </select>
              </div>
              <div class="col-6">
                <label for="wabaId">WhatsApp Business ID</label>
                <input id="wabaId" readonly />
              </div>
              <div class="col-6">
                <label for="phoneId">Phone Number ID</label>
                <input id="phoneId" readonly />
              </div>
              <div class="col-6">
                <label for="graphVersion">Vers√£o Graph API</label>
                <select id="graphVersion">
                  <option value="v24.0" selected>v24.0</option>
                  <option value="v23.0">v23.0</option>
                  <option value="v22.0">v22.0</option>
                </select>
              </div>
            </div>

            <!-- Buscar templates -->
            <div class="row" style="margin-top:12px;align-items:center">
              <div class="col-6">
                <button class="btn" id="btnBuscar">üîç Buscar templates aprovados</button>
              </div>
              <div class="col-6">
                <label for="templateSelect">Template</label>
                <select id="templateSelect">
                  <option value="">-- Selecione um template --</option>
                </select>
              </div>
            </div>

            <!-- Campos do Template -->
            <div class="row" style="margin-top:6px;">
              <div class="col-6">
                <label for="templateName">Nome do Template</label>
                <input id="templateName" readonly />
              </div>
              <div class="col-3">
                <label for="templateCategory">Categoria</label>
                <select id="templateCategory">
                  <option value="">-- Selecione --</option>
                  <option value="authentication">Authentication</option>
                  <option value="marketing">Marketing</option>
                  <option value="utility">Utility</option>
                  <option value="service">Service</option>
                </select>
              </div>
              <div class="col-3">
                <label for="headerFormat">Formato de Header</label>
                <input id="headerFormat" readonly />
              </div>
            </div>

            <!-- Configura√ß√µes do HEADER -->
            <div class="row" id="headerParams" style="margin-top:6px;">
              <div id="headerTextWrap" class="col-12 hide">
                <div class="muted">
                  Header <b>TEXT</b> com vari√°veis: mapeie na se√ß√£o <b>Mapeamento de Vari√°veis</b>.
                </div>
              </div>
              <div class="col-12 hide" id="mediaLinkWrap">
                <label for="mediaLink">Link da M√≠dia do Header (IMAGE/VIDEO/DOCUMENT)</label>
                <input id="mediaLink" placeholder="https://... (acess√≠vel publicamente)" />
                <div class="muted">Se informado, ser√° enviado como header de m√≠dia do template.</div>
              </div>
            </div>

            <!-- Pr√©-visualiza√ß√£o -->
            <div class="row" style="margin-top:6px;">
              <div class="col-12">
                <h2>Pr√©-visualiza√ß√£o</h2>
                <div id="previewArea">Selecione um template para ver a pr√©via aqui.</div>
              </div>
            </div>

            <!-- Contatos + Estrat√©gia + Mapeamento -->
            <div class="row" style="margin-top:12px;">
              <div class="col-6">
                <h2>Contatos</h2>
                <div class="grid-2">
                  <div>
                    <label for="fileInput">Arquivo (.csv ou .txt)</label>
                    <input id="fileInput" type="file" accept=".csv,.txt" />
                  </div>
                  <div>
                    <label for="estrategiaSelect">Estrat√©gia pr√© cadastrada</label>
                    <select id="estrategiaSelect">
                      <option value="">-- Nenhuma --</option>
                      <optgroup label="Consulta no SIC">
                        <option value="arc4u_veiculos">Arc4U Veiculos</option>
                        <option value="arc4u_G1">Arc4U G1‚Äî Venc hoje</option>
                        <option value="arc4u_G2">Arc4U G2‚Äî Venc hoje</option>
                        <option value="arc4u_M">Arc4U M‚Äî Venc hoje</option>
                        <option value="arc4u_A1">Arc4U A1‚Äî Venc hoje</option>
                        <option value="arc4u_C1">Arc4U C1‚Äî Venc hoje</option>
                        <option value="atraso_new_Arc4u">Arc4U Atraso New</option>
                        <option value="atraso_old_Arc4u">Arc4U Atraso Old</option>
                        <option value="antecipa_old_Arc4u">Arc4U Antecipa Old</option>
                        <option value="arc4u">Arc4U Outros‚Äî Venc hoje</option>
                        <option value="divzero_hoje">DivZero ‚Äî Realizado hoje</option>
                        <option value="divzero_eavm">DivZero EAVM ‚Äî Venc hoje</option>
                        <option value="divzero_p1">DivZero P1 ‚Äî Venc hoje</option>
                        <option value="divzero_p2">DivZero P2 ‚Äî Venc hoje</option>
                        <option value="divzero_lp">DivZero LP ‚Äî Venc hoje</option>
                        <option value="divzero_atraso">DivZero ‚Äî Atraso</option>
                        <option value="divzero_oficio">DivZero ‚Äî Oficio</option>
                        <option value="divzero_serasa">DivZero ‚Äî Serasa</option>
                        <option value="entrada_divzero_p1">DivZero ‚Äî Entradas P1</option>
                        <option value="entrada_divzero_p2">DivZero ‚Äî Entradas P2</option>
                        <option value="entrada_divzero_lp">DivZero ‚Äî Entradas LP</option>
                        <option value="entrada_divzero_eavm">DivZero ‚Äî Entradas EAVM</option>
                        <option value="serasa">Serasa ‚Äî Venc hoje</option>
                        <option value="serasa_atraso">Serasa ‚Äî Atraso</option>
                        <option value="mercado_pago_2">Mercado Pago(2) ‚Äî Venc hoje</option>
                        <option value="mercado_pago_4">Mercado Pago(4) ‚Äî Venc hoje</option>
                        <option value="mercado_pago_9">Mercado Pago(9) ‚Äî Venc hoje</option>
                        <option value="ofertas_recovery">Recovery - Motor de ofertas</option>
                      </optgroup>
                      <optgroup label="Realizar teste">
                        <option value="estrategia1">Teste Karen</option>
                        <option value="estrategia2">Teste Josimar e Larissa</option>
                        <option value="estrategia3">Teste Matheus Ribeiro</option>
                        <option value="estrategia4">Teste Hellen</option>
                        <option value="estrategia5">Teste Alessandra e Matheus T.</option>
                      </optgroup>
                    </select>
                  </div>
                </div>
                <div id="contagemContatos" class="muted" style="margin-top:6px;">Nenhum contato ainda.</div>
              </div>
              <div class="col-6">
                <h2>Mapeamento de Vari√°veis</h2>
                <div id="mapArea" class="muted">Carregue contatos e selecione um template.</div>
              </div>
            </div>

            <!-- Custos -->
            <div class="row" style="margin-top:12px;">
              <div class="col-6">
                <h2>Custo Estimado</h2>
                <div id="custoEstimado">üíµ Custo estimado: ‚Äî</div>
                <div id="custoReal">üí≥ Valor em Reais (com taxa): ‚Äî</div>
              </div>
              <div class="col-6">
                <label for="taxaConversaoExtra">Acr√©scimo (%)</label>
                <input id="taxaConversaoExtra" type="number" min="0" step="0.01" value="6" />
              </div>
            </div>

            <!-- Agendamento e Ritmo de Envio -->
            <div class="row" style="margin-top:12px;">
              <div class="col-6">
                <h2>Modo de Envio</h2>
                <div class="grid-2">
                  <div>
                    <label for="modoEnvio">Modo</label>
                    <select id="modoEnvio">
                      <option value="imediato" selected>Imediato</option>
                      <option value="agendar">Agendar</option>
                    </select>
                  </div>
                  <div id="dataHoraWrap" class="hide">
                    <label for="dataHoraEnvio">Data/Hora (agendamento)</label>
                    <input id="dataHoraEnvio" type="datetime-local" />
                  </div>
                </div>
                <div class="muted" style="margin-top:6px;">O agendamento √© processado no servidor.</div>
              </div>
              <div class="col-6">
                <h2>Ritmo / Lotes</h2>
                <div class="grid-3">
                  <div>
                    <label for="tamanhoLote">Tamanho do Lote</label>
                    <input id="tamanhoLote" type="number" min="1" placeholder="ex.: 50" />
                  </div>
                  <div>
                    <label for="intervaloLote">Intervalo entre Lotes (min)</label>
                    <input id="intervaloLote" type="number" min="0" value="0" />
                  </div>
                  <div>
                    <label for="intervaloMsg">Intervalo entre Mensagens (s)</label>
                    <input id="intervaloMsg" type="number" min="0" value="0" />
                  </div>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <div class="col-6">
                <label for="nomeDisparo">Nome do Disparo</label>
                <input id="nomeDisparo" placeholder="Campanha - Segmento X DD-MM-AAAA" required />
              </div>
              <div class="col-6">
                <label for="grupoTrabalho">Grupo de Trabalho</label>
                <input id="grupoTrabalho" placeholder="Equipe / Carteira" required />
              </div>
            </div>

            <!-- Envio -->
            <div class="row" style="margin-top:16px;align-items:center;">
              <div class="col-8 btn-row">
                <button class="btn success" id="btnEnviar">üöÄ Enviar</button>
                <button class="btn secondary" id="btnPausar">‚è∏Ô∏è Pausar</button>
                <button class="btn secondary" id="btnRetomar" disabled>‚ñ∂Ô∏è Retomar</button>
                <button class="btn danger" id="btnCancelar" disabled>üõë Cancelar</button>
                <button class="btn warn" id="btnNovoEnvio">üîÑ Novo Envio</button>
              </div>
              <div class="col-4" style="text-align:right">
                <div class="bar"><span id="progressBar"></span></div>
                <div class="muted" id="progressTxt">0/0</div>
              </div>
            </div>

            <!-- Logs -->
            <div class="row" style="margin-top:12px;">
              <div class="col-12">
                <h2>Logs</h2>
              </div>
              <div class="col-12">
                <div id="output">Pronto para enviar.</div>
                <div class="grid-3" style="margin-top:8px;">
                  <div>‚úÖ Sucesso: <b id="okCount">0</b></div>
                  <div>‚ùå Erros: <b id="errCount">0</b></div>
                  <div><button class="btn secondary" id="btnBaixarLog">‚¨áÔ∏è Baixar log</button></div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <script>
          // ================== Config de backends ==================
          const API_BASE = "https://whatsapp-webhook-production-9a27.up.railway.app"; // envios/agendamentos
          const ESTRAT_API = "https://consultasic-production.up.railway.app";           // estrat√©gias (SIC)

          // ================== Estado ==================
          const estrategias = {
            estrategia1: [
              { to: "5561982263659", vars: ["Karen", "100.00", "01/01/2025"] },
            ],
            estrategia2: [
              { to: "5561993242214", vars: ["Larissa", "100.00", "01/01/2025"] },
              { to: "5561986092009", vars: ["Josimar", "100.00", "01/01/2025"] },
            ],
            estrategia3: [
              { to: "5561999260399", vars: ["Matheus", "100.00", "01/01/2025"] },
            ],
            estrategia4: [
              { to: "5561994013534", vars: ["Hellen", "100.00", "01/01/2025"] },
            ],
            estrategia5: [
              { to: "556193794339", vars: ["Alessandra", "100.00", "01/01/2025"] },
              { to: "556191419712", vars: ["Matheus Teixeira", "100.00", "01/01/2025"] },
            ],
          };

          let contatos = [];              // [{ to, vars[] }]
          let csvHeaders = [];
          let custoEmDolar = 0;
          let mapping = { body: [], headerText: [], urlButtons: {} };
          let tmpl = { name: "", category: "", components: [], bodyText: "", bodyVars: 0, headerType: null, headerText: "", headerVars: 0, urlButtons: [] };
          let flags = { paused: false, cancelled: false };

          // ================== Utils ==================
          const $ = (sel) => document.querySelector(sel);
          const byId = (id) => document.getElementById(id);

          // ================== Estrat√©gias UI: filtro por conta ==================
          const estrategiaSelectEl = byId('estrategiaSelect');
          const optgroupConsulta = estrategiaSelectEl
            ? estrategiaSelectEl.querySelector('optgroup[label="Consulta no SIC"]')
            : null;
          const allConsultaOptions = optgroupConsulta
            ? Array.from(optgroupConsulta.querySelectorAll('option')).map(opt => ({
              value: opt.value,
              text: opt.textContent
            }))
            : [];

          function filtrarEstrategiasPorConta(contaKey) {
            if (!optgroupConsulta || !allConsultaOptions.length) return;

            optgroupConsulta.innerHTML = '';

            let allowedValues;
            switch (contaKey) {
              case 'arc4u':
                allowedValues = ['arc4u_G1', 'arc4u_G2', 'arc4u_M', 'arc4u_A1', 'arc4u_C1', 'atraso_new_Arc4u', 'atraso_old_Arc4u', 'antecipa_old_Arc4u', 'arc4u'];
                break;
              case 'recoverypf':
                allowedValues = ['ofertas_recovery'];
                break;
              case 'arc4u_veiculos':
                allowedValues = ['arc4u_veiculos'];
                break;
              case 'mpcobranca2':
                allowedValues = ['mercado_pago_2', 'mercado_pago_4', 'mercado_pago_9'];
                break;
              case 'serasa':
                allowedValues = ['serasa', 'serasa_atraso'];
                break;
              case 'divzero':
                allowedValues = ['divzero_hoje','divzero_eavm', 'divzero_p1','divzero_p2','divzero_lp','divzero_atraso','divzero_oficio','divzero_serasa','entrada_divzero_p1','entrada_divzero_p2','entrada_divzero_lp','entrada_divzero_eavm'];
                break;
              default:
                allowedValues = allConsultaOptions.map(o => o.value);
            }

            allConsultaOptions.forEach(o => {
              if (allowedValues.includes(o.value)) {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                optgroupConsulta.appendChild(opt);
              }
            });

            if (!allowedValues.includes(estrategiaSelectEl.value)) {
              estrategiaSelectEl.value = '';
            }
          }

          function log(line) {
            const out = byId('output');
            out.textContent += (out.textContent ? "\n" : "") + line;
            out.scrollTop = out.scrollHeight;
          }
          function setProgress(done, total) {
            const pct = total > 0 ? (done / total) * 100 : 0;
            byId('progressBar').style.width = pct.toFixed(1) + '%';
            byId('progressTxt').textContent = `${done}/${total}`;
          }
          function countPlaceholders(text) {
            if (!text) return 0;
            const matches = text.match(/\{\{\d+\}\}/g);
            return matches ? new Set(matches).size : 0;
          }
          function substitutePlaceholders(text, values) {
            if (!text) return '';
            return text.replace(/\{\{(\d+)\}\}/g, (_, n) => {
              const idx = parseInt(n, 10) - 1;
              return values[idx] != null ? String(values[idx]) : `{{${n}}}`;
            });
          }
          function parseCSV(text) {
            const delim = text.includes(';') && !text.includes(',') ? ';' : ',';
            const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l => l.trim().length > 0);
            const rows = [];
            for (const line of lines) {
              const row = [];
              let cur = '', inQ = false;
              for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                  if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
                  else { inQ = !inQ; }
                } else if (ch === delim && !inQ) {
                  row.push(cur); cur = '';
                } else {
                  cur += ch;
                }
              }
              row.push(cur);
              rows.push(row.map(c => c.trim()));
            }
            return rows;
          }
          function ensureNumber(v, fallback = 0) {
            const n = Number(v);
            return Number.isFinite(n) ? n : fallback;
          }
          function escapeHtml(str = '') {
            return str.replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
          }

          
          function pickAny(obj, keys) {
            for (const k of keys) {
              if (obj && obj[k] != null && obj[k] !== "") return obj[k];
            }
            return "";
          }

          // evita quebrar conteudo CSV (backend separa por v√≠rgula)
          function safeVar(v) {
            let s = (v ?? "").toString();
            s = s.replace(/\r\n?/g, "\n").replace(/\n+/g, " ").trim();

            // 1) troca v√≠rgula decimal (310,48 -> 310.48)
            s = s.replace(/(\d),(\d)/g, "$1.$2");

            // 2) qualquer outra v√≠rgula vira " - " pra n√£o quebrar o split
            s = s.replace(/,/g, " - ");

            return s;
          }

// ================== UI Helpers ==================
          function renderSelect(id, varIndex, current) {
            let opts = '';
            if (csvHeaders.length > 0) {
              csvHeaders.forEach((h, idx) => {
                const sel = idx === current ? 'selected' : '';
                opts += `<option value="${idx}" ${sel}>${idx + 1} ‚Äî ${escapeHtml(h)}</option>`;
              });
            } else {
              const maxCols = Math.max(1, ...(contatos.map(c => c.vars.length)));
              for (let idx = 0; idx < maxCols; idx++) {
                const sel = idx === current ? 'selected' : '';
                opts += `<option value="${idx}" ${sel}>${idx + 1}</option>`;
              }
            }
            return `<label for="${id}">{{${varIndex + 1}}} ‚ü∂ coluna</label><select id="${id}">${opts}</select>`;
          }

          function renderMapUI() {
            const area = byId('mapArea');
            const hasTemplate = !!tmpl.name;
            const hasContacts = contatos.length > 0;

            if (!hasTemplate || !hasContacts) {
              area.innerHTML = '<span class="muted">Carregue contatos e selecione um template para configurar o mapeamento.</span>';
              updatePreview();
              return;
            }

            const headerPart = (() => {
              if (!tmpl.headerType) return '';
              if (tmpl.headerType === 'TEXT' && tmpl.headerVars > 0) {
                let selects = '';
                for (let i = 0; i < tmpl.headerVars; i++) {
                  selects += renderSelect(`map-header-${i}`, i, mapping.headerText[i]);
                }
                return `<h3>Header TEXT ‚Äî vari√°veis</h3>${selects}`;
              }
              if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(tmpl.headerType)) {
                return '<div class="muted">Header de m√≠dia usa a URL informada em "Link da M√≠dia do Header".</div>';
              }
              return '';
            })();

            let bodySelects = '';
            if (tmpl.bodyVars > 0) {
              bodySelects += '<h3>Body ‚Äî vari√°veis</h3>';
              for (let i = 0; i < tmpl.bodyVars; i++) {
                bodySelects += renderSelect(`map-body-${i}`, i, mapping.body[i]);
              }
            } else {
              bodySelects += '<div class="muted">Body sem vari√°veis.</div>';
            }

            let buttonsPart = '';
            if (tmpl.urlButtons.length > 0) {
              buttonsPart += '<h3>Bot√µes URL ‚Äî vari√°veis</h3>';
              tmpl.urlButtons.forEach(btn => {
                if (btn.hasVar) {
                  buttonsPart += `<div style="margin:6px 0 10px"><b>Bot√£o #${btn.index + 1}</b> ‚Äî URL base: <span class="kbd">${btn.url}</span><br/>` +
                    renderSelect(`map-urlbtn-${btn.index}-0`, 0, mapping.urlButtons[btn.index]?.[0]) + '</div>';
                }
              });
            }

            const sample = contatos[0] || { to: '', vars: [] };
            const bodyPreviewVals = (mapping.body || []).map(ci => ci != null ? sample.vars[ci] : '');
            const bodyPrev = substitutePlaceholders(tmpl.bodyText, bodyPreviewVals);

            area.innerHTML = `
              ${headerPart}
              ${bodySelects}
              ${buttonsPart}
              <div style="margin-top:10px">
                <div class="muted">Pr√©via com o <b>primeiro contato</b>:</div>
                <div class="card" style="padding:10px;border:1px dashed #cbd5e1;">
                  ${bodyPrev.replace(/\n/g, '<br/>')}
                </div>
              </div>
            `;

            if (tmpl.headerType === 'TEXT') {
              for (let i = 0; i < tmpl.headerVars; i++) {
                byId(`map-header-${i}`)?.addEventListener('change', (e) => {
                  mapping.headerText[i] = ensureNumber(e.target.value, 0);
                  updatePreview();
                });
              }
            }
            for (let i = 0; i < tmpl.bodyVars; i++) {
              byId(`map-body-${i}`)?.addEventListener('change', (e) => {
                mapping.body[i] = ensureNumber(e.target.value, 0);
                renderMapUI();
                updatePreview();
              });
            }
            tmpl.urlButtons.forEach(btn => {
              if (btn.hasVar) {
                byId(`map-urlbtn-${btn.index}-0`)?.addEventListener('change', (e) => {
                  mapping.urlButtons[btn.index] = [ensureNumber(e.target.value, 0)];
                });
              }
            });

            updatePreview();
          }

          // ================== Custos ==================
          async function calcularCusto() {
            const categoria = byId('templateCategory').value;
            const qtd = contatos.length;
            if (!categoria || !qtd) {
              byId('custoEstimado').textContent = 'üíµ Custo estimado: ‚Äî';
              byId('custoReal').textContent = 'üí≥ Valor em Reais (com taxa): ‚Äî';
              return;
            }
            const price = (categoria === 'authentication' || categoria === 'utility') ? 0.0068 : (categoria === 'marketing' ? 0.0625 : 0);
            custoEmDolar = qtd * price;
            byId('custoEstimado').textContent = `üíµ Custo estimado: $${custoEmDolar.toFixed(4)}`;

            try {
              const res = await fetch('https://open.er-api.com/v6/latest/USD');
              const data = await res.json();
              const brl = data?.rates?.BRL ?? 5.0;
              const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
              const final = custoEmDolar * brl * taxa;
              byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa): R$${final.toFixed(2)}`;
            } catch (e) {
              const brl = 5.0;
              const taxa = 1 + (ensureNumber(byId('taxaConversaoExtra').value, 6) / 100);
              const final = custoEmDolar * brl * taxa;
              byId('custoReal').textContent = `üí≥ Valor em Reais (com taxa ‚Äì c√¢mbio offline): R$${final.toFixed(2)}`;
            }
          }

          // ================== Pr√©-visualiza√ß√£o ==================
          function updatePreview() {
            if (!tmpl.name) { byId('previewArea').textContent = '‚Äî'; return; }

            const body = tmpl.bodyText || '';
            let values = [];

            const compBody = (tmpl.components || []).find(c => c.type === 'BODY');
            const exemploBody = compBody?.example?.body_text?.[0];
            if (Array.isArray(exemploBody) && exemploBody.length) {
              values = exemploBody;
            } else if (contatos.length && tmpl.bodyVars > 0) {
              const sample = contatos[0];
              values = (mapping.body || []).map(ci => sample.vars[ci] ?? '');
            }

            const bodyPreview = values.length ? substitutePlaceholders(body, values) : body;

            let headerPreview = '';
            if (tmpl.headerType === 'TEXT') {
              const headerVals = [];
              if (tmpl.headerVars > 0 && contatos.length) {
                const s = contatos[0];
                for (let i = 0; i < tmpl.headerVars; i++) headerVals.push(s.vars[mapping.headerText[i] ?? i] ?? '');
              }
              headerPreview = substitutePlaceholders(tmpl.headerText || '', headerVals);
            }

            const parts = [];
            parts.push('üìÑ Pr√©-visualiza√ß√£o:');
            if (headerPreview) { parts.push(`*${headerPreview}*\n`); }
            parts.push(bodyPreview);

            if (tmpl.urlButtons?.length) {
              const btns = tmpl.urlButtons.map((b, i) => {
                if (!b.hasVar) return `‚Ä¢ Bot√£o ${i + 1}: URL fixa`;
                const colIdx = mapping.urlButtons[i]?.[0];
                const sampleVal = (contatos[0]?.vars || [])[colIdx ?? 0] ?? '{{1}}';
                const final = (b.url || '').replace(/\{\{1\}\}/g, sampleVal);
                return `‚Ä¢ Bot√£o ${i + 1}: ${final}`;
              }).join('\n');
              if (btns) parts.push('\n[BOT√ïES]\n' + btns);
            }

            byId('previewArea').textContent = parts.join('\n\n');
          }

          // ================== Templates (Graph API) ==================
          byId('btnBuscar').addEventListener('click', buscarTemplates);
          async function buscarTemplates() {
            const token = byId('token').value.trim();
            const wabaId = byId('wabaId').value.trim();
            const ver = byId('graphVersion').value;
            if (!token || !wabaId) { alert('Informe token e WABA ID.'); return; }

            const select = byId('templateSelect');
            select.innerHTML = '<option value="">Carregando...</option>';

            const urlBase = `https://graph.facebook.com/${ver}/${encodeURIComponent(wabaId)}/message_templates?limit=100&status=APPROVED`;
            const all = [];
            let next = urlBase;
            try {
              while (next) {
                const r = await fetch(next, { headers: { Authorization: `Bearer ${token}` } });
                const j = await r.json();
                if (Array.isArray(j.data)) all.push(...j.data);
                next = j?.paging?.next || null;
              }
            } catch (e) {
              alert('Erro ao buscar templates: ' + e.message);
              select.innerHTML = '<option value="">-- Erro ao buscar --</option>';
              return;
            }

            if (all.length === 0) {
              select.innerHTML = '<option value="">-- Nenhum template aprovado encontrado --</option>';
              return;
            }

            select.innerHTML = '<option value="">-- Selecione um template --</option>';
            all.sort((a, b) => a.name.localeCompare(b.name)).forEach(t => {
              const opt = document.createElement('option');
              opt.value = JSON.stringify(t);
              opt.textContent = `${t.name} ¬∑ ${t.category}`;
              select.appendChild(opt);
            });
          }

          byId('templateSelect').addEventListener('change', preencherTemplateInfo);
          function preencherTemplateInfo() {
            const val = byId('templateSelect').value;
            if (!val) return;
            const t = JSON.parse(val);

            tmpl.name = t.name;
            tmpl.category = t.category || '';
            tmpl.components = t.components || [];
            byId('templateName').value = tmpl.name;
            byId('templateCategory').value = tmpl.category || '';

            const header = tmpl.components.find(c => c.type === 'HEADER');
            const body = tmpl.components.find(c => c.type === 'BODY');
            const buttons = tmpl.components.find(c => c.type === 'BUTTONS');

            tmpl.headerType = null;
            tmpl.headerText = '';
            tmpl.headerVars = 0;
            byId('headerFormat').value = '';
            byId('headerTextWrap').classList.add('hide');
            byId('mediaLinkWrap').classList.add('hide');

            if (header) {
              const fmt = header.format;
              tmpl.headerType = fmt;
              byId('headerFormat').value = fmt || '';
              if (fmt === 'TEXT') {
                tmpl.headerText = header.text || '';
                tmpl.headerVars = countPlaceholders(tmpl.headerText);
                byId('headerTextWrap').classList.remove('hide');
              } else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(fmt)) {
                byId('mediaLinkWrap').classList.remove('hide');
              }
            }

            tmpl.bodyText = body?.text || '';
            tmpl.bodyVars = countPlaceholders(tmpl.bodyText);

            tmpl.urlButtons = [];
            if (buttons && Array.isArray(buttons.buttons)) {
              buttons.buttons.forEach((b, idx) => {
                if (b.type === 'URL') {
                  const hasVar = (b.url || '').includes('{{');
                  tmpl.urlButtons.push({ index: idx, url: b.url || '', hasVar });
                }
              });
            }

            mapping.body = Array.from({ length: tmpl.bodyVars }, (_, i) => i);
            mapping.headerText = Array.from({ length: tmpl.headerVars }, (_, i) => i);
            mapping.urlButtons = {};

            renderMapUI();
            calcularCusto();
            updatePreview();
          }

          // ================== Estrat√©gias ONLINE (consulta do sic) ==================
                    async function carregarEstrategiaOnline(fonte) {
                      const url = `${ESTRAT_API}/api/estrategias/${encodeURIComponent(fonte)}`;
                      const res = await fetch(url, {
                        method: "GET",
                        mode: "cors",
                        credentials: "omit",
                        cache: "no-store"
                      });
                      if (!res.ok) {
                        const msg = await res.text();
                        throw new Error(`Falha ao carregar estrat√©gia (${res.status}): ${msg}`);
                      }
                      const data = await res.json();
                      const rows = Array.isArray(data?.dados) ? data.dados : [];

                      // Templates especiais: arc4u_veiculos e ofertas_recovery
                      if (fonte === "arc4u_veiculos") {
                        // Arc4U Ve√≠culos: [PrimeiroNome, CPF, PLACA]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to", "msisdn", "phone", "celular", "numero", "destinatario"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          let placaRaw = pickAny(row, ["PLACA", "placa", "Placa", "PLACA_VEICULO", "placa_veiculo", "PLACA_VEIC"]);
                          if (!placaRaw) {
                            for (const k in row) {
                              const kUp = String(k).toUpperCase();
                              if ((kUp.includes("PLACA") || kUp.includes("VEICULO")) && row[k] != null && row[k] !== "") { placaRaw = row[k]; break; }
                            }
                          }

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(placaRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "PLACA"];

                      } else if (fonte === "ofertas_recovery") {
                        // Ofertas Recovery (SIC): [PrimeiroNome, CPF, DESCRICAO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          const descRaw = pickAny(row, ["DESCRICAO", "Descricao", "descricao", "ds_descricao"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(descRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "DESCRICAO"];

                      } else if (fonte === "entrada_divzero_p1") {
                        // Ofertas Recovery (SIC): [PrimeiroNome, CPF, DESCRICAO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          const descRaw = pickAny(row, ["DESCRICAO", "Descricao", "descricao", "ds_descricao"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(descRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "DESCRICAO"];

                      } else if (fonte === "entrada_divzero_p2") {
                        // Ofertas Recovery (SIC): [PrimeiroNome, CPF, DESCRICAO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          const descRaw = pickAny(row, ["DESCRICAO", "Descricao", "descricao", "ds_descricao"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(descRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "DESCRICAO"];

                      } else if (fonte === "entrada_divzero_lp") {
                        // Ofertas Recovery (SIC): [PrimeiroNome, CPF, DESCRICAO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          const descRaw = pickAny(row, ["DESCRICAO", "Descricao", "descricao", "ds_descricao"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(descRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "DESCRICAO"];

                      } else if (fonte === "entrada_divzero_eavm") {
                        // Ofertas Recovery (SIC): [PrimeiroNome, CPF, DESCRICAO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);

                          let cpfRaw = pickAny(row, ["CPF", "cpf", "Cpf", "CPF_CLIENTE", "cpf_cliente"]);
                          if (!cpfRaw) {
                            for (const k in row) {
                              if (String(k).toUpperCase().includes("CPF") && row[k] != null && row[k] !== "") { cpfRaw = row[k]; break; }
                            }
                          }

                          const descRaw = pickAny(row, ["DESCRICAO", "Descricao", "descricao", "ds_descricao"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(cpfRaw), safeVar(descRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "CPF", "Contrato"];

                      } else {
                        // Fluxo normal: [PrimeiroNome, VALOR_PARCELA, VENCIMENTO]
                        contatos = rows.map(r => {
                          const row = r || {};
                          const telRaw = pickAny(row, ["TELEFONE", "telefone", "Telefone", "Tel", "tel", "to"]);
                          const tel = String(telRaw).replace(/\D+/g, "");

                          const nomeRaw = pickAny(row, ["PrimeiroNome", "primeiroNome", "PRIMEIRONOME", "NOME", "Nome", "nome", "cliente"]);
                          const valorRaw = pickAny(row, ["VALOR_PARCELA", "valor_parcela", "valor", "valor_parc", "vl_parcela", "vlr"]);
                          const vctoRaw = pickAny(row, ["VENCIMENTO", "vencimento", "dt_vcto", "data_vencimento", "dt_venc"]);

                          return { to: tel, vars: [safeVar(nomeRaw), safeVar(valorRaw), safeVar(vctoRaw)] };
                        }).filter(c => c.to);

                        csvHeaders = ["PrimeiroNome", "VALOR_PARCELA", "VENCIMENTO"];
                      }

                      document.getElementById('contagemContatos').textContent =
                        `‚úîÔ∏è Estrat√©gia "${fonte}" (consulta no sic) carregada com ${contatos.length} contato(s).`;

                      renderMapUI();
                      calcularCusto();
                    }

          // ================== Contatos (arquivo e exemplos) ==================
          byId('estrategiaSelect').addEventListener('change', async function () {
            const selected = this.value;
            try {
              if (selected === "arc4u_veiculos" || selected === "atraso_old_Arc4u" || selected === "antecipa_old_Arc4u" || selected === "divzero_eavm" || selected === "divzero_p1" || selected === "divzero_p2" || selected === "divzero_lp" || selected === "divzero_atraso" || selected === "divzero_oficio" || selected === "divzero_hoje" || selected === "divzero_serasa" || selected === "entrada_divzero_p1" || selected === "entrada_divzero_p2" || selected === "entrada_divzero_lp" || selected === "entrada_divzero_eavm" || selected === "atraso_new_Arc4u" || selected === "arc4u_G1" || selected === "arc4u_G2" || selected === "arc4u_M" || selected === "arc4u_C1" || selected === "arc4u_A1" || selected === "arc4u" || selected === "mercado_pago_2" || selected === "mercado_pago_4" || selected === "mercado_pago_9" || selected === "serasa_atraso" || selected === "serasa" || selected === "ofertas_recovery") {
                document.getElementById('contagemContatos').textContent = `‚è≥ Carregando ${selected}...`;
                await carregarEstrategiaOnline(selected);
                return;
              }
              if (estrategias[selected]) {
                contatos = JSON.parse(JSON.stringify(estrategias[selected]));
                csvHeaders = ["PrimeiroNome", "VALOR_PARCELA", "VENCIMENTO"];
                document.getElementById('contagemContatos').textContent =
                  `‚úîÔ∏è Estrat√©gia "${selected}" (teste) carregada com ${contatos.length} contato(s).`;
                renderMapUI();
                calcularCusto();
              } else {
                contatos = [];
                csvHeaders = [];
                document.getElementById('contagemContatos').textContent = 'Nenhum contato ainda.';
                renderMapUI();
                calcularCusto();
              }
            } catch (e) {
              console.error(e);
              document.getElementById('contagemContatos').textContent = `‚ùå ${e.message}`;
            }
          });

          byId('fileInput').addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
              const rows = parseCSV(e.target.result);
              if (rows.length === 0) return;

              const head = rows[0].map(c => (c || '').toLowerCase());
              const hasHeader = head.some(c => c.includes('telefone') || c === 'to' || c.includes('phone'));

              const dataRows = hasHeader ? rows.slice(1) : rows;
              csvHeaders = hasHeader ? rows[0] : (dataRows[0]?.map((_, i) => `coluna_${i + 1}`) || []);

              contatos = dataRows.map(r => ({
                to: (r[0] || '').replace(/\D+/g, ''),
                vars: r.slice(1).map(safeVar),
              })).filter(c => c.to);

              document.getElementById('contagemContatos').textContent = `‚úîÔ∏è Arquivo carregado com ${contatos.length} contato(s).`;
              renderMapUI();
              calcularCusto();
            };
            reader.readAsText(file);
          });

          byId('taxaConversaoExtra').addEventListener('change', calcularCusto);
          byId('templateCategory').addEventListener('change', calcularCusto);

          // ================== Agendamento UI ==================
          byId('modoEnvio').addEventListener('change', () => {
            const isAgendar = byId('modoEnvio').value === 'agendar';
            byId('dataHoraWrap').classList.toggle('hide', !isAgendar);
          });

          // ================== Envio via BACKEND ==================
          async function onEnviarClick() {
            if (contatos.length === 0) {
              alert('Nenhum contato carregado.');
              return;
            }

            const payload = {
              token: byId("token").value.trim(),    // para Graph/WhatsApp
              phone_id: byId("phoneId").value.trim(),
              waba_id: byId("wabaId").value.trim(),
              nome_disparo: byId("nomeDisparo").value.trim(),
              grupo_trabalho: byId("grupoTrabalho").value.trim(),
              modo_envio: byId("modoEnvio").value,
              data_hora_agendamento: byId("dataHoraEnvio").value || null,
              intervalo_msg: Number(byId("intervaloMsg").value || 0),
              tamanho_lote: Number(byId("tamanhoLote").value || 0),
              intervalo_lote: Number(byId("intervaloLote").value || 0),
              template: {
                name: tmpl.name,
                language: "pt_BR",
                headerType: tmpl.headerType,
                bodyText: tmpl.bodyText,
                bodyVars: tmpl.bodyVars,
                headerVars: tmpl.headerVars,
                urlButtons: tmpl.urlButtons,
                mapping: mapping,
                mediaLink: byId("mediaLink").value.trim()
              },
              contatos: contatos.map(c => ({
                telefone: c.to,
                conteudo: c.vars.join(",")
              }))
            };

            try {
              const res = await fetch(`${API_BASE}/api/envios`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              const data = await res.json();
              if (data.ok) {
                log(`‚úîÔ∏è Disparo "${payload.nome_disparo}" cadastrado com sucesso (ID ${data.id}).`);
              } else {
                log("‚ùå Erro ao salvar disparo: " + (data.erro || JSON.stringify(data)));
              }
            } catch (e) {
              log("‚ùå Falha de rede ao salvar disparo: " + e.message);
            }
          }
          document.getElementById("btnEnviar").addEventListener("click", onEnviarClick);

          byId('btnPausar').addEventListener('click', () => {
            flags.paused = true; byId('btnRetomar').disabled = false; log('‚è∏Ô∏è Pausa solicitada (se aplic√°vel ao backend).');
          });
          byId('btnRetomar').addEventListener('click', () => {
            flags.paused = false; byId('btnRetomar').disabled = true; log('‚ñ∂Ô∏è Retomar solicitado (se aplic√°vel ao backend).');
          });
          byId('btnCancelar').addEventListener('click', () => {
            flags.cancelled = true; log('üõë Cancelamento solicitado (se aplic√°vel ao backend).');
          });

          byId('btnNovoEnvio').addEventListener('click', () => {
            contatos = [];
            csvHeaders = [];
            mapping = { body: [], headerText: [], urlButtons: {} };
            flags = { paused: false, cancelled: false };
            byId('output').textContent = 'Pronto para novo envio.';
            byId('okCount').textContent = '0';
            byId('errCount').textContent = '0';
            byId('progressBar').style.width = '0%';
            byId('progressTxt').textContent = '0/0';
            byId('contagemContatos').textContent = 'Nenhum contato ainda.';
            renderMapUI();
            calcularCusto();
            log('üîÑ Novo envio iniciado ‚Äî mantenha suas credenciais se for buscar templates.');
          });

          // IDs por conta
          const contas = {
            connectzap: { phone: "789025174304270", waba: "1504619580765370" },
            bancopan: { phone: "805610009301153", waba: "25205080369078050" },
            recoverypj: { phone: "727586317113885", waba: "844006574616797" },
            recoverypf: { phone: "802977069563598", waba: "825347669829173" },
            recoverypf_prev: { phone: "938298879357445", waba: "825347669829173" },
            recoverypf_man: { phone: "897647883433681", waba: "825347669829173" },
            mpcobranca: { phone: "821562937700669", waba: "1989071868573988" },
            divzero: { phone: "779797401888141", waba: "1714740535849713" },
            arc4u: { phone: "829210283602406", waba: "757728786687884" },
            arc4u_veiculos: { phone: "905309685992125", waba: "757728786687884" },
            serasa: { phone: "713021321904495", waba: "803987045361450" },
            mpvendas: { phone: "803535039503723", waba: "760293050103603" }
          };
          document.getElementById("contaSelect").addEventListener("change", function () {
            const contaKey = this.value;
            const conta = contas[contaKey];
            document.getElementById("phoneId").value = conta?.phone || "";
            document.getElementById("wabaId").value = conta?.waba || "";
            filtrarEstrategiasPorConta(contaKey);
          });

          // Baixar log
          byId('btnBaixarLog').addEventListener('click', () => {
            const blob = new Blob([byId('output').textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `log-whatsapp-${Date.now()}.txt`;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
          });

          // Aplica filtro inicial de estrat√©gias
          filtrarEstrategiasPorConta(byId('contaSelect').value || '');
        </script>
      </div>

      <!-- Aba: Envio individual -->
      <div id="tab-individual" class="tab-content">
        <div class="container">
          <div class="card">
            <h1>Envio individual com Template <span class="pill">vers√£o 2025-12-05</span></h1>
            <div class="muted">
              Busque o cliente por c√≥digo, escolha o telefone e envie um template para apenas um n√∫mero, com op√ß√£o de envio imediato ou agendado.
            </div>

            <!-- Credenciais -->
            <h2>Credenciais</h2>
            <div class="row">
              <div class="col-6">
                <label for="token_ind">Token de Acesso</label>
                <input id="token_ind" placeholder="Cole seu token" />
              </div>
              <div class="col-6">
                <label for="contaSelect_ind">Conta</label>
                <select id="contaSelect_ind">
                  <option value="">-- Selecione a conta --</option>
                  <option value="connectzap">ConnectZap</option>
                  <option value="bancopan">Banco PAN</option>
                  <option value="recoverypj">Recovery PJ</option>
                  <option value="recoverypf">Recovery PF</option>
                  <option value="recoverypf_prev">Recovery Preventivo</option>
                  <option value="recoverypf_man">Recovery Manuten√ß√£o</option>
                  <option value="mpcobranca">Mercado Pago Cobran√ßa</option>
                  <option value="divzero">DivZero</option>
                  <option value="arc4u">Arc4U</option>
                  <option value="arc4u_veiculos">Arc4U Veiculos</option>
                  <option value="serasa">Serasa</option>
                  <option value="mpvendas">Mercado Pago Vendas</option>
                </select>
              </div>
              <div class="col-6">
                <label for="wabaId_ind">WhatsApp Business ID</label>
                <input id="wabaId_ind" readonly />
              </div>
              <div class="col-6">
                <label for="phoneId_ind">Phone Number ID</label>
                <input id="phoneId_ind" readonly />
              </div>
              <div class="col-6">
                <label for="graphVersion_ind">Vers√£o Graph API</label>
                <select id="graphVersion_ind">
                  <option value="v24.0" selected>v24.0</option>
                  <option value="v23.0">v23.0</option>
                  <option value="v22.0">v22.0</option>
                </select>
              </div>
            </div>

            <!-- Busca de templates -->
            <div class="row" style="margin-top:12px;align-items:center">
              <div class="col-6">
                <button class="btn" id="btnBuscar_ind">üîç Buscar templates aprovados</button>
              </div>
              <div class="col-6">
                <label for="templateSelect_ind">Template</label>
                <select id="templateSelect_ind">
                  <option value="">-- Selecione um template --</option>
                </select>
              </div>
            </div>

            <!-- Info template -->
            <div class="row" style="margin-top:6px;">
              <div class="col-6">
                <label for="templateName_ind">Nome do Template</label>
                <input id="templateName_ind" readonly />
              </div>
              <div class="col-3">
                <label for="templateCategory_ind">Categoria</label>
                <select id="templateCategory_ind">
                  <option value="">-- Selecione --</option>
                  <option value="authentication">Authentication</option>
                  <option value="marketing">Marketing</option>
                  <option value="utility">Utility</option>
                  <option value="service">Service</option>
                </select>
              </div>
              <div class="col-3">
                <label for="headerFormat_ind">Formato de Header</label>
                <input id="headerFormat_ind" readonly />
              </div>
            </div>

            <div class="row" style="margin-top:6px;">
              <div class="col-12 hide" id="mediaLinkWrap_ind">
                <label for="mediaLink_ind">Link da M√≠dia do Header (IMAGE/VIDEO/DOCUMENT)</label>
                <input id="mediaLink_ind" placeholder="https://... (acess√≠vel publicamente)" />
                <div class="muted">Se informado, ser√° enviado como header de m√≠dia do template.</div>
              </div>
            </div>

            <!-- Pesquisa de cadastro -->
            <h2 style="margin-top:18px;">Pesquisa de cadastro</h2>
            <div class="row">
              <div class="col-3">
                <label for="baseSelect_ind">Base</label>
                <select id="baseSelect_ind">
                  <option value="">-- Selecione --</option>
                  <option value="bd4">BD4</option>
                  <option value="bd5">BD5</option>
                  <option value="bd7">BD7</option>
                  <option value="bd8">BD8</option>
                </select>
              </div>
              <div class="col-5">
                <label for="codigo_ind">C√≥digo do cliente</label>
                <input id="codigo_ind" placeholder="Informe o c√≥digo / id do cliente" />
              </div>
              <div class="col-4" style="margin-top:28px;">
                <button class="btn" id="btnPesquisar_ind">üîé Buscar</button>
              </div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="col-12">
                <div id="resultadoPesquisa_ind" class="muted">Informe base e c√≥digo para pesquisar.</div>
              </div>
            </div>

            <div class="row" style="margin-top:6px;">
              <div class="col-12">
                <h2>Telefone escolhido</h2>
                <div id="telefoneEscolhido_ind" class="muted">Nenhum telefone selecionado ainda.</div>
              </div>
            </div>

            <!-- Pr√©-visualiza√ß√£o individual -->
            <div class="row" style="margin-top:6px;">
              <div class="col-12">
                <h2>Pr√©-visualiza√ß√£o da mensagem</h2>
                <div id="previewArea_ind">Selecione um template e um telefone para ver a pr√©via aqui.</div>
              </div>
            </div>

            <!-- Modo de envio / Identifica√ß√£o -->
            <div class="row" style="margin-top:12px;">
              <div class="col-6">
                <h2>Modo de envio</h2>
                <div class="grid-2">
                  <div>
                    <label for="modoEnvio_ind">Modo</label>
                    <select id="modoEnvio_ind">
                      <option value="imediato" selected>Imediato</option>
                      <option value="agendar">Agendar</option>
                    </select>
                  </div>
                  <div id="dataHoraWrap_ind" class="hide">
                    <label for="dataHoraEnvio_ind">Data/Hora (agendamento)</label>
                    <input id="dataHoraEnvio_ind" type="datetime-local" />
                  </div>
                </div>
                <div class="muted" style="margin-top:6px;">O Connect processa o agendamento da mesma forma que o envio em massa.</div>
              </div>
              <div class="col-6">
                <h2>Identifica√ß√£o do disparo</h2>
                <label for="nomeDisparo_ind">Nome do disparo</label>
                <input id="nomeDisparo_ind" readonly placeholder="Ser√° preenchido com o c√≥digo do cliente" />
                <label for="grupoTrabalho_ind">Grupo de trabalho</label>
                <input id="grupoTrabalho_ind" readonly value="Envio individual" />
                <div class="muted" style="margin-top:4px;">Esses campos s√£o preenchidos automaticamente para evitar erros.</div>
              </div>
            </div>

            <!-- Envio individual -->
            <div class="row" style="margin-top:16px;align-items:center;">
              <div class="col-6 btn-row">
                <button class="btn success" id="btnEnviar_ind">üöÄ Enviar individual</button>
              </div>
            </div>

            <!-- Logs individuais -->
            <div class="row" style="margin-top:12px;">
              <div class="col-12">
                <h2>Logs (envio individual)</h2>
                <div id="output_ind">Pronto para envio individual.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Agendamentos -->
      <div id="tab-agendamentos" class="tab-content">
        <div class="row" style="align-items:end">
          <div class="col-4">
            <h2>üìÖ Gerenciar Agendamentos</h2>
          </div>
          <div class="col-8" style="text-align:right;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
            <input id="filtroBusca" placeholder="Buscar por nome ou grupo..." />
            <select id="filtroModo">
              <option value="">Modo: todos</option>
              <option value="imediato">Imediato</option>
              <option value="agendar">Agendado</option>
            </select>
            <select id="filtroStatus">
              <option value="">Status: todos</option>
              <option value="agendado">Agendado</option>
              <option value="em_andamento">Em andamento</option>
              <option value="pausado">Pausado</option>
              <option value="concluido">Conclu√≠do</option>
              <option value="cancelado">Cancelado</option>
            </select>
            <button class="btn secondary" id="btnAtualizarAg">‚ü≥ Atualizar</button>
          </div>
        </div>

        <!-- Totais -->
        <div id="agTotals" class="row" style="margin-top:8px">
          <div class="col-12 muted">‚Äî</div>
        </div>

        <div class="card" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th style="width:20%">Nome</th>
                <th style="width:14%">Grupo</th>
                <th style="width:16%">Data/Hora</th>
                <th style="width:12%">Modo</th>
                <th style="width:18%">Progresso</th>
                <th style="width:10%">Status</th>
                <th style="width:10%">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyAgendamentos">
              <tr>
                <td colspan="7" class="muted">Carregando agendamentos...</td>
              </tr>
            </tbody>
          </table>

          <!-- Pagina√ß√£o simples -->
          <div id="agPagination" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button class="btn secondary" id="agPrev">‚óÄ</button>
            <span class="muted" id="agPageInfo">P√°gina 1/1</span>
            <button class="btn secondary" id="agNext">‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- Modal de edi√ß√£o -->
      <div id="agModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="agModalTitle">
        <div class="card" style="width:520px;max-width:95%;position:relative">
          <h2 id="agModalTitle">‚úèÔ∏è Editar envio</h2>
          <div class="row">
            <div class="col-12">
              <label>Nome</label>
              <input id="mNome" />
            </div>
            <div class="col-12">
              <label>Grupo</label>
              <input id="mGrupo" />
            </div>
            <div class="col-6">
              <label>Modo</label>
              <select id="mModo">
                <option value="imediato">Imediato</option>
                <option value="agendar">Agendar</option>
              </select>
            </div>
            <div class="col-6" id="mDataWrap">
              <label>Data/Hora (agendamento)</label>
              <input id="mDataHora" type="datetime-local" />
            </div>
            <div class="col-4">
              <label>Tamanho do Lote</label>
              <input id="mTam" type="number" min="1" />
            </div>
            <div class="col-4">
              <label>Intervalo Lote (min)</label>
              <input id="mIntLote" type="number" min="0" />
            </div>
            <div class="col-4">
              <label>Intervalo Msg (s)</label>
              <input id="mIntMsg" type="number" min="0" />
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn secondary" id="mCancelar">Cancelar</button>
            <button class="btn success" id="mSalvar">Salvar</button>
          </div>
        </div>
      </div>

      <script>
        // ==== Tabs ====
        document.querySelectorAll(".tab-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
            if (btn.dataset.tab === "agendamentos") carregarAgendamentos(true);
          });
        });

        const PAGE_SIZE = 10;

        // ==== State da aba Agendamentos ====
        let agRaw = [];
        let agFiltered = [];
        let agPage = 1;

        // ==== Helpers ====
        const fmtBadge = (text, kind) =>
          `<span class="pill" style="${kind === 'ok' ? 'background:#ecfdf5;border-color:#bbf7d0;color:#065f46' : kind === 'warn' ? 'background:#fff7ed;border-color:#fed7aa;color:#9a3412' : kind === 'err' ? 'background:#fef2f2;border-color:#fecaca;color:#991b1b' : 'background:#eef2ff;border-color:#c7d2fe;color:#3730a3'}">${text}</span>`;

        const pad2 = n => String(n).padStart(2, "0");
        function toLocalISO(dtStr) {
          if (!dtStr) return "";
          const d = new Date(dtStr);
          const y = d.getFullYear(), m = pad2(d.getMonth() + 1), day = pad2(d.getDate());
          const hh = pad2(d.getHours()), mm = pad2(d.getMinutes());
          return `${y}-${m}-${day}T${hh}:${mm}`;
        }
        function fmtDateTime(dtStr) {
          if (!dtStr) return "‚Äî";
          const d = new Date(dtStr);
          return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
        }
        function progressBar(done, total) {
          const pct = total > 0 ? Math.round((done / total) * 100) : 0;
          return `
      <div class="bar" title="${pct}%"><span style="width:${pct}%"></span></div>
      <div class="muted">${done}/${total}</div>
    `;
        }
        function computeDone(e) {
          const t = e.totais || {};
          return (t.enviados || 0) + (t.erros || 0) + (t.cancelados || 0);
        }
        function statusBadge(s) {
          switch (s) {
            case "agendado": return fmtBadge("Agendado");
            case "em_andamento": return fmtBadge("Em andamento", "warn");
            case "pausado": return fmtBadge("Pausado", "warn");
            case "concluido": return fmtBadge("Conclu√≠do", "ok");
            case "cancelado": return fmtBadge("Cancelado", "err");
            default: return fmtBadge(s || "‚Äî");
          }
        }
        function renderTotals(list) {
          const box = document.getElementById("agTotals");
          if (!list.length) { box.innerHTML = `<div class="col-12 muted">Nenhum agendamento.</div>`; return; }
          const acc = { total: 0, agendado: 0, em_andamento: 0, pausado: 0, concluido: 0, cancelado: 0 };
          list.forEach(e => { acc.total++; acc[e.status_geral] = (acc[e.status_geral] || 0) + 1; });
          box.innerHTML = `
      <div class="col-12" style="display:flex;gap:10px;flex-wrap:wrap">
        <span class="muted">Total: <b>${acc.total}</b></span>
        ${fmtBadge(`Agendados: ${acc.agendado}`)}
        ${fmtBadge(`Em andamento: ${acc.em_andamento}`, "warn")}
        ${fmtBadge(`Pausados: ${acc.pausado}`, "warn")}
        ${fmtBadge(`Conclu√≠dos: ${acc.concluido}`, "ok")}
        ${fmtBadge(`Cancelados: ${acc.cancelado}`, "err")}
      </div>
    `;
        }

        // ==== Filtros + Pagina√ß√£o ====
        function applyFilters() {
          const q = (document.getElementById("filtroBusca").value || "").toLowerCase();
          const modo = document.getElementById("filtroModo").value;
          const stat = document.getElementById("filtroStatus").value;

          agFiltered = agRaw.filter(e => {
            const nameHit = (e.nome_disparo || "").toLowerCase().includes(q) || (e.grupo_trabalho || "").toLowerCase().includes(q);
            const modoHit = !modo || e.modo_envio === modo;
            const statHit = !stat || e.status_geral === stat;
            return nameHit && modoHit && statHit;
          });

          agPage = 1;
          renderTable();
        }
        function pageSlice() {
          const start = (agPage - 1) * PAGE_SIZE;
          return agFiltered.slice(start, start + PAGE_SIZE);
        }
        function renderPagination() {
          const totalPages = Math.max(1, Math.ceil(agFiltered.length / PAGE_SIZE));
          document.getElementById("agPageInfo").textContent = `P√°gina ${agPage}/${totalPages}`;
          document.getElementById("agPrev").disabled = agPage <= 1;
          document.getElementById("agNext").disabled = agPage >= totalPages;
        }
        document.getElementById("agPrev").addEventListener("click", () => { if (agPage > 1) { agPage--; renderTable(); } });
        document.getElementById("agNext").addEventListener("click", () => {
          const totalPages = Math.max(1, Math.ceil(agFiltered.length / PAGE_SIZE));
          if (agPage < totalPages) { agPage++; renderTable(); }
        });

        // ==== Render da Tabela ====
        function renderTable() {
          const tbody = document.getElementById("tbodyAgendamentos");
          tbody.innerHTML = "";
          renderTotals(agFiltered);

          const rows = pageSlice();
          if (!rows.length) {
            tbody.innerHTML = `<tr><td colspan="7" class="muted">Nenhum agendamento com os filtros atuais.</td></tr>`;
            renderPagination();
            return;
          }

          rows.forEach(e => {
            const total = e.totais?.total || 0;
            const done = computeDone(e);
            const prog = progressBar(done, total);

            const buttons = [];
            buttons.push(`<button title="Editar" onclick="editarEnvio(${e.id})">‚úèÔ∏è</button>`);
            buttons.push(`<button title="Excluir" onclick="excluirEnvio(${e.id})">üóëÔ∏è</button>`);
            if (e.status_geral === "agendado" || e.status_geral === "em_andamento") {
              buttons.push(`<button title="Pausar" onclick="pausarEnvio(${e.id})">‚è∏Ô∏è</button>`);
            }
            if (e.status_geral === "pausado") {
              buttons.push(`<button title="Retomar" onclick="retomarEnvio(${e.id})">‚ñ∂Ô∏è</button>`);
            }
            if (e.status_geral !== "concluido" && e.status_geral !== "cancelado") {
              buttons.push(`<button title="Cancelar" onclick="cancelarEnvio(${e.id})">üõë</button>`);
            }

            const modoBadge = e.modo_envio === "agendar" ? fmtBadge("Agendado") : fmtBadge("Imediato", "ok");

            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td><b>${e.nome_disparo || "-"}</b></td>
        <td>${e.grupo_trabalho || "-"}</td>
        <td>${fmtDateTime(e.data_hora_agendamento)}</td>
        <td>${modoBadge}</td>
        <td>${prog}</td>
        <td>${statusBadge(e.status_geral)}</td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">${buttons.join("")}</td>
      `;
            tbody.appendChild(tr);
          });

          renderPagination();
        }

        // ==== Carregar da API ====
        async function carregarAgendamentos(force = false) {
          const tbody = document.getElementById("tbodyAgendamentos");
          if (force) { tbody.innerHTML = `<tr><td colspan="7" class="muted">‚è≥ Buscando...</td></tr>`; }
          try {
            const params = new URLSearchParams();
            const modo = document.getElementById("filtroModo").value;
            const stat = document.getElementById("filtroStatus").value;
            if (modo) params.set("modo_envio", modo);
            if (stat) params.set("status", stat);

            const res = await fetch(`${API_BASE}/api/envios?${params.toString()}`);
            const data = await res.json();

            agRaw = Array.isArray(data) ? data : [];
            applyFilters();
          } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="7" class="muted">Erro ao carregar agendamentos</td></tr>`;
          }
        }

        // ==== Listeners de filtro e atualizar ====
        document.getElementById("filtroBusca").addEventListener("input", () => applyFilters());
        document.getElementById("filtroModo").addEventListener("change", () => carregarAgendamentos(true));
        document.getElementById("filtroStatus").addEventListener("change", () => carregarAgendamentos(true));
        document.getElementById("btnAtualizarAg").addEventListener("click", () => carregarAgendamentos(true));

        // ==== Modal de edi√ß√£o ====
        const modal = document.getElementById("agModal");
        let editingId = null;

        function openModal(envio) {
          editingId = envio.id;
          document.getElementById("mNome").value = envio.nome_disparo || "";
          document.getElementById("mGrupo").value = envio.grupo_trabalho || ""
          document.getElementById("mModo").value = envio.modo_envio || "imediato";
          document.getElementById("mDataHora").value = envio.data_hora_agendamento ? toLocalISO(envio.data_hora_agendamento) : "";
          document.getElementById("mTam").value = envio.tamanho_lote ?? "";
          document.getElementById("mIntLote").value = envio.intervalo_lote ?? "";
          document.getElementById("mIntMsg").value = envio.intervalo_msg ?? "";
          toggleModalDate();
          modal.classList.add("open");
        }
        function closeModal() { modal.classList.remove("open"); editingId = null; }
        modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
        });

        function toggleModalDate() {
          const wrap = document.getElementById("mDataWrap");
          wrap.classList.toggle("hide", document.getElementById("mModo").value !== "agendar");
        }
        document.getElementById("mModo").addEventListener("change", toggleModalDate);
        document.getElementById("mCancelar").addEventListener("click", closeModal);

        document.getElementById("mSalvar").addEventListener("click", async () => {
          if (!editingId) return;
          const body = {
            nome_disparo: document.getElementById("mNome").value.trim(),
            grupo_trabalho: document.getElementById("mGrupo").value.trim(),
            modo_envio: document.getElementById("mModo").value,
            data_hora_agendamento: document.getElementById("mModo").value === "agendar" ? document.getElementById("mDataHora").value : null,
            tamanho_lote: Number(document.getElementById("mTam").value || 0) || null,
            intervalo_lote: Number(document.getElementById("mIntLote").value || 0) || null,
            intervalo_msg: Number(document.getElementById("mIntMsg").value || 0) || null,
          };
          try {
            const res = await fetch(`${API_BASE}/api/envios/${editingId}`, {
              method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
            });
            const j = await res.json();
            if (!res.ok || j?.ok === false) { alert(j?.erro || "Erro ao salvar"); return; }
            closeModal();
            await carregarAgendamentos(true);
          } catch (e) {
            alert("Erro ao salvar edi√ß√£o");
            console.error(e);
          }
        });

        // ==== A√ß√µes globais ====
        window.editarEnvio = (id) => {
          const e = agRaw.find(x => x.id === id);
          if (!e) { alert("Envio n√£o encontrado"); return; }
          openModal(e);
        };
        window.excluirEnvio = async (id) => {
          if (!confirm("Excluir este envio? Essa a√ß√£o √© irrevers√≠vel.")) return;
          try {
            const res = await fetch(`${API_BASE}/api/envios/${id}`, { method: "DELETE" });
            const j = await res.json();
            if (!res.ok || j?.ok === false) { alert(j?.erro || "Erro ao excluir"); return; }
            await carregarAgendamentos(true);
          } catch (e) {
            alert("Erro ao excluir");
            console.error(e);
          }
        };
        window.pausarEnvio = async (id) => {
          if (!confirm("Pausar envio? Itens pendentes ir√£o para 'pausado'.")) return;
          try {
            const res = await fetch(`${API_BASE}/api/envios/${id}/pause`, { method: "PATCH" });
            const j = await res.json();
            if (!res.ok || j?.ok === false) { alert(j?.erro || "Erro ao pausar"); return; }
            await carregarAgendamentos(true);
          } catch (e) {
            alert("Erro ao pausar");
            console.error(e);
          }
        };
        window.retomarEnvio = async (id) => {
          try {
            const res = await fetch(`${API_BASE}/api/envios/${id}/resume`, { method: "PATCH" });
            const j = await res.json();
            if (!res.ok || j?.ok === false) { alert(j?.erro || "Erro ao retomar"); return; }
            await carregarAgendamentos(true);
          } catch (e) {
            alert("Erro ao retomar");
            console.error(e);
          }
        };
        window.cancelarEnvio = async (id) => {
          if (!confirm("Cancelar envio? Pendentes/pausados ser√£o marcados como 'cancelado'.")) return;
          try {
            const res = await fetch(`${API_BASE}/api/envios/${id}/cancel`, { method: "PATCH" });
            const j = await res.json();
            if (!res.ok || j?.ok === false) { alert(j?.erro || "Erro ao cancelar"); return; }
            await carregarAgendamentos(true);
          } catch (e) {
            alert("Erro ao cancelar");
            console.error(e);
          }
        };

        // Auto-refresh leve a cada 30s quando a aba estiver ativa
        let agInterval = null;
        function startAgAutoRefresh() {
          stopAgAutoRefresh();
          agInterval = setInterval(() => {
            const isActive = document.querySelector('.tab-btn.active')?.dataset?.tab === 'agendamentos';
            if (isActive) carregarAgendamentos();
          }, 30000);
        }
        function stopAgAutoRefresh() { if (agInterval) clearInterval(agInterval); }
        startAgAutoRefresh();

        // Primeira carga se a aba j√° estiver ativa
        if (document.querySelector('.tab-btn.active')?.dataset?.tab === 'agendamentos') {
          carregarAgendamentos(true);
        }
      </script>

      <!-- Script da aba Envio Individual -->
      <script>
        // Estado da aba individual
        let tmpl_ind = {
          name: "",
          category: "",
          components: [],
          bodyText: "",
          bodyVars: 0,
          headerType: null,
          headerText: "",
          headerVars: 0,
          urlButtons: []
        };
        let contatoSelecionado_ind = null; // { to, vars: [PrimeiroNome, prioridade, ...] }

        function logInd(msg) {
          const out = document.getElementById('output_ind');
          out.textContent += (out.textContent ? "\n" : "") + msg;
          out.scrollTop = out.scrollHeight;
        }

        // Atualiza WABA/phone na aba individual
        document.getElementById("contaSelect_ind").addEventListener("change", function () {
          const contaKey = this.value;
          const conta = (typeof contas !== "undefined") ? contas[contaKey] : null;
          document.getElementById("phoneId_ind").value = conta?.phone || "";
          document.getElementById("wabaId_ind").value = conta?.waba || "";
        });

        // Buscar templates (individual)
        async function buscarTemplatesIndividual() {
          const token = document.getElementById('token_ind').value.trim();
          const wabaId = document.getElementById('wabaId_ind').value.trim();
          const ver = document.getElementById('graphVersion_ind').value;
          if (!token || !wabaId) {
            alert('Informe token e WABA ID na aba Envio individual.');
            return;
          }

          const select = document.getElementById('templateSelect_ind');
          select.innerHTML = '<option value="">Carregando...</option>';

          const urlBase = `https://graph.facebook.com/${ver}/${encodeURIComponent(wabaId)}/message_templates?limit=100&status=APPROVED`;
          const all = [];
          let next = urlBase;
          try {
            while (next) {
              const r = await fetch(next, { headers: { Authorization: `Bearer ${token}` } });
              const j = await r.json();
              if (Array.isArray(j.data)) all.push(...j.data);
              next = j?.paging?.next || null;
            }
          } catch (e) {
            alert('Erro ao buscar templates: ' + e.message);
            select.innerHTML = '<option value="">-- Erro ao buscar --</option>';
            return;
          }

          if (all.length === 0) {
            select.innerHTML = '<option value="">-- Nenhum template aprovado encontrado --</option>';
            return;
          }

          select.innerHTML = '<option value="">-- Selecione um template --</option>';
          all.sort((a, b) => a.name.localeCompare(b.name)).forEach(t => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify(t);
            opt.textContent = `${t.name} ¬∑ ${t.category}`;
            select.appendChild(opt);
          });
        }
        document.getElementById('btnBuscar_ind').addEventListener('click', buscarTemplatesIndividual);

        function preencherTemplateInfoIndividual() {
          const val = document.getElementById('templateSelect_ind').value;
          if (!val) return;
          const t = JSON.parse(val);

          tmpl_ind.name = t.name;
          tmpl_ind.category = t.category || '';
          tmpl_ind.components = t.components || [];
          document.getElementById('templateName_ind').value = tmpl_ind.name;
          document.getElementById('templateCategory_ind').value = tmpl_ind.category || '';

          const header = tmpl_ind.components.find(c => c.type === 'HEADER');
          const body = tmpl_ind.components.find(c => c.type === 'BODY');
          const buttons = tmpl_ind.components.find(c => c.type === 'BUTTONS');

          tmpl_ind.headerType = null;
          tmpl_ind.headerText = '';
          tmpl_ind.headerVars = 0;
          document.getElementById('headerFormat_ind').value = '';
          document.getElementById('mediaLinkWrap_ind').classList.add('hide');

          if (typeof countPlaceholders !== "function") {
            console.warn("countPlaceholders n√£o est√° dispon√≠vel no escopo global.");
          }

          if (header) {
            const fmt = header.format;
            tmpl_ind.headerType = fmt;
            document.getElementById('headerFormat_ind').value = fmt || '';
            if (fmt === 'TEXT') {
              tmpl_ind.headerText = header.text || '';
              tmpl_ind.headerVars = typeof countPlaceholders === "function" ? countPlaceholders(tmpl_ind.headerText) : 0;
            } else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(fmt)) {
              document.getElementById('mediaLinkWrap_ind').classList.remove('hide');
            }
          }

          tmpl_ind.bodyText = body?.text || '';
          tmpl_ind.bodyVars = typeof countPlaceholders === "function" ? countPlaceholders(tmpl_ind.bodyText) : 0;

          tmpl_ind.urlButtons = [];
          if (buttons && Array.isArray(buttons.buttons)) {
            buttons.buttons.forEach((b, idx) => {
              if (b.type === 'URL') {
                const hasVar = (b.url || '').includes('{{');
                tmpl_ind.urlButtons.push({ index: idx, url: b.url || '', hasVar });
              }
            });
          }

          atualizarPreviewIndividual();
        }
        document.getElementById('templateSelect_ind').addEventListener('change', preencherTemplateInfoIndividual);

        function buildVarsIndividual() {
          if (!contatoSelecionado_ind) return [];
          const nome = contatoSelecionado_ind.vars[0] || "";
          const prioridade = contatoSelecionado_ind.vars[1] || "";
          const total = Math.max(tmpl_ind.bodyVars || 0, tmpl_ind.headerVars || 0, 1);
          const vars = [];
          for (let i = 1; i <= total; i++) {
            if (i === 1) vars.push(nome);
            else if (i === 2) vars.push(prioridade);
            else vars.push('');
          }
          return vars;
        }

        function atualizarPreviewIndividual() {
          const prev = document.getElementById('previewArea_ind');
          if (!tmpl_ind.name) {
            prev.textContent = "Selecione um template.";
            return;
          }

          const bodyText = tmpl_ind.bodyText || "";
          let bodyPreview = bodyText;

          if (typeof substitutePlaceholders === "function" && tmpl_ind.bodyVars > 0 && contatoSelecionado_ind) {
            const vars = buildVarsIndividual();
            bodyPreview = substitutePlaceholders(bodyText, vars);
          }

          let headerPreview = "";
          if (tmpl_ind.headerType === "TEXT" && tmpl_ind.headerText && typeof substitutePlaceholders === "function") {
            const vars = buildVarsIndividual();
            headerPreview = substitutePlaceholders(tmpl_ind.headerText, vars);
          }

          const partes = [];
          partes.push("üìÑ Pr√©-visualiza√ß√£o (envio individual):");
          if (headerPreview) partes.push(`*${headerPreview}*`);
          partes.push(bodyPreview || "(sem corpo)");

          if (contatoSelecionado_ind) {
            partes.push("");
            partes.push(`üì≤ Enviando para: ${contatoSelecionado_ind.to}`);
          }

          prev.textContent = partes.join("\n\n");
        }

        // Pesquisa individual por c√≥digo
        async function pesquisarCadastroIndividual() {
          const base = document.getElementById('baseSelect_ind').value;
          const codigo = (document.getElementById('codigo_ind').value || "").trim();
          const box = document.getElementById('resultadoPesquisa_ind');

          if (!base || !codigo) {
            alert("Informe a base e o c√≥digo do cliente.");
            return;
          }

          // Preenche nome do disparo automaticamente com o c√≥digo informado
          document.getElementById('nomeDisparo_ind').value = codigo;
          document.getElementById('grupoTrabalho_ind').value = "Envio individual";

          box.textContent = "‚è≥ Buscando cadastro...";
          try {
            const url = `${ESTRAT_API}/api/estrategias/pesquisa/${encodeURIComponent(base)}/${encodeURIComponent(codigo)}`;
            const res = await fetch(url, {
              method: "GET",
              mode: "cors",
              credentials: "omit",
              cache: "no-store"
            });
            if (!res.ok) {
              const msg = await res.text();
              throw new Error(`Falha ao buscar cadastro (${res.status}): ${msg}`);
            }
            const data = await res.json();
            const rows = Array.isArray(data)
              ? data
              : (Array.isArray(data?.dados) ? data.dados : []);

            if (!rows.length) {
              box.textContent = "Nenhum telefone encontrado para esse c√≥digo.";
              contatoSelecionado_ind = null;
              document.getElementById('telefoneEscolhido_ind').textContent = "Nenhum telefone selecionado.";
              atualizarPreviewIndividual();
              return;
            }

            // Normaliza dados TELEFONE / PrimeiroNome / prioridade
            const registros = rows.map(r => {
              const tel = String(r?.TELEFONE || r?.telefone || "").replace(/\D+/g, "");
              const nome = (r?.PrimeiroNome || r?.primeiroNome || r?.NOME || "").toString();
              const prioRaw = r?.prioridade ?? 1;
              const prio = parseInt(prioRaw, 10) || 1;
              return { TELEFONE: tel, PrimeiroNome: nome, prioridade: prio };
            }).filter(r => r.TELEFONE);

            if (!registros.length) {
              box.textContent = "Nenhum telefone v√°lido encontrado para esse c√≥digo.";
              contatoSelecionado_ind = null;
              document.getElementById('telefoneEscolhido_ind').textContent = "Nenhum telefone selecionado.";
              atualizarPreviewIndividual();
              return;
            }

            let html = `
              <table>
                <thead>
                  <tr>
                    <th>Telefone</th>
                    <th>Nome</th>
                    <th>Prioridade</th>
                    <th>A√ß√£o</th>
                  </tr>
                </thead>
                <tbody>
            `;
            registros.forEach((r, idx) => {
              html += `
                <tr>
                  <td>${r.TELEFONE}</td>
                  <td>${r.PrimeiroNome || "-"}</td>
                  <td>${r.prioridade}</td>
                  <td><button onclick="window.usarTelefoneIndividual(${idx})">Usar este telefone</button></td>
                </tr>
              `;
            });
            html += "</tbody></table>";
            box.innerHTML = html;

            // Guarda em window para uso pelo handler
            window._registrosIndividual = registros;
          } catch (e) {
            console.error(e);
            box.textContent = "‚ùå Erro ao buscar cadastro: " + e.message;
            contatoSelecionado_ind = null;
            document.getElementById('telefoneEscolhido_ind').textContent = "Nenhum telefone selecionado.";
            atualizarPreviewIndividual();
          }
        }
        document.getElementById('btnPesquisar_ind').addEventListener('click', pesquisarCadastroIndividual);

        // Handler global para "Usar este telefone"
        window.usarTelefoneIndividual = function (idx) {
          const regs = window._registrosIndividual || [];
          const r = regs[idx];
          if (!r) return;
          const tel = r.TELEFONE;
          const nome = r.PrimeiroNome || "";
          const prio = r.prioridade || 1;

          // Monta vars: [PrimeiroNome, prioridade]
          const vars = [nome, String(prio)];
          contatoSelecionado_ind = {
            to: tel,
            vars: vars
          };

          document.getElementById('telefoneEscolhido_ind').textContent =
            `Telefone selecionado: ${tel} ‚Äî ${nome || "Sem nome"} (prioridade ${prio})`;

          atualizarPreviewIndividual();
        };

        // Modo de envio (mostrar/ocultar data/hora)
        document.getElementById('modoEnvio_ind').addEventListener('change', () => {
          const isAgendar = document.getElementById('modoEnvio_ind').value === 'agendar';
          document.getElementById('dataHoraWrap_ind').classList.toggle('hide', !isAgendar);
        });

        // Envio individual via backend (mesmo endpoint /api/envios)
        async function enviarIndividual() {
          if (!contatoSelecionado_ind) {
            alert("Selecione um telefone para envio.");
            return;
          }
          if (!tmpl_ind.name) {
            alert("Selecione um template para envio.");
            return;
          }

          const token = (document.getElementById("token_ind").value || "").trim();
          const phoneId = (document.getElementById("phoneId_ind").value || "").trim();
          const wabaId = (document.getElementById("wabaId_ind").value || "").trim();
          const nomeDisparo = (document.getElementById("nomeDisparo_ind").value || "").trim() || "Envio individual";
          const grupoTrabalho = "Envio individual";
          const modoEnvio = document.getElementById("modoEnvio_ind").value;
          const dh = document.getElementById("dataHoraEnvio_ind").value || null;
          const mediaLink = (document.getElementById("mediaLink_ind").value || "").trim();

          if (!token || !phoneId || !wabaId) {
            alert("Preencha token, conta, WABA e phone_id na aba individual.");
            return;
          }

          // Garante que vars tenham tamanho suficiente para body/header
          const vars = buildVarsIndividual();
          // Monta conteudo como CSV (alinhado com worker de envios)
          const conteudo = vars.join(",");

          // Mapeamento simples: var N -> coluna N
          const maxVars = vars.length;
          const mapBody = Array.from({ length: tmpl_ind.bodyVars || 0 }, (_, i) => i);
          const mapHeader = Array.from({ length: tmpl_ind.headerVars || 0 }, (_, i) => i);

          const mapping_ind = {
            body: mapBody,
            headerText: mapHeader,
            urlButtons: {}
          };

          const payload = {
            token: token,
            phone_id: phoneId,
            waba_id: wabaId,
            nome_disparo: nomeDisparo,
            grupo_trabalho: grupoTrabalho,
            modo_envio: modoEnvio,
            data_hora_agendamento: modoEnvio === "agendar" ? dh : null,
            intervalo_msg: 0,
            tamanho_lote: 0,
            intervalo_lote: 0,
            template: {
              name: tmpl_ind.name,
              language: "pt_BR",
              headerType: tmpl_ind.headerType,
              bodyText: tmpl_ind.bodyText,
              bodyVars: tmpl_ind.bodyVars,
              headerVars: tmpl_ind.headerVars,
              urlButtons: tmpl_ind.urlButtons,
              mapping: mapping_ind,
              mediaLink: mediaLink
            },
            contatos: [
              {
                telefone: contatoSelecionado_ind.to,
                conteudo: conteudo
              }
            ]
          };

          try {
            const res = await fetch(`${API_BASE}/api/envios`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.ok) {
              logInd(`‚úîÔ∏è Envio individual cadastrado com sucesso (ID ${data.id}) para ${contatoSelecionado_ind.to}.`);
            } else {
              logInd("‚ùå Erro ao salvar envio individual: " + (data.erro || JSON.stringify(data)));
            }
          } catch (e) {
            logInd("‚ùå Falha de rede ao salvar envio individual: " + e.message);
          }
        }
        document.getElementById("btnEnviar_ind").addEventListener("click", enviarIndividual);
      </script>
</body>

</html>
