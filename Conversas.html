<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversas WhatsApp ‚Äî Supervisor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ========= Bolhas de mensagem (ajustadas) ========= */
    .msg {
      display: inline-block;
      max-width: min(70%, 560px);
      padding: 10px 14px 18px;
      margin: 6px 0;
      position: relative;
      border-radius: 18px;
      word-break: break-word;
      overflow-wrap: anywhere;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .10);
      transition: background .18s ease;
    }

    @media (max-width: 768px) {
      .msg {
        max-width: 86%;
      }
    }

    .msg.enviada {
      align-self: flex-end;
      background: linear-gradient(120deg, var(--bubble-out-g1, #dcf8c6), var(--bubble-out-g2, #b8f0a4));
      color: #111827;
    }

    .msg.recebida {
      align-self: flex-start;
      background: var(--bubble-in-bg, #fff);
      border: 1px solid var(--bubble-in-border, #e2e8f0);
    }

    .msg .hora {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    /* Caudas dos bal√µes */
    .msg.enviada::after,
    .msg.recebida::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 14px;
      height: 14px;
      clip-path: polygon(0 0, 100% 0, 0 100%);
    }

    .msg.enviada::after {
      right: -7px;
      background: linear-gradient(120deg, var(--bubble-out-g1, #dcf8c6), var(--bubble-out-g2, #b8f0a4));
    }

    .msg.recebida::after {
      left: -7px;
      background: var(--bubble-in-bg, #fff);
      border-left: 1px solid var(--bubble-in-border, #e2e8f0);
      border-bottom: 1px solid var(--bubble-in-border, #e2e8f0);
    }

    /* A√ß√µes dentro do bal√£o */
    .msg .actions {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }

    .msg:hover .actions,
    .msg:focus-within .actions {
      opacity: 1;
      pointer-events: auto;
    }

    .icon-btn {
      font-size: 14px;
      color: #64748b;
      cursor: pointer;
    }

    .icon-btn:hover {
      color: #2563eb;
    }

    /* M√≠dia */
    .msg img.thumb {
      max-width: 280px;
      height: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
    }

    /* ========= Cart√µes de sistema ========= */
    .msg.system {
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      color: #0f172a;
    }

    .msg.system::after {
      display: none;
    }

    .sys-title {
      font-weight: 700;
      font-size: .9rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .sys-body {
      font-size: .9rem;
      color: #334155;
    }

    .sys-meta {
      font-size: .75rem;
      color: #64748b;
    }

    .sys-pill {
      display: inline-block;
      font-size: .7rem;
      font-weight: 700;
      padding: .1rem .4rem;
      border-radius: 9999px;
      background: #eef2ff;
      color: #3730a3;
    }

    /* Extras */
    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: #888;
    }

    .contato-selected {
      background: #f0f9ff !important;
    }

    mark {
      background: #ffef6b;
      color: #000;
      padding: 0 2px;
      border-radius: 2px;
    }

    #digitando {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    /* Bloco de filtros compacto */
    .filter-card {
      border: 1px solid #e2e8f0;
      border-radius: .75rem;
      background: #fff;
    }

    .filter-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .6rem .8rem;
      font-weight: 700;
      color: #334155;
    }

    .chip-btn {
      padding: .4rem .7rem;
      font-size: .8rem;
      border-radius: .6rem;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #334155;
      font-weight: 600;
    }

    .chip-btn.active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }

    @media (max-width: 768px) {
      aside {
        width: 42%;
      }
    }

    /* Acessibilidade */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body class="h-screen flex bg-gray-100">

  <!-- =========== SIDEBAR =========== -->
  <aside id="sidebar" class="w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
    <!-- Filtros -->
    <div class="p-3 border-b">
      <div class="filter-card">
        <div class="filter-title">
          <span class="summary-label">
            <span>Filtros</span>
            <span id="fltResumo" class="text-xs font-normal text-slate-500"></span>
          </span>
        </div>

        <div class="p-3 space-y-3">
          <div class="space-y-1">
            <label class="text-xs text-gray-500 font-medium">Carteira</label>
            <select id="filtroConta" class="w-full p-2 border rounded-md text-sm">
              <option value="">‚Äî selecione ‚Äî</option>
              <option value="*">Todas as contas</option>
              <option value="789025174304270">ConnectZap</option>
              <option value="805610009301153">Banco PAN</option>
              <option value="727586317113885">Recovery PJ</option>
              <option value="802977069563598">Recovery PF</option>
              <option value="938298879357445">Recovery Preventivo</option>
              <option value="897647883433681">Recovery Manuten√ß√£o</option>
              <option value="821562937700669">Mercado Pago Cobran√ßa</option>
              <option value="779797401888141">DivZero P2</option>
              <option value="922259637643727">DivZero LP</option>
              <option value="829210283602406">Arc4U</option>
              <option value="905309685992125">Arc4U Veiculos</option>
              <option value="713021321904495">Serasa</option>
              <option value="803535039503723">Mercado Pago Vendas</option>
            </select>
          </div>

          <div class="space-y-2">
            <div class="text-xs text-gray-500 font-medium">Ordena√ß√£o</div>
            <div class="flex flex-wrap gap-2">
              <button class="chip-btn" data-sort="desc">Mais recentes primeiro</button>
              <button class="chip-btn" data-sort="asc">Mais antigos primeiro</button>
            </div>
            <div class="flex gap-2">
              <button id="btnAtualizar"
                class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Atualizar
                fila</button>
              <input id="searchInput" type="text" placeholder="üîç filtrar na lista..."
                class="flex-1 p-2 rounded-md border text-sm" autocomplete="off" />
            </div>
          </div>

          <div id="hintFiltro" class="text-xs text-gray-500 bg-slate-50 border border-dashed rounded-md p-2">
            Selecione a <b>carteira</b>, escolha a <b>ordena√ß√£o</b> e clique em <b>Atualizar fila</b>. Mostrando sempre
            os <b>√∫ltimos 2 dias</b>.
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de contatos -->
    <ul id="contatos" class="flex-1 overflow-y-auto"></ul>

    <div class="p-2 text-xs text-gray-500 border-t">
      A lista <b>n√£o</b> atualiza automaticamente. Use ‚ÄúAtualizar fila‚Äù.
    </div>
  </aside>

  <!-- =========== MAIN CHAT =========== -->
  <main class="flex-1 flex flex-col">
    <div class="flex items-center justify-between p-3 border-b bg-white space-x-2">
      <div class="flex items-center space-x-3 min-w-0">
        <h2 id="tituloConversa" class="font-bold text-lg truncate">Selecione uma conversa</h2>
        <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
      </div>
      <div id="rangeResumo" class="text-xs text-gray-500"></div>
    </div>

    <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-1 bg-gray-50">
      <p id="loading" class="text-center text-gray-500">Selecione um contato para ver as mensagens...</p>
    </div>
    <div id="digitando" class="px-4 text-left hidden">Digitando...</div>

    <div id="respostaPreview" class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
      <div class="truncate max-w-[80%]">
        <span class="font-semibold">Respondendo:</span>
        <span id="respostaTexto" class="text-gray-600"></span>
      </div>
      <button onclick="cancelarResposta()" class="text-red-500 text-xs">‚úñ</button>
    </div>

    <div class="p-3 border-t flex space-x-2 bg-white items-center">
      <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
      <button onclick="document.getElementById('fileInput').click()"
        class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600">üìù PDF</button>

      <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none"
        placeholder="Digite uma mensagem..." disabled></textarea>
      <button id="btnEnviar" onclick="enviarMensagem()"
        class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 disabled:opacity-50"
        disabled>Enviar</button>
    </div>
  </main>

  <!-- Modal de imagem -->
  <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
    <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer">&times;</span>
    <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
  </div>

  <script>
    /* ======= Config/estado ======= */
    const API_BASE = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/, '');
    const phoneIdMap = {
      "789025174304270": "ConnectZap",
      "805610009301153": "Banco PAN",
      "727586317113885": "Recovery PJ",
      "802977069563598": "Recovery PF",
      "938298879357445": "Recovery Preventivo",
      "897647883433681": "Recovery Manuten√ß√£o",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero_P2",
      "922259637643727": "DivZero_LP",
      "829210283602406": "Arc4U",
      "905309685992125": "Arc4U Veiculos",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };

    let contatoSelecionado = null, phoneIdAtual = null;
    let respostaMsgId = null;
    let userTyping = false, isModalOpen = false;
    let sortOrder = "desc"; // 'desc' (mais recentes) | 'asc' (mais antigos)

    /* Mensagens render state */
    let lastTimestampMs = null;
    let lastDayRendered = null;
    let renderedKeys = new Set();

    /* ======= Documento: constantes ======= */
    const DOC_PREVIEW_MAX = 2 * 1024 * 1024; // 2MB para preview embutido de PDF

    // refs
    const textarea = document.getElementById("textoMensagem");
    const btnEnviar = document.getElementById("btnEnviar");
    const digitando = document.getElementById("digitando");
    const contatosUL = document.getElementById("contatos");
    const filtroContaEl = document.getElementById("filtroConta");
    const btnAtualizar = document.getElementById("btnAtualizar");
    const searchInput = document.getElementById("searchInput");
    const hintFiltro = document.getElementById("hintFiltro");
    const fltResumoEl = document.getElementById("fltResumo");
    const rangeResumo = document.getElementById("rangeResumo");
    const sortBtns = [...document.querySelectorAll(".chip-btn[data-sort]")];

    /* ======= UX da textarea ======= */
    textarea.addEventListener("input", () => {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
      btnEnviar.disabled = textarea.value.trim().length === 0;
      digitando.style.display = textarea.value.trim() ? "block" : "none";
    });
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); if (!btnEnviar.disabled) enviarMensagem(); }
    });

    /* ======= Ordena√ß√£o ======= */
    function setSort(order) {
      sortOrder = (order === "asc") ? "asc" : "desc";
      sortBtns.forEach(b => b.classList.toggle("active", b.dataset.sort === sortOrder));
    }
    sortBtns.forEach(btn => btn.addEventListener("click", () => { setSort(btn.dataset.sort); }));

    /* ======= Helpers ======= */
    function pad(n) { return String(n).padStart(2, "0"); }
    function toYMD(d) { return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`; }
    function gerarCor(nome) { let hash = 0; for (let i = 0; i < String(nome || 'U').length; i++) { hash = String(nome || 'U').charCodeAt(i) + ((hash << 5) - hash); } return `hsl(${hash % 360},70%,60%)`; }
    function escapeHtml(s) { if (!s) return ""; return s.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])); }
    function isIncoming(m) {
      const s = (m.status || "").toLowerCase();
      if (typeof m.from_me === "boolean") return !m.from_me;
      if (m.direction) return String(m.direction).toLowerCase().startsWith("in");
      if (["in", "received", "incoming"].includes(s)) return true;
      if (["out", "sent", "delivered", "read", "outgoing"].includes(s)) return false;
      return s === "in";
    }
    function bytesToHuman(n) { if (!n && n !== 0) return ""; const u = ["B", "KB", "MB", "GB", "TB"]; let i = 0, s = n; while (s >= 1024 && i < u.length - 1) { s /= 1024; i++; } return `${s.toFixed(s >= 10 || i === 0 ? 0 : 1)} ${u[i]}`; }
    function isWithinLastTwoDays(iso) {
      const d = new Date(iso);
      const today = new Date();
      const yesterday = new Date(); yesterday.setDate(today.getDate() - 1);
      return d.toDateString() === today.toDateString() || d.toDateString() === yesterday.toDateString();
    }
    function updateResumoLabels() {
      const today = new Date();
      const yesterday = new Date(); yesterday.setDate(today.getDate() - 1);
      fltResumoEl.textContent = `(carteira: ${filtroContaEl.value ? (filtroContaEl.value === "*" ? "todas" : "selecionada") : "‚Äî"} ‚Ä¢ √∫ltimos 2 dias: ${toYMD(yesterday)} ‚Üí ${toYMD(today)})`;
      rangeResumo.textContent = `(√öLTIMOS 2 DIAS ‚Ä¢ ${toYMD(yesterday)} ‚Üí ${toYMD(today)})`;
    }
    updateResumoLabels();

    /* ======= Contatos: busca local ======= */
    searchInput.addEventListener("input", () => filtrarContatos(searchInput.value));
    function filtrarContatos(q) {
      q = (q || "").toLowerCase().trim();
      document.querySelectorAll("#contatos li").forEach(li => {
        const hay = (li.dataset.search || li.textContent).toLowerCase();
        li.style.display = hay.includes(q) ? "flex" : "none";
      });
    }

    /* ======= Carregar contatos (manual) ======= */
    btnAtualizar.addEventListener("click", carregarContatos);

    async function carregarContatos() {
      if (!filtroContaEl.value) { alert("Selecione uma carteira (ou 'Todas as contas')."); return; }
      contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Carregando‚Ä¶</li>`;
      try {
        const r = await fetch(`${API_BASE}/api/conversas/contatos`, { cache: "no-store" });
        if (!r.ok) throw new Error("Falha ao buscar contatos");
        let itens = await r.json();

        // filtra carteira
        const carteirafiltro = filtroContaEl.value;
        if (carteirafiltro && carteirafiltro !== "*") {
          itens = itens.filter(c => String(c.phone_id) === String(carteirafiltro));
        }

        // filtra √∫ltimos 2 dias (hoje e ontem)
        itens = itens.filter(c => c.data_hora && isWithinLastTwoDays(c.data_hora));

        // ordena√ß√£o
        itens.sort((a, b) => {
          const da = new Date(a.data_hora).getTime();
          const db = new Date(b.data_hora).getTime();
          return sortOrder === "asc" ? (da - db) : (db - da);
        });

        renderContatos(itens);
        hintFiltro.classList.add("hidden");
        updateResumoLabels();
      } catch (e) {
        console.error(e);
        contatosUL.innerHTML = `<li class="p-3 text-sm text-red-600">Erro ao carregar contatos.</li>`;
      }
    }

    function renderContatos(lista) {
      contatosUL.innerHTML = "";
      if (!Array.isArray(lista) || !lista.length) {
        contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Nenhum contato nos √∫ltimos 2 dias.</li>`;
        return;
      }
      const frag = document.createDocumentFragment();
      lista.forEach(c => {
        const nome = c.nome_exibicao || c.remetente;
        const hora = c.data_hora ? new Date(c.data_hora).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }) : "";

        const li = document.createElement("li");
        li.className = "flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b relative";
        li.dataset.remetente = (c.remetente || "").toLowerCase();
        li.dataset.search = `${(nome || "").toLowerCase()} ${(c.remetente || "").toLowerCase()}`;

        li.innerHTML = `
      <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium"
           style="background:${gerarCor(nome)};color:white;">
        ${(nome || c.remetente || "U").charAt(0).toUpperCase()}
      </div>
      <div class="flex-1 min-w-0">
        <div class="font-bold truncate">${escapeHtml(nome)}</div>
        <span class="sr-only">${escapeHtml(c.remetente || "")}</span>
      </div>
      <div class="text-xs text-gray-400 pl-2">${hora}</div>
    `;
        li.onclick = () => abrirConversaFromElement(c, li);
        frag.appendChild(li);
      });
      contatosUL.appendChild(frag);
    }

    /* ======= Abrir conversa ======= */
    function abrirConversaFromElement(c, el) {
      document.querySelectorAll("#contatos li").forEach(li => li.classList.remove("contato-selected"));
      el.classList.add("contato-selected");
      abrirConversa(c);
    }
    async function abrirConversa(c) {
      contatoSelecionado = c.remetente; phoneIdAtual = c.phone_id;

      // LIMPA chat imediatamente para evitar confus√£o com conversa anterior
      const chatEl = document.getElementById("chat");
      chatEl.innerHTML = ""; // <<< limpeza imediata
      lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear();

      document.getElementById("tituloConversa").innerText = c.nome_exibicao ? `${c.nome_exibicao} (${c.remetente})` : c.remetente;
      document.getElementById("subInfo").innerText = c.phone_id ? `conta: ${phoneIdMap[c.phone_id] || c.phone_id}` : "";
      textarea.disabled = false; textarea.focus(); btnEnviar.disabled = true;

      // for√ßa ciclo imediato apenas para mensagens
      await refreshLoop("abrir-conversa");
    }

    /* ======= Mensagens (render) ======= */
    async function renderMensagens(msgs, incremental = true) {
      if (!contatoSelecionado) return;
      const chat = document.getElementById("chat");
      if (!Array.isArray(msgs)) return;

      msgs.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));

      if (!incremental) {
        chat.innerHTML = "";
        lastTimestampMs = null;
        lastDayRendered = null;
        renderedKeys.clear();
      }

      const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;

      msgs.forEach((m) => {
        const tMs = new Date(m.data_hora).getTime();
        const key = `${m.data_hora}|${m.status}|${m.mensagem_final || m.tipo || ""}`;
        if (renderedKeys.has(key)) return;
        if (incremental && lastTimestampMs !== null && tMs <= lastTimestampMs) return;

        const dia = new Date(m.data_hora).toLocaleDateString("pt-BR", { timeZone: "America/Sao_Paulo" });
        if (!lastDayRendered || lastDayRendered !== dia) {
          const sep = document.createElement("div");
          sep.className = "dia";
          sep.innerText = `‚Äî ${dia} ‚Äî`;
          chat.appendChild(sep);
          lastDayRendered = dia;
        }

        const hora = new Date(m.data_hora).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", timeZone: "America/Sao_Paulo" });
        const div = document.createElement("div");
        const incoming = isIncoming(m);
        div.className = `msg ${incoming ? "recebida" : "enviada"}`;

        if (m.tipo === "imagem" || m.mensagem_final === "[image]") {
          div.innerHTML = `
        <div class="text-gray-600 italic">[imagem recebida]</div>
        <button class="btn-olhinho text-blue-600 underline mt-1">üëÅ Ver imagem</button>
        <span class="hora">${hora}</span>
      `;
          const btn = div.querySelector(".btn-olhinho");
          if (!m.msg_id) {
            btn.disabled = true; btn.innerText = "Imagem indispon√≠vel";
          } else {
            btn.onclick = async () => {
              btn.disabled = true; btn.innerText = "‚è≥ Carregando...";
              try {
                const r = await fetch(`${API_BASE}/api/conversas/image/${encodeURIComponent(m.msg_id)}`);
                const j = await r.json();
                if (j.ok && j.data_uri) {
                  const img = document.createElement("img");
                  img.src = j.data_uri; img.alt = "Imagem recebida";
                  img.className = "thumb mt-2";
                  img.onclick = () => abrirModalImagem(j.data_uri);
                  div.insertBefore(img, btn); btn.remove();
                } else { throw new Error(j.erro || "Resposta inv√°lida do backend"); }
              } catch (e) { console.error("Erro imagem:", e); btn.disabled = false; btn.innerText = "üëÅ Ver imagem"; alert("Erro ao carregar imagem"); }
            };
          }
        }
        else if (m.tipo === "audio" || m.mensagem_final === "[audio]") {
          div.innerHTML = `
        <div class="text-gray-600 italic">[√°udio recebido]</div>
        <button class="btn-audio text-blue-600 underline mt-1">‚ñ∂ Reproduzir √°udio</button>
        <span class="hora">${hora}</span>
      `;
          const btn = div.querySelector(".btn-audio");
          if (!m.msg_id) { btn.disabled = true; btn.innerText = "√Åudio indispon√≠vel"; }
          else {
            btn.onclick = async () => {
              btn.disabled = true; btn.innerText = "‚è≥ Carregando...";
              try {
                const r = await fetch(`${API_BASE}/api/conversas/audio/${encodeURIComponent(m.msg_id)}`);
                const j = await r.json();
                if (j.ok && j.data_uri) {
                  const audio = document.createElement("audio");
                  audio.src = j.data_uri; audio.controls = true; audio.className = "mt-2";
                  div.insertBefore(audio, btn); btn.remove();
                } else { throw new Error(j.erro || "Resposta inv√°lida do backend"); }
              } catch (e) { console.error("Erro √°udio:", e); btn.disabled = false; btn.innerText = "‚ñ∂ Reproduzir √°udio"; alert("Erro ao carregar √°udio"); }
            };
          }
        }
        else if (m.tipo === "document" || m.mensagem_final === "[document]") {
          div.innerHTML = `
        <div class="text-gray-600 italic">[documento recebido]</div>
        <button class="btn-doc text-blue-600 underline mt-1">üìé Ver documento</button>
        <span class="hora">${hora}</span>
      `;
          const btn = div.querySelector(".btn-doc");
          if (!m.msg_id) { btn.disabled = true; btn.innerText = "Documento indispon√≠vel"; }
          else { btn.onclick = () => carregarDocumento(div, btn, m.msg_id); }
        }
        else if (typeof m.mensagem_final === "string" && m.mensagem_final.startsWith("üìé PDF:")) {
          const lines = m.mensagem_final.split("\n");
          const filename = (lines[0] || "").replace("üìé PDF:", "").trim() || "Arquivo";
          const link = (lines[1] || "").replace("üîó", "").trim();
          div.innerHTML = `
        <div class="flex items-start gap-2">
          <div class="text-xl leading-none">üìÑ</div>
          <div class="min-w-0">
            <div class="font-semibold">${escapeHtml(filename)}</div>
            ${link ? `<a href="${escapeHtml(link)}" target="_blank" class="text-blue-600 underline break-all">Abrir/baixar</a>` : `<span class="text-slate-500">sem link</span>`}
          </div>
        </div>
        <span class="hora">${hora}</span>
      `;
        }
        else if (m.tipo === "emoji" || m.mensagem_final === "[reaction]") {
          const wrapper = document.createElement("div"); wrapper.className = "flex items-center gap-2";
          const emojiEl = document.createElement("span"); emojiEl.className = "text-2xl leading-none"; emojiEl.textContent = "üôÇ";
          const label = document.createElement("span"); label.className = "text-gray-600 italic"; label.textContent = "enviou um emote";
          wrapper.appendChild(emojiEl); wrapper.appendChild(label); div.appendChild(wrapper);
          const horaSpan = document.createElement("span"); horaSpan.className = "hora"; horaSpan.textContent = hora; div.appendChild(horaSpan);
          if (m.msg_id) {
            (async () => {
              try {
                const r = await fetch(`${API_BASE}/api/conversas/emoji/${encodeURIComponent(m.msg_id)}`);
                const j = await r.json();
                if (j.ok && j.emoji) emojiEl.textContent = j.emoji; else label.textContent = "emoji n√£o carregado";
              } catch (e) { console.error("Erro emoji:", e); label.textContent = "falha ao carregar emoji"; }
            })();
          } else { label.textContent = "emoji indispon√≠vel"; }
        }
        else if (m.tipo === "system" || m.mensagem_final === "[system]") {
          div.classList.add("system");
          div.innerHTML = `
        <div class="sys-title"><span>‚ÑπÔ∏è Evento do sistema</span> <span class="sys-pill">carregando‚Ä¶</span></div>
        <div class="sys-body mt-1 text-slate-600">Obtendo detalhes‚Ä¶</div>
        <div class="sys-meta mt-1"></div>
        <span class="hora">${hora}</span>
      `;
          if (!m.msg_id) {
            div.querySelector(".sys-body").textContent = "Detalhes indispon√≠veis (sem msg_id).";
            const pill = div.querySelector(".sys-pill"); if (pill) pill.textContent = "indispon√≠vel";
          } else {
            (async () => {
              try {
                const r = await fetch(`${API_BASE}/api/conversas/system/${encodeURIComponent(m.msg_id)}`);
                const j = await r.json();
                const pill = div.querySelector(".sys-pill");
                const bodyEl = div.querySelector(".sys-body");
                const metaEl = div.querySelector(".sys-meta");

                if (!j.ok) { if (pill) pill.textContent = "erro"; bodyEl.textContent = j.erro || "Falha ao obter detalhes do evento."; return; }
                if (pill) pill.textContent = j.type || "system";
                if (j.type === "user_changed_number" && j.old_wa_id && j.wa_id) {
                  bodyEl.innerHTML = `O cliente alterou o n√∫mero:<br>
              <span class="font-semibold">${escapeHtml(j.old_wa_id)}</span>
              <span class="mx-1">‚Üí</span>
              <span class="font-semibold">${escapeHtml(j.wa_id)}</span>`;
                } else {
                  bodyEl.textContent = j.body || "Evento de sistema recebido.";
                }
                const src = j.from || j.old_wa_id || "";
                const pid = j.phone_id ? ` ‚Ä¢ conta: ${escapeHtml(j.phone_id)}` : "";
                metaEl.textContent = `${src ? "Origem: " + src : ""}${pid}`;
              } catch (e) { console.error("Erro system:", e); const pill = div.querySelector(".sys-pill"); if (pill) pill.textContent = "erro"; div.querySelector(".sys-body").textContent = "Falha ao carregar detalhes do evento."; }
            })();
          }
        }
        else {
          div.innerHTML = `<div>${escapeHtml(m.mensagem_final || "")}</div><span class="hora">${hora}</span>`;
        }

        // A√ß√£o de Responder (apenas mensagens do cliente)
        if (incoming && !(m.tipo === "system" || m.mensagem_final === "[system]")) {
          const actions = document.createElement("div");
          actions.className = "actions";
          const replyBtn = document.createElement("button");
          replyBtn.className = "icon-btn";
          replyBtn.title = "Responder";
          replyBtn.textContent = "‚Ü©";
          replyBtn.onclick = () => responderMensagem(m.msg_id, m.mensagem_final || "");
          actions.appendChild(replyBtn);
          div.appendChild(actions);
        }

        document.getElementById("chat").appendChild(div);
        renderedKeys.add(key);
        if (lastTimestampMs === null || tMs > lastTimestampMs) lastTimestampMs = tMs;
      });

      if (isNearBottom) document.getElementById("chat").scrollTo({ top: document.getElementById("chat").scrollHeight, behavior: "smooth" });
    }

    /* ======= Documento (carregar) ======= */
    async function carregarDocumento(div, btn, msg_id) {
      btn.disabled = true; btn.textContent = "‚è≥ Carregando‚Ä¶";
      try {
        const r = await fetch(`${API_BASE}/api/conversas/document/${encodeURIComponent(msg_id)}`);
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha ao obter documento");

        const filename = j.filename || "arquivo";
        const mime = j.mime_type || "application/octet-stream";
        const size = j.size_bytes ?? null;

        const box = document.createElement("div");
        box.className = "mt-2 space-y-1";

        if (mime.startsWith("application/pdf") && j.data_uri && (size === null || size <= DOC_PREVIEW_MAX)) {
          const preview = document.createElement("embed");
          preview.src = j.data_uri; preview.type = mime; preview.className = "w-[260px] h-[200px] rounded border";
          box.appendChild(preview);

          const meta = document.createElement("div");
          meta.className = "text-xs text-slate-600";
          const link = `${API_BASE}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
          meta.innerHTML = `<div class="font-semibold truncate">${escapeHtml(filename)}</div>
                        <div>${size ? bytesToHuman(size) : ""}</div>
                        <a href="${link}" target="_blank" class="text-blue-600 underline">Abrir/baixar</a>`;
          box.appendChild(meta);
        } else {
          const link = `${API_BASE}/api/conversas/document/${encodeURIComponent(msg_id)}/download`;
          const row = document.createElement("div");
          row.className = "flex items-start gap-2";
          row.innerHTML = `
        <div class="text-xl leading-none">üìé</div>
        <div class="min-w-0">
          <div class="font-semibold truncate">${escapeHtml(filename)}</div>
          <div class="text-xs text-slate-600">${escapeHtml(mime)} ${size ? ("‚Ä¢ " + bytesToHuman(size)) : ""}</div>
          <a href="${link}" target="_blank" class="text-blue-600 underline break-all">Baixar documento</a>
        </div>`;
          box.appendChild(row);
        }

        div.insertBefore(box, btn);
        btn.remove();
      } catch (e) {
        console.error(e);
        alert("Erro ao carregar documento");
        btn.disabled = false; btn.textContent = "üìé Ver documento";
      }
    }

    /* ======= Responder / Cancelar ======= */
    function responderMensagem(msgId, conteudo) {
      respostaMsgId = msgId || null;
      document.getElementById("respostaTexto").innerText = (conteudo || "").slice(0, 50);
      document.getElementById("respostaPreview").classList.remove("hidden");
      textarea.focus();
    }
    function cancelarResposta() {
      respostaMsgId = null;
      document.getElementById("respostaPreview").classList.add("hidden");
      document.getElementById("respostaTexto").innerText = "";
    }

    /* ======= Enviar texto ======= */
    async function enviarMensagem() {
      const texto = textarea.value.trim();
      if (!texto || !contatoSelecionado) return;
      userTyping = true; btnEnviar.disabled = true;
      try {
        const body = { texto, phone_id: phoneIdAtual, msg_id: respostaMsgId || null };
        const res = await fetch(`${API_BASE}/api/conversas/${encodeURIComponent(contatoSelecionado)}`, {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
        });
        const json = await res.json();
        if (json.ok) {
          textarea.value = ""; textarea.style.height = "auto";
          cancelarResposta();
          // refresh imediato (mensagens) ap√≥s enviar
          await refreshLoop("enviar");
        } else { alert("Erro ao enviar: " + (json.erro || JSON.stringify(json))); }
      } catch (err) { console.error(err); alert("Erro ao enviar mensagem. Verifique CORS/Network."); }
      finally { userTyping = false; btnEnviar.disabled = textarea.value.trim().length === 0; }
    }

    /* ======= Enviar PDF ======= */
    async function enviarPDF(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!contatoSelecionado || !phoneIdAtual) { alert("Selecione uma conversa antes de enviar PDF"); event.target.value = ""; return; }
      if (file.type !== "application/pdf") { alert("Somente arquivos PDF s√£o permitidos"); event.target.value = ""; return; }

      try {
        const res = await fetch(`${API_BASE}/api/upload/pdf`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: file.name })
        });
        const json = await res.json();
        if (!json.ok) { alert("Erro ao gerar URL: " + json.erro); return; }

        const put = await fetch(json.upload_url, { method: "PUT", headers: { "Content-Type": "application/pdf" }, body: file });
        if (!put.ok) { alert("Falha no upload"); return; }

        const body = { phone_id: phoneIdAtual, file_url: json.file_url, original_filename: file.name };
        const sendRes = await fetch(`${API_BASE}/api/conversas/${encodeURIComponent(contatoSelecionado)}`, {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
        });
        const sendJson = await sendRes.json();
        if (sendJson.ok) {
          await refreshLoop("enviar-pdf");
        } else { alert("Erro ao enviar PDF: " + (sendJson.erro || JSON.stringify(sendJson))); }
      } catch (err) {
        console.error("Erro ao enviar PDF", err); alert("Erro ao enviar PDF");
      } finally { event.target.value = ""; }
    }

    /* ======= Modal imagem ======= */
    const imageModal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    const closeModal = document.getElementById("closeModal");
    function abrirModalImagem(src) { isModalOpen = true; modalImg.src = src; imageModal.classList.remove("hidden"); }
    closeModal.onclick = () => { imageModal.classList.add("hidden"); modalImg.src = ""; isModalOpen = false; };
    imageModal.onclick = (e) => { if (e.target === imageModal) { imageModal.classList.add("hidden"); modalImg.src = ""; isModalOpen = false; } };

    /* ======= Loop de atualiza√ß√£o (apenas conversa selecionada) ======= */
    const CADENCE = { active: 10000, hidden: 60000 }; // 10s ativo; 60s aba oculta
    const BACKOFF_MAX = 120000;
    let failureStreak = 0;
    let refreshTimer = null;
    let refreshAbort = null;
    let isRefreshing = false;

    // calcula pr√≥ximo delay
    function computeNextDelay() {
      if (failureStreak > 0) return Math.min(BACKOFF_MAX, CADENCE.active * Math.pow(2, failureStreak));
      if (document.hidden) return CADENCE.hidden;
      // somente se houver conversa selecionada, mantemos 10s; caso contr√°rio n√£o reagendamos
      return contatoSelecionado ? CADENCE.active : null;
    }
    function scheduleRefresh(delay = computeNextDelay()) {
      clearTimeout(refreshTimer);
      if (delay == null) return; // nada agendado sem conversa selecionada
      refreshTimer = setTimeout(() => refreshLoop("auto"), delay);
    }

    // fetch JSON simples
    async function fetchJSON(url, { signal, timeoutMs = 9000 } = {}) {
      const own = new AbortController();
      const t = setTimeout(() => own.abort("timeout"), timeoutMs);
      const comp = new AbortController();
      const forward = (reason) => () => comp.abort(reason);
      own.signal.addEventListener("abort", forward("timeout"), { once: true });
      if (signal) signal.addEventListener("abort", forward("parent"), { once: true });

      try {
        const r = await fetch(url, { signal: comp.signal, cache: "no-store" });
        return await r.json();
      } finally { clearTimeout(t); }
    }

    async function refreshLoop(reason = "manual") {
      // pausa se modal aberto ou digitando
      const pauseMsgs = userTyping || isModalOpen;

      // single-flight: garante que o pr√≥ximo ciclo s√≥ inicia ap√≥s o t√©rmino deste
      if (isRefreshing) { try { refreshAbort?.abort("superseded"); } catch { } }
      isRefreshing = true;
      refreshAbort = new AbortController();
      const { signal } = refreshAbort;

      try {
        // somente mensagens
        if (contatoSelecionado && !pauseMsgs) {
          const url = `${API_BASE}/api/conversas/${encodeURIComponent(contatoSelecionado)}${phoneIdAtual ? `?phone_id=${encodeURIComponent(phoneIdAtual)}` : ""}`;
          const data = await fetchJSON(url, { signal });
          if (Array.isArray(data)) {
            await renderMensagens(data, /*incremental*/ true);
          }
        }

        failureStreak = 0;
      } catch (e) {
        if (String(e) !== "AbortError" && String(e) !== "superseded") {
          failureStreak = Math.min(failureStreak + 1, 10);
          console.warn("Refresh falhou:", e);
        }
      } finally {
        isRefreshing = false;
        // agenda o pr√≥ximo ciclo S√ì depois que o atual terminou (requisitado)
        scheduleRefresh();
      }
    }

    /* ======= Visibilidade ======= */
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) { scheduleRefresh(1000); } else { clearTimeout(refreshTimer); }
    });

    /* ======= Inicial ======= */
    setSort("desc"); // padr√£o: mais recentes primeiro
  </script>
</body>

</html>