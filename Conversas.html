<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversas WhatsApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .msg {
      max-width: 70%;
      padding: 10px 12px 18px 12px;
      border-radius: 16px;
      margin: 4px 0;
      position: relative;
      word-wrap: break-word;
    }
    .msg.enviada {
      background: #DCF8C6;
      align-self: flex-end;
    }
    .msg.recebida {
      background: #FFF;
      align-self: flex-start;
      border: 1px solid #ddd;
    }
    .msg .hora {
      font-size: 11px;
      color: #666;
      position: absolute;
      bottom: 2px;
      right: 8px;
    }
    .dia {
      text-align: center;
      margin: 12px 0;
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body class="h-screen flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-1/4 bg-white border-r flex flex-col">
    <div class="p-2 border-b">
      <input 
        type="text" 
        placeholder="🔍 Buscar contato"
        class="w-full p-2 rounded-md border"
        onkeyup="filtrarContatos(this.value)"
      />
    </div>
    <ul id="contatos" class="flex-1 overflow-y-auto"></ul>
  </aside>

  <!-- Área de conversa -->
  <main class="flex-1 flex flex-col">
    <div class="flex items-center justify-between p-3 border-b bg-white">
      <h2 id="tituloConversa" class="font-bold">Selecione uma conversa</h2>
      <input 
        type="date" 
        id="filtroData" 
        class="p-1 border rounded-md text-sm"
        onchange="filtrarPorData()"
      />
    </div>

    <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-2 bg-gray-50"></div>

    <div class="p-3 border-t flex space-x-2 bg-white">
      <input 
        type="text" 
        id="textoMensagem" 
        class="flex-1 border rounded-md p-2"
        placeholder="Digite uma mensagem..."
        disabled
      />
      <button 
        id="btnEnviar"
        onclick="enviarMensagem()" 
        class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 disabled:opacity-50"
        disabled>
        Enviar
      </button>
    </div>
  </main>

<script>
const API_BASE = "https://conversas-api-production.up.railway.app";
let contatoSelecionado = null;
let msgIdAtual = null;
let phoneIdAtual = null;

async function carregarContatos() {
  try {
    const res = await fetch(`${API_BASE}/api/conversas/contatos`);
    const contatos = await res.json();
    const lista = document.getElementById("contatos");
    lista.innerHTML = "";

    // 🔹 Evita duplicados
    const vistos = new Set();

    contatos.forEach(c => {
      const chave = c.remetente;
      if (vistos.has(chave)) return;
      vistos.add(chave);

      const nome = c.nome_exibicao || c.remetente;
      const ultimaMsg = c.mensagem_final ? c.mensagem_final.substring(0, 30) : "";

      const li = document.createElement("li");
      li.className = "flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b";
      li.innerHTML = `
        <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mr-3">
          ${nome[0].toUpperCase()}
        </div>
        <div class="flex-1">
          <div class="font-bold truncate">${nome}</div>
          <div class="text-sm text-gray-600 truncate">${ultimaMsg}</div>
        </div>
      `;
      li.onclick = () => abrirConversa(c);
      lista.appendChild(li);
    });
  } catch (err) {
    console.error("Erro ao carregar contatos", err);
  }
}

function filtrarContatos(query) {
  query = query.toLowerCase();
  document.querySelectorAll("#contatos li").forEach(li => {
    let texto = li.innerText.toLowerCase();
    li.style.display = texto.includes(query) ? "flex" : "none";
  });
}

async function abrirConversa(c) {
  contatoSelecionado = c.remetente;
  msgIdAtual = c.msg_id;
  phoneIdAtual = c.phone_id;

  const titulo = c.nome_exibicao || c.remetente;
  document.getElementById("tituloConversa").innerText = titulo;

  document.getElementById("textoMensagem").disabled = false;
  document.getElementById("btnEnviar").disabled = false;

  carregarMensagens();
}

async function carregarMensagens(dataFiltro = null) {
  if (!contatoSelecionado) return;

  let url = `${API_BASE}/api/conversas/${contatoSelecionado}`;
  if (dataFiltro) url += `?data=${dataFiltro}`;

  const res = await fetch(url);
  const msgs = await res.json();
  const chat = document.getElementById("chat");
  chat.innerHTML = "";

  let ultimoDia = "";

  msgs.forEach(m => {
    const data = new Date(m.data_hora);

    // ✅ Ajuste de fuso horário para Brasília
    const dia = data.toLocaleDateString("pt-BR", {
      timeZone: "America/Sao_Paulo"
    });
    const hora = data.toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "America/Sao_Paulo"
    });

    if (dia !== ultimoDia) {
      const separador = document.createElement("div");
      separador.className = "dia";
      separador.innerText = `— ${dia} —`;
      chat.appendChild(separador);
      ultimoDia = dia;
    }

    const div = document.createElement("div");
    div.className = `msg ${m.status === "in" ? "recebida" : "enviada"}`;
    div.innerHTML = `
      <div>${m.mensagem_final}</div>
      <span class="hora">${hora}</span>
    `;
    chat.appendChild(div);
  });

  chat.scrollTop = chat.scrollHeight;
}


function filtrarPorData() {
  const data = document.getElementById("filtroData").value;
  carregarMensagens(data);
}

async function enviarMensagem() {
  const texto = document.getElementById("textoMensagem").value.trim();
  if (!texto || !contatoSelecionado) return;

  const res = await fetch(`${API_BASE}/api/conversas/${contatoSelecionado}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone_id: phoneIdAtual, msg_id: msgIdAtual, texto })
  });

  const result = await res.json();
  if (result.ok) {
    document.getElementById("textoMensagem").value = "";
    carregarMensagens();
  } else {
    alert("Erro ao enviar mensagem");
  }
}

carregarContatos();
</script>
</body>
</html>
