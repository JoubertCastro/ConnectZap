<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conversas</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
    .sidebar { width: 250px; background: #f1f1f1; border-right: 1px solid #ccc; overflow-y: auto; }
    .sidebar h2 { padding: 10px; margin: 0; background: #075e54; color: #fff; }
    .contact { padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .contact:hover { background: #e9e9e9; }
    .chat { flex: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 15px; background: #075e54; color: #fff; font-weight: bold; }
    .messages { flex: 1; padding: 15px; overflow-y: auto; background: #ece5dd; }
    .msg { margin: 8px 0; max-width: 60%; padding: 10px; border-radius: 10px; position: relative;
           word-wrap: break-word; white-space: pre-wrap; }
    .msg.in { background: #fff; align-self: flex-start; }
    .msg.out { background: #dcf8c6; align-self: flex-end; }
    .msg .time { font-size: 11px; color: #666; margin-top: 3px; text-align: right; }
    .chat-footer { display: flex; padding: 10px; background: #f9f9f9; border-top: 1px solid #ccc; }
    .chat-footer input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
    .chat-footer button { margin-left: 10px; padding: 10px 15px; background: #075e54; color: #fff; border: none; border-radius: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Contatos</h2>
    <div id="contacts"></div>
  </div>
  <div class="chat">
    <div class="chat-header" id="chatHeader">Selecione um contato</div>
    <div class="messages" id="messages"></div>
    <div class="chat-footer">
      <input type="text" id="msgInput" placeholder="Digite uma mensagem..." disabled>
      <button id="sendBtn" disabled>Enviar</button>
    </div>
  </div>

  <script>
    let currentContact = null;

    function formatarDataHora(isoString) {
      let d = new Date(isoString);
      return d.toLocaleString("pt-BR", { hour: "2-digit", minute: "2-digit", day: "2-digit", month: "2-digit" });
    }

    async function carregarContatos() {
      let res = await fetch("https://conversas-api-production.up.railway.app/api/conversas/contatos");
      let contatos = await res.json();
      let div = document.getElementById("contacts");
      div.innerHTML = "";
      contatos.forEach(c => {
        let el = document.createElement("div");
        el.className = "contact";
        el.textContent = c.nome_exibicao || c.remetente;
        el.onclick = () => selecionarContato(c.remetente, c.nome_exibicao);
        div.appendChild(el);
      });
    }

    async function selecionarContato(remetente, nome) {
      currentContact = remetente;
      document.getElementById("chatHeader").textContent = nome || remetente;
      document.getElementById("msgInput").disabled = false;
      document.getElementById("sendBtn").disabled = false;
      carregarMensagens();
    }

    async function carregarMensagens() {
      if (!currentContact) return;
      let res = await fetch(`https://conversas-api-production.up.railway.app/api/conversas/${currentContact}`);
      let msgs = await res.json();
      let div = document.getElementById("messages");
      div.innerHTML = "";
      msgs.forEach(m => {
        let el = document.createElement("div");
        el.className = "msg " + (m.status === "in" ? "in" : "out");
        el.innerHTML = `<div>${m.mensagem_final}</div><div class="time">${formatarDataHora(m.data_hora)}</div>`;
        div.appendChild(el);
      });
      div.scrollTop = div.scrollHeight;
    }

    async function enviarMensagem() {
      let texto = document.getElementById("msgInput").value.trim();
      if (!texto) return;

      let res = await fetch(`https://conversas-api-production.up.railway.app/api/conversas/${currentContact}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone_id: "SEU_PHONE_ID",
          msg_id: "SEU_MSG_ID",
          texto
        })
      });

      let data = await res.json();
      if (data.ok) {
        document.getElementById("msgInput").value = "";
        carregarMensagens();
      } else {
        alert("Erro ao enviar mensagem: " + (data.erro || "Desconhecido"));
      }
    }

    document.getElementById("sendBtn").onclick = enviarMensagem;
    document.getElementById("msgInput").addEventListener("keypress", e => {
      if (e.key === "Enter") enviarMensagem();
    });

    // Atualiza a cada 5s
    setInterval(carregarMensagens, 5000);

    carregarContatos();
  </script>
</body>
</html>
