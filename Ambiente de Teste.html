<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Conversas WhatsApp ‚Äî Supervisor</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{
  --chat-bg:#f3f4f6;
  --bubble-in-bg:#ffffff;
  --bubble-in-border:#e2e8f0;
  --bubble-out-g1:#dcf8c6;
  --bubble-out-g2:#b8f0a4;
  --bubble-radius:18px;
  --density-gap:4px; /* 4 = confort√°vel, 1 = compacto */
  --msg-font:14px;
}

/* ====== Layout ====== */
body{ background:var(--chat-bg); }
@media (max-width: 768px) { aside { width: 42%; } }

/* ====== Bolhas ====== */
.msg {
  max-width: 70%;
  position: relative;
  margin: calc(var(--density-gap) * 1px) 0;
  padding: 10px 14px 22px 14px;
  font-size: var(--msg-font);
  line-height: 1.35;
  border-radius: var(--bubble-radius);
  word-wrap: break-word;
  white-space: pre-wrap;
  box-shadow: 0 1px 2px rgba(0,0,0,0.10);
}
.msg.enviada{
  align-self:flex-end;
  color:#111827;
  background: linear-gradient(120deg, var(--bubble-out-g1), var(--bubble-out-g2));
}
.msg.recebida{
  align-self:flex-start;
  background: var(--bubble-in-bg);
  border: 1px solid var(--bubble-in-border);
}

/* Caudas das bolhas (estilo WhatsApp) */
.msg.enviada::after, .msg.recebida::after{
  content:"";
  position:absolute;
  bottom:0;
  width:14px; height:14px;
  clip-path: polygon(0 0, 100% 0, 0 100%);
}
.msg.enviada::after{
  right:-7px;
  background: var(--bubble-out-g2);
  filter: brightness(0.98);
}
.msg.recebida::after{
  left:-7px;
  background: var(--bubble-in-bg);
  border-left:1px solid var(--bubble-in-border);
  border-bottom:1px solid var(--bubble-in-border);
}

/* Hora e a√ß√µes */
.msg .hora{
  position:absolute; right:8px; bottom:4px;
  font-size:11px; color:#4b5563;
}
.msg .actions{
  position:absolute; top:6px; right:6px;
  display:flex; gap:6px; opacity:0; transition:opacity .18s ease;
}
.msg:hover .actions{ opacity:1; }
.msg .icon-btn{
  font-size:14px; color:#64748b; cursor:pointer;
}
.msg .icon-btn:hover{ color:#2563eb; }

/* Imagens dentro do bal√£o */
.msg img.thumb{
  display:block; max-width:220px; border-radius:12px; border:1px solid #e5e7eb; cursor:pointer;
}

/* √Åudio estilizado */
.audio-wrap{
  display:flex; align-items:center; gap:.5rem; padding:.35rem .6rem;
  background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px;
}
.audio-wrap button{
  width:32px; height:32px; border-radius:999px; background:#10b981; color:#fff;
  display:flex; align-items:center; justify-content:center; font-weight:700;
}
.audio-wrap .time{ font-size:12px; color:#475569; }

/* Dia separador */
.dia{ text-align:center; margin:12px 0; font-size:12px; color:#64748b; }

/* Lista/Sidebar */
.contato-selected{ background:#f0f9ff !important; }
.badge{
  position:absolute; top:8px; right:8px;
  background:#22c55e; color:#fff; font-size:10px; font-weight:700;
  border-radius:9999px; padding:2px 6px; min-width:18px; text-align:center;
}
mark { background:#ffef6b; color:#000; padding:0 2px; border-radius:2px; }
#digitando{ font-size:12px; color:#666; margin-bottom:4px; }

/* Chips e filtros colaps√°veis */
.chip-btn{
  padding:.4rem .7rem; font-size:.8rem; border-radius:.6rem;
  border:1px solid #e2e8f0; background:#fff; color:#334155; font-weight:600;
}
.chip-btn.active{ background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
details.filter-block{ border:1px solid #e2e8f0; border-radius:.75rem; background:#fff; }
details.filter-block > summary{
  list-style:none; cursor:pointer; padding:.6rem .8rem;
  display:flex; align-items:center; justify-content:space-between;
  font-weight:700; color:#334155;
}
details.filter-block > summary::-webkit-details-marker{ display:none; }
details.filter-block[open] > summary{ border-bottom:1px dashed #e2e8f0; }
.summary-label{ display:flex; align-items:center; gap:.5rem; }
.summary-chevron{ transition: transform .2s ease; }
details.filter-block[open] .summary-chevron{ transform: rotate(180deg); }

/* Personaliza√ß√£o do chat (preview do fundo) */
.chat-bg{
  background-size:cover; background-position:center;
}

/* Bot√£o flutuante e painel de Apar√™ncia */
.fab{
  position:fixed; right:18px; bottom:18px; z-index:50;
  width:46px; height:46px; border-radius:999px;
  background:#111827; color:#fff; display:flex; align-items:center; justify-content:center;
  box-shadow:0 8px 18px rgba(0,0,0,.18); cursor:pointer;
}
.drawer{
  position:fixed; right:0; top:0; height:100%; width:340px; max-width:100%;
  background:#fff; border-left:1px solid #e5e7eb; box-shadow:-8px 0 20px rgba(0,0,0,.08);
  transform: translateX(100%); transition: transform .22s ease; z-index:60;
}
.drawer.open{ transform: translateX(0); }
.drawer h3{ font-weight:800; }
.preview-tile{
  height:44px; border-radius:.6rem; border:1px solid #e5e7eb;
}

/* Estados (compacto) */
.compacto .msg{ max-width:75%; padding:8px 12px 18px 12px; }
</style>
</head>

<body class="h-screen flex">
<!-- =========== SIDEBAR =========== -->
<aside id="sidebar" class="w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
  <div class="p-3 border-b">
    <details id="fltBasico" class="filter-block" open>
      <summary>
        <span class="summary-label">
          <span>Filtros</span>
          <span id="fltResumo" class="text-xs font-normal text-slate-500"></span>
        </span>
        <svg class="summary-chevron w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </summary>

      <div class="p-3 space-y-3">
        <div class="space-y-1">
          <label class="text-xs text-gray-500 font-medium">Carteira</label>
          <select id="filtroConta" class="w-full p-2 border rounded-md text-sm">
            <option value="">‚Äî selecione ‚Äî</option>
            <option value="*">Todas as contas</option>
            <option value="732661079928516">ConnectZap</option>
            <option value="727586317113885">Recovery PJ</option>
            <option value="802977069563598">Recovery PF</option>
            <option value="821562937700669">Mercado Pago Cobran√ßa</option>
            <option value="779797401888141">DivZero</option>
            <option value="829210283602406">Arc4U</option>
            <option value="713021321904495">Serasa</option>
            <option value="803535039503723">Mercado Pago Vendas</option>
          </select>
        </div>

        <div class="space-y-2">
          <div class="text-xs text-gray-500 font-medium">Per√≠odo</div>
          <div class="flex flex-wrap gap-2">
            <button class="chip-btn" data-range="hoje">Hoje</button>
            <button class="chip-btn" data-range="ontem">Ontem</button>
            <button class="chip-btn" data-range="7d">√öltimos 7 dias</button>
            <button class="chip-btn" data-range="30d">√öltimos 30 dias</button>
            <button class="chip-btn" data-range="mes">M√™s atual</button>
            <button class="chip-btn" data-range="custom">Personalizado</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input id="dataInicio" type="date" class="p-2 border rounded-md text-sm" />
            <input id="dataFim" type="date" class="p-2 border rounded-md text-sm" />
          </div>
          <div class="flex gap-2">
            <button id="btnAplicarFiltros" class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Aplicar</button>
            <button id="btnLimparFiltros" class="px-3 py-2 rounded-md border text-sm">Limpar</button>
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-xs text-gray-500 font-medium">Buscar contato ou n√∫mero</label>
          <input id="searchInput" type="text" placeholder="üîç digite para filtrar..." class="w-full p-2 rounded-md border text-sm" autocomplete="off" oninput="filtrarContatos(this.value)" />
        </div>

        <div id="hintFiltro" class="text-xs text-gray-500 bg-slate-50 border border-dashed rounded-md p-2">
          Selecione a <b>carteira</b> e um <b>per√≠odo</b>, depois clique em <b>Aplicar</b> para carregar a lista.
        </div>
      </div>
    </details>
  </div>

  <!-- Lista de contatos -->
  <ul id="contatos" class="flex-1 overflow-y-auto"></ul>

  <div class="p-2 text-xs text-gray-500 border-t">
    Atualiza automaticamente ap√≥s aplicar os filtros.
  </div>
</aside>

<!-- =========== MAIN CHAT =========== -->
<main class="flex-1 flex flex-col">
  <div class="flex items-center justify-between p-3 border-b bg-white space-x-2">
    <div class="flex items-center space-x-3 min-w-0">
      <h2 id="tituloConversa" class="font-bold text-lg truncate">Selecione uma conversa</h2>
      <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
    </div>
  </div>

  <!-- Plano de fundo personaliz√°vel -->
  <div id="chat" class="chat-bg flex-1 p-4 overflow-y-auto flex flex-col space-y-1">
    <p id="loading" class="text-center text-gray-500">Selecione um contato para ver as mensagens...</p>
  </div>
  <div id="digitando" class="px-4 text-left hidden">Digitando...</div>

  <div id="respostaPreview" class="hidden px-3 py-2 border-t bg-gray-50 text-sm flex justify-between items-center">
    <div class="truncate max-w-[80%]">
      <span class="font-semibold">Respondendo:</span>
      <span id="respostaTexto" class="text-gray-600"></span>
    </div>
    <button onclick="cancelarResposta()" class="text-red-500 text-xs">‚úñ</button>
  </div>

  <div class="p-3 border-t flex space-x-2 bg-white items-center">
    <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="enviarPDF(event)">
    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600">üìù PDF</button>

    <textarea id="textoMensagem" rows="1" class="flex-1 border rounded-md p-2 resize-none" placeholder="Digite uma mensagem..." disabled></textarea>
    <button id="btnEnviar" onclick="enviarMensagem()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 disabled:opacity-50" disabled>Enviar</button>
  </div>
</main>

<!-- Modal de imagem -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
  <span id="closeModal" class="absolute top-4 right-6 text-white text-3xl cursor-pointer">&times;</span>
  <img id="modalImg" src="" alt="Imagem" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">
</div>

<!-- Bot√£o de Apar√™ncia -->
<button id="btnFab" class="fab" title="Apar√™ncia">üé®</button>
<!-- Drawer de Apar√™ncia -->
<div id="drawer" class="drawer">
  <div class="p-4 border-b flex items-center justify-between">
    <h3 class="text-lg">Apar√™ncia do Chat</h3>
    <button id="btnCloseDrawer" class="text-gray-500 hover:text-gray-800">‚úñ</button>
  </div>
  <div class="p-4 space-y-4">
    <div>
      <div class="text-xs text-gray-600 font-semibold mb-1">Plano de fundo do chat</div>
      <div class="flex items-center gap-2">
        <div class="flex-1 preview-tile" id="bgPreview"></div>
        <input type="file" id="bgInput" accept="image/*" class="text-xs">
      </div>
      <button id="bgReset" class="mt-2 text-xs text-blue-600 underline">Remover fundo personalizado</button>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <div class="text-xs text-gray-600 font-semibold mb-1">Bal√£o Enviado (Gradiente)</div>
        <div class="flex items-center gap-2">
          <input type="color" id="outG1" value="#dcf8c6" title="Cor 1">
          <input type="color" id="outG2" value="#b8f0a4" title="Cor 2">
        </div>
      </div>
      <div>
        <div class="text-xs text-gray-600 font-semibold mb-1">Bal√£o Recebido (fundo/borda)</div>
        <div class="flex items-center gap-2">
          <input type="color" id="inBg" value="#ffffff" title="Fundo">
          <input type="color" id="inBorder" value="#e2e8f0" title="Borda">
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <div class="text-xs text-gray-600 font-semibold mb-1">Densidade</div>
        <select id="densidade" class="w-full p-2 border rounded-md text-sm">
          <option value="confortavel">Confort√°vel</option>
          <option value="compacto">Compacto</option>
        </select>
      </div>
      <div>
        <div class="text-xs text-gray-600 font-semibold mb-1">Tamanho da fonte (bal√µes)</div>
        <select id="fontSize" class="w-full p-2 border rounded-md text-sm">
          <option value="13">13 px</option>
          <option value="14" selected>14 px</option>
          <option value="15">15 px</option>
          <option value="16">16 px</option>
        </select>
      </div>
    </div>

    <button id="btnSaveTheme" class="w-full px-3 py-2 rounded-md bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700">Salvar apar√™ncia</button>
  </div>
</div>

<script>
/* =================== Config =================== */
const API_BASE = "https://conversas-api-production.up.railway.app";
const phoneIdMap = {
  "732661079928516": "ConnectZap",
  "727586317113885": "Recovery PJ",
  "802977069563598": "Recovery PF",
  "821562937700669": "Mercado Pago Cobran√ßa",
  "779797401888141": "DivZero",
  "829210283602406": "Arc4U",
  "713021321904495": "Serasa",
  "803535039503723": "Mercado Pago Vendas"
};

/* =================== Estado =================== */
let contatoSelecionado = null, phoneIdAtual = null;
let respostaMsgId = null;
let contactsInterval = null, messagesInterval = null, userTyping = false, isModalOpen = false;
let novasMensagens = {}, ultimoStatusContatos = {}, filtrosAplicados = false;
let lastTimestampMs = null, lastDayRendered = null, renderedKeys = new Set();

/* =================== Refs =================== */
const textarea = document.getElementById("textoMensagem");
const btnEnviar = document.getElementById("btnEnviar");
const digitando = document.getElementById("digitando");
const contatosUL = document.getElementById("contatos");
const filtroContaEl = document.getElementById("filtroConta");
const dataInicioEl = document.getElementById("dataInicio");
const dataFimEl = document.getElementById("dataFim");
const hintFiltro = document.getElementById("hintFiltro");
const btnAplicarFiltros = document.getElementById("btnAplicarFiltros");
const btnLimparFiltros = document.getElementById("btnLimparFiltros");
const chipBtns = [...document.querySelectorAll(".chip-btn")];
const fltResumoEl = document.getElementById("fltResumo");
const chat = document.getElementById("chat");

/* =================== Apar√™ncia (persist√™ncia) =================== */
const THEME_KEY = "cz:supervisor:theme";
const drawer = document.getElementById("drawer");
const bgPreview = document.getElementById("bgPreview");
const bgInput = document.getElementById("bgInput");
const bgReset = document.getElementById("bgReset");
const outG1 = document.getElementById("outG1");
const outG2 = document.getElementById("outG2");
const inBg  = document.getElementById("inBg");
const inBorder = document.getElementById("inBorder");
const densidadeSel = document.getElementById("densidade");
const fontSizeSel = document.getElementById("fontSize");

function loadTheme(){
  const raw = localStorage.getItem(THEME_KEY);
  if(!raw) return;
  try{
    const t = JSON.parse(raw);
    if(t.chatBg){ chat.style.backgroundImage = `url(${t.chatBg})`; bgPreview.style.backgroundImage = `url(${t.chatBg})`; }
    document.documentElement.style.setProperty('--bubble-out-g1', t.outG1 || '#dcf8c6');
    document.documentElement.style.setProperty('--bubble-out-g2', t.outG2 || '#b8f0a4');
    document.documentElement.style.setProperty('--bubble-in-bg', t.inBg || '#ffffff');
    document.documentElement.style.setProperty('--bubble-in-border', t.inBorder || '#e2e8f0');
    document.documentElement.style.setProperty('--msg-font', (t.fontSize||14)+'px');
    document.documentElement.style.setProperty('--density-gap', t.density==='compacto' ? '1' : '4');

    outG1.value = t.outG1 || '#dcf8c6';
    outG2.value = t.outG2 || '#b8f0a4';
    inBg.value = t.inBg || '#ffffff';
    inBorder.value = t.inBorder || '#e2e8f0';
    fontSizeSel.value = String(t.fontSize||14);
    densidadeSel.value = t.density || 'confortavel';

    document.body.classList.toggle("compacto", t.density==='compacto');
  }catch(e){}
}
function saveTheme(){
  const theme = {
    chatBg: chat.style.backgroundImage ? chat.style.backgroundImage.replace(/^url\((.*)\)$/,'$1').replaceAll('"','') : null,
    outG1: outG1.value, outG2: outG2.value,
    inBg: inBg.value, inBorder: inBorder.value,
    density: densidadeSel.value,
    fontSize: parseInt(fontSizeSel.value,10)
  };
  localStorage.setItem(THEME_KEY, JSON.stringify(theme));
  loadTheme();
}

document.getElementById("btnFab").onclick = ()=> drawer.classList.add("open");
document.getElementById("btnCloseDrawer").onclick = ()=> drawer.classList.remove("open");
document.getElementById("btnSaveTheme").onclick = ()=> { saveTheme(); drawer.classList.remove("open"); };

bgInput.addEventListener("change", (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    chat.style.backgroundImage = `url(${ev.target.result})`;
    bgPreview.style.backgroundImage = `url(${ev.target.result})`;
  };
  reader.readAsDataURL(f);
});
bgReset.onclick = ()=>{ chat.style.backgroundImage = ""; bgPreview.style.backgroundImage = ""; };

/* =================== Helpers UI =================== */
function pad(n){ return String(n).padStart(2,"0"); }
function toYMD(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function setQuickRange(kind){
  const now = new Date();
  let a = new Date(), b = new Date();
  if(kind==="ontem"){ a.setDate(now.getDate()-1); b.setDate(now.getDate()-1); }
  if(kind==="7d"){ a.setDate(now.getDate()-6); }
  if(kind==="30d"){ a.setDate(now.getDate()-29); }
  if(kind==="mes"){ a = new Date(now.getFullYear(), now.getMonth(), 1); }
  dataInicioEl.value = toYMD(a); dataFimEl.value = toYMD(b);
  atualizarResumo();
}
function highlightChip(btn){ chipBtns.forEach(b=>b.classList.remove("active")); if(btn) btn.classList.add("active"); }
chipBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{ const k = btn.dataset.range; if(k!=="custom") setQuickRange(k); highlightChip(btn); });
});
(function initPeriodoDefault(){ setQuickRange("hoje"); highlightChip(document.querySelector('[data-range="hoje"]')); })();

function gerarCor(nome){ let hash=0; for(let i=0;i<nome.length;i++){ hash=nome.charCodeAt(i)+((hash<<5)-hash); } return `hsl(${hash % 360},70%,60%)`; }
function escapeHtml(s){ if(!s) return ""; return s.replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
function toLocalDateYMD(iso){
  const d = new Date(iso);
  const p = new Date(d.toLocaleString("en-US",{ timeZone:"America/Sao_Paulo" }));
  return `${p.getFullYear()}-${pad(p.getMonth()+1)}-${pad(p.getDate())}`;
}
function atualizarResumo(){
  const carteira = filtroContaEl.value || "‚Äî";
  const di = dataInicioEl.value || "‚Äî";
  const df = dataFimEl.value || "‚Äî";
  fltResumoEl.textContent = `(carteira: ${carteira==="*"?"todas":carteira} ‚Ä¢ ${di} ‚Üí ${df})`;
}
[filtroContaEl, dataInicioEl, dataFimEl].forEach(el => el.addEventListener("change", atualizarResumo));
atualizarResumo();

/* =================== Textarea UX =================== */
textarea.addEventListener("input", () => {
  textarea.style.height = "auto";
  textarea.style.height = textarea.scrollHeight + "px";
  btnEnviar.disabled = textarea.value.trim().length === 0;
  digitando.style.display = textarea.value.trim() ? "block" : "none";
});
textarea.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); if(!btnEnviar.disabled) enviarMensagem(); }
});

/* =================== Aplicar/Limpar Filtros =================== */
btnAplicarFiltros.addEventListener("click", ()=>{
  if(!filtroContaEl.value){ alert("Selecione uma carteira (ou 'Todas as contas')."); return; }
  filtrosAplicados = true; hintFiltro.classList.add("hidden");
  startContactsPolling();
});
btnLimparFiltros.addEventListener("click", ()=>{
  filtroContaEl.value = "";
  setQuickRange("hoje"); highlightChip(document.querySelector('[data-range="hoje"]'));
  dataInicioEl.value = ""; dataFimEl.value = "";
  document.getElementById("searchInput").value = "";
  filtrosAplicados = false; hintFiltro.classList.remove("hidden");
  contatosUL.innerHTML = "";
  if(contactsInterval) clearInterval(contactsInterval);
  atualizarResumo();
});

/* =================== Contatos =================== */
async function carregarContatos(){
  if(!filtrosAplicados) return;
  try{
    if(!contatosUL.children.length){
      contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Carregando contatos‚Ä¶</li>`;
    }
    const res = await fetch(`${API_BASE}/api/conversas/contatos`);
    if(!res.ok) throw new Error("Falha ao buscar contatos");
    const contatos = await res.json();

    const carteirafiltro = filtroContaEl.value;
    const di = dataInicioEl.value || null;
    const df = dataFimEl.value || null;
    const busc = document.getElementById("searchInput").value.toLowerCase().trim();

    let filtrados = contatos;
    if(carteirafiltro && carteirafiltro !== "*"){
      filtrados = filtrados.filter(c => c.phone_id === carteirafiltro);
    }
    if(di || df){
      filtrados = filtrados.filter(c=>{
        if(!c.data_hora) return false;
        const ymd = toLocalDateYMD(c.data_hora);
        if(di && ymd < di) return false;
        if(df && ymd > df) return false;
        return true;
      });
    }
    if(busc){
      filtrados = filtrados.filter(c=>{
        const nome = (c.nome_exibicao||"").toLowerCase();
        const num  = (c.remetente||"").toLowerCase();
        return nome.includes(busc) || num.includes(busc);
      });
    }

    contatosUL.innerHTML = "";
    if(filtrados.length === 0){
      contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Nenhum contato no per√≠odo/filtros.</li>`;
      return;
    }

    filtrados.forEach(c=>{
      const nome = c.nome_exibicao||c.remetente;
      const ultimaMsg = c.mensagem_final?c.mensagem_final.substring(0,70):"";
      const hora = c.data_hora?new Date(c.data_hora).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):"";

      if (ultimoStatusContatos[c.remetente] !== c.data_hora && contatoSelecionado !== c.remetente) {
        novasMensagens[c.remetente] = (novasMensagens[c.remetente] || 0) + 1;
      }
      ultimoStatusContatos[c.remetente] = c.data_hora;

      const li = document.createElement("li");
      li.className="flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b relative";
      li.dataset.remetente=c.remetente.toLowerCase();

      const badge = (novasMensagens[c.remetente] && novasMensagens[c.remetente] > 0)
        ? `<span class="badge">${novasMensagens[c.remetente]}</span>` : "";

      li.innerHTML=`
        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium"
             style="background:${gerarCor(nome)};color:white;">
          ${(nome||c.remetente||"U").charAt(0).toUpperCase()}
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-bold truncate">${escapeHtml(nome)}</div>
          <div class="text-sm text-gray-600 truncate">${escapeHtml(ultimaMsg)}</div>
        </div>
        <div class="text-xs text-gray-400 pl-2">${hora}</div>
        ${badge}
      `;
      li.onclick = ()=>abrirConversaFromElement(c,li);
      contatosUL.appendChild(li);
    });
  }catch(err){
    console.error("Erro ao carregar contatos",err);
    contatosUL.innerHTML = `<li class="p-3 text-sm text-red-600">Erro ao carregar contatos.</li>`;
  }
}
function startContactsPolling(){
  if(contactsInterval) clearInterval(contactsInterval);
  carregarContatos();
  contactsInterval = setInterval(()=>{ if(filtrosAplicados) carregarContatos(); }, 10000);
}
function filtrarContatos(q){
  q=(q||"").toLowerCase().trim();
  document.querySelectorAll("#contatos li").forEach(li=>{
    if(!li.dataset.remetente) return;
    const hay=li.textContent.toLowerCase();
    if(hay.includes(q)){
      li.style.display="flex";
      const nameDiv=li.querySelector(".font-bold");
      nameDiv.innerHTML=q?nameDiv.textContent.replace(new RegExp(q,"ig"),m=>`<mark>${m}</mark>`):nameDiv.textContent;
    }else li.style.display="none";
  });
}

/* =================== Abrir conversa =================== */
function abrirConversaFromElement(c,el){
  document.querySelectorAll("#contatos li").forEach(li=>li.classList.remove("contato-selected"));
  el.classList.add("contato-selected");
  abrirConversa(c);
}
async function abrirConversa(c){
  contatoSelecionado=c.remetente; phoneIdAtual=c.phone_id;
  lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear();
  novasMensagens[c.remetente] = 0;

  document.getElementById("tituloConversa").innerText = c.nome_exibicao ? `${c.nome_exibicao} (${c.remetente})` : c.remetente;
  document.getElementById("subInfo").innerText=c.phone_id?`conta: ${phoneIdMap[c.phone_id]||c.phone_id}`:"";
  textarea.disabled=false; textarea.focus(); btnEnviar.disabled=true;

  if(messagesInterval) clearInterval(messagesInterval);
  await carregarMensagens(false);
  messagesInterval=setInterval(()=>{ if(!userTyping && !isModalOpen){ carregarMensagens(true); } }, 5000);
}

/* =================== Mensagens (render melhorado) =================== */
async function carregarMensagens(incremental = true) {
  if (!contatoSelecionado) return;
  let url = `${API_BASE}/api/conversas/${contatoSelecionado}`;
  if (phoneIdAtual) url += `?phone_id=${encodeURIComponent(phoneIdAtual)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Erro ao obter hist√≥rico");
    const msgs = await res.json();
    msgs.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));

    if (!incremental) {
      chat.innerHTML = "";
      lastTimestampMs = null; lastDayRendered = null; renderedKeys.clear();
    }

    const isNearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;

    msgs.forEach((m) => {
      const tMs = new Date(m.data_hora).getTime();
      const key = `${m.data_hora}|${m.status}|${m.mensagem_final || m.tipo || ""}`;
      if (renderedKeys.has(key)) return;
      if (incremental && lastTimestampMs !== null && tMs <= lastTimestampMs) return;

      // Separador por dia
      const dia = new Date(m.data_hora).toLocaleDateString("pt-BR", { timeZone: "America/Sao_Paulo" });
      if (!lastDayRendered || lastDayRendered !== dia) {
        const sep = document.createElement("div");
        sep.className = "dia";
        sep.innerText = `‚Äî ${dia} ‚Äî`;
        chat.appendChild(sep);
        lastDayRendered = dia;
      }

      const hora = new Date(m.data_hora).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", timeZone: "America/Sao_Paulo" });
      const div = document.createElement("div");
      div.className = `msg ${m.status === "in" ? "recebida" : "enviada"}`;

      // Conte√∫dos
      if (m.tipo === "imagem" || m.mensagem_final === "[image]") {
        div.innerHTML = `
          <div class="text-gray-600 italic">[imagem]</div>
          <button class="btn-olhinho text-blue-600 underline mt-1">üëÅ Ver imagem</button>
          <span class="hora">${hora}</span>
          <div class="actions">
            <span class="icon-btn" title="Responder">‚Ü©</span>
          </div>
        `;
        const btn = div.querySelector(".btn-olhinho");
        const replyIcon = div.querySelector(".actions .icon-btn");
        replyIcon.onclick = ()=> responderMensagem(m.msg_id, "[imagem]");

        if (!m.msg_id) { btn.disabled = true; btn.innerText = "Imagem indispon√≠vel"; }
        else {
          btn.onclick = async () => {
            btn.disabled = true; btn.innerText = "‚è≥ Carregando...";
            try {
              const r = await fetch(`${API_BASE}/api/conversas/image/${encodeURIComponent(m.msg_id)}`);
              const j = await r.json();
              if (j.ok && j.data_uri) {
                const img = document.createElement("img");
                img.src = j.data_uri; img.alt = "Imagem recebida";
                img.className = "thumb mt-2";
                img.onclick = () => abrirModalImagem(j.data_uri);
                div.insertBefore(img, btn); btn.remove();
                div.querySelector(".text-gray-600.italic").remove();
              } else { throw new Error(j.erro || "Resposta inv√°lida do backend"); }
            } catch (e) { console.error("Erro imagem:", e); btn.disabled=false; btn.innerText="üëÅ Ver imagem"; alert("Erro ao carregar imagem"); }
          };
        }
      }
      else if (m.tipo === "audio" || m.mensagem_final === "[audio]") {
        div.innerHTML = `
          <div class="audio-wrap mt-1">
            <button class="pbtn" title="Play/Pause">‚ñ∂</button>
            <span class="time">00:00</span>
          </div>
          <span class="hora">${hora}</span>
          <div class="actions">
            <span class="icon-btn" title="Responder">‚Ü©</span>
          </div>
        `;
        const replyIcon = div.querySelector(".actions .icon-btn");
        replyIcon.onclick = ()=> responderMensagem(m.msg_id, "[√°udio]");

        const pbtn = div.querySelector(".pbtn");
        const timeLbl = div.querySelector(".time");
        let audioTag = null;

        const loadAudio = async ()=>{
          try{
            const r = await fetch(`${API_BASE}/api/conversas/audio/${encodeURIComponent(m.msg_id)}`);
            const j = await r.json();
            if(j.ok && j.data_uri){
              audioTag = document.createElement("audio");
              audioTag.src = j.data_uri; audioTag.preload = "auto";
              audioTag.addEventListener("timeupdate", ()=>{
                const mm = pad(Math.floor(audioTag.currentTime/60));
                const ss = pad(Math.floor(audioTag.currentTime%60));
                timeLbl.textContent = `${mm}:${ss}`;
              });
            }else throw new Error(j.erro || "Resposta inv√°lida");
          }catch(e){ console.error("Erro audio:", e); alert("Erro ao carregar √°udio"); }
        };

        pbtn.onclick = async ()=>{
          if(!audioTag) await loadAudio();
          if(!audioTag) return;
          if(audioTag.paused){ audioTag.play(); pbtn.textContent="‚è∏"; }
          else { audioTag.pause(); pbtn.textContent="‚ñ∂"; }
        };
      }
      else if (m.tipo === "emoji" || m.mensagem_final === "[reaction]") {
        const wrap = document.createElement("div"); wrap.className = "flex items-center gap-2";
        const emojiEl = document.createElement("span"); emojiEl.className = "text-2xl leading-none"; emojiEl.textContent = "üôÇ";
        const label = document.createElement("span"); label.className = "text-gray-600 italic"; label.textContent = "enviou um emote";
        wrap.appendChild(emojiEl); wrap.appendChild(label); div.appendChild(wrap);
        const horaSpan = document.createElement("span"); horaSpan.className = "hora"; horaSpan.textContent = hora; div.appendChild(horaSpan);

        if (m.msg_id) {
          (async ()=>{ try {
            const r = await fetch(`${API_BASE}/api/conversas/emoji/${encodeURIComponent(m.msg_id)}`);
            const j = await r.json();
            if (j.ok && j.emoji) emojiEl.textContent = j.emoji; else label.textContent = "emoji n√£o carregado";
          } catch(e){ console.error("Erro emoji:", e); label.textContent = "falha ao carregar emoji"; }})();
        } else { label.textContent = "emoji indispon√≠vel"; }
      }
      else {
        // Texto com copiar e responder
        div.innerHTML = `
          <div>${escapeHtml(m.mensagem_final || "")}</div>
          <span class="hora">${hora}</span>
          <div class="actions">
            <span class="icon-btn btn-copy" title="Copiar">‚ßâ</span>
            <span class="icon-btn btn-reply" title="Responder">‚Ü©</span>
          </div>
        `;
        div.querySelector(".btn-copy").onclick = ()=>{
          navigator.clipboard.writeText(m.mensagem_final||"").then(()=>{}).catch(()=>{});
        };
        div.querySelector(".btn-reply").onclick = ()=> responderMensagem(m.msg_id, m.mensagem_final || "");
      }

      chat.appendChild(div);
      renderedKeys.add(key);
      if (lastTimestampMs === null || tMs > lastTimestampMs) lastTimestampMs = tMs;
    });

    if (isNearBottom) chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" });
  } catch (err) {
    console.error("Erro ao carregar mensagens", err);
  }
}

/* =================== Responder / Cancelar =================== */
function responderMensagem(msgId, conteudo){
  respostaMsgId = msgId || null;
  document.getElementById("respostaTexto").innerText = (conteudo || "").slice(0,50);
  document.getElementById("respostaPreview").classList.remove("hidden");
  textarea.focus();
}
function cancelarResposta(){
  respostaMsgId = null;
  document.getElementById("respostaPreview").classList.add("hidden");
  document.getElementById("respostaTexto").innerText = "";
}

/* =================== Enviar texto =================== */
async function enviarMensagem(){
  const texto=textarea.value.trim();
  if(!texto||!contatoSelecionado) return;
  userTyping=true; btnEnviar.disabled=true;
  try{
    const body = { texto, phone_id: phoneIdAtual, msg_id: respostaMsgId || null };
    const res=await fetch(`${API_BASE}/api/conversas/${contatoSelecionado}`,{
      method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)
    });
    const json=await res.json();
    if(json.ok){
      textarea.value="";textarea.style.height="auto";
      cancelarResposta();
      await carregarMensagens(true);
    } else { alert("Erro ao enviar: "+(json.erro||JSON.stringify(json))); }
  }catch(err){ console.error(err); alert("Erro ao enviar mensagem. Verifique CORS/Network."); }
  finally{ userTyping=false; btnEnviar.disabled=textarea.value.trim().length===0; }
}

/* =================== Enviar PDF =================== */
async function enviarPDF(event){
  const file = event.target.files[0];
  if(!file) return;
  if(!contatoSelecionado || !phoneIdAtual){ alert("Selecione uma conversa antes de enviar PDF"); return; }
  if(file.type !== "application/pdf"){ alert("Somente arquivos PDF s√£o permitidos"); return; }

  try{
    const res = await fetch(`${API_BASE}/api/upload/pdf`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({filename: file.name})
    });
    const json = await res.json();
    if(!json.ok){ alert("Erro ao gerar URL: "+json.erro); return; }

    await fetch(json.upload_url, { method: "PUT", headers: {"Content-Type": "application/pdf"}, body: file });

    const body = { phone_id: phoneIdAtual, file_url: json.file_url, original_filename: file.name };
    const sendRes = await fetch(`${API_BASE}/api/conversas/${contatoSelecionado}`, {
      method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)
    });
    const sendJson = await sendRes.json();
    if(sendJson.ok){ await carregarMensagens(true); }
    else { alert("Erro ao enviar PDF: "+(sendJson.erro||JSON.stringify(sendJson))); }
  }catch(err){
    console.error("Erro ao enviar PDF",err); alert("Erro ao enviar PDF");
  }finally{ event.target.value = ""; }
}

/* =================== Modal imagem =================== */
const imageModal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImg");
const closeModal = document.getElementById("closeModal");
function abrirModalImagem(src){ isModalOpen = true; modalImg.src = src; imageModal.classList.remove("hidden"); }
function fecharModal(){ imageModal.classList.add("hidden"); modalImg.src = ""; isModalOpen = false; }
closeModal.onclick = fecharModal;
imageModal.onclick = (e) => { if (e.target === imageModal) fecharModal(); };
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape"&&!imageModal.classList.contains("hidden")) fecharModal(); });

/* =================== Page visibility =================== */
document.addEventListener("visibilitychange",()=>{ if(!document.hidden){ if(filtrosAplicados) carregarContatos(); if(contatoSelecionado) carregarMensagens(true); } });

/* =================== Boot =================== */
loadTheme();
</script>
</body>
</html>
