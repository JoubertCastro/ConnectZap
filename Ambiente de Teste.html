<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äî ConnectZap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-50 text-slate-800">
  <header class="bg-blue-600 text-white py-4">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-xl sm:text-2xl font-semibold">üìä Dashboard ‚Äî ConnectZap</h1>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Filtros -->
    <section class="bg-white rounded-xl shadow-sm border p-4">
      <div class="flex flex-col gap-3">
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm text-slate-500 mr-1">Per√≠odo:</span>

          <!-- chips de per√≠odo (AJUSTE: classe chip) -->
          <button
            class="chip px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none"
            data-range="hoje">Hoje</button>
          <button
            class="chip px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none"
            data-range="7d">√öltimos 7 dias</button>
          <button
            class="chip px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none"
            data-range="30d">√öltimos 30 dias</button>
          <button
            class="chip px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none"
            data-range="mes">M√™s atual</button>
          <button
            class="chip px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none"
            data-range="custom">Personalizado</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm text-slate-500">In√≠cio</label>
            <input id="start" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
          </div>
          <div>
            <label class="text-sm text-slate-500">Fim</label>
            <input id="end" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
          </div>

          <!-- Filtros EXTRAS (Atendimentos + Hora a hora + Resumo) -->
          <div id="fltCarteira" class="hidden">
            <label class="text-sm text-slate-500">Carteira</label>
            <select id="carteira" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option value="">Todas</option>
            </select>
          </div>
          <div id="fltAgentes" class="hidden">
            <label class="text-sm text-slate-500">Agentes</label>
            <div class="relative">
              <button id="btnAgentes" type="button"
                class="w-full justify-between px-3 py-2 rounded-lg border border-slate-300 bg-white flex items-center gap-2">
                <span class="truncate">Todos</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20"
                  fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd" />
                </svg>
              </button>
              <!-- dropdown -->
              <div id="panelAgentes" class="hidden absolute z-20 mt-2 w-80 bg-white border rounded-lg shadow-lg p-2">
                <div class="flex items-center gap-2 mb-2">
                  <input id="agSearch" type="text" placeholder="Buscar agente..."
                    class="flex-1 px-2 py-1.5 border rounded-md text-sm">
                  <button id="agSelectAll"
                    class="text-xs px-2 py-1 rounded-md border bg-white hover:bg-slate-50">Selecionar todos</button>
                  <button id="agClear"
                    class="text-xs px-2 py-1 rounded-md border bg-white hover:bg-slate-50">Limpar</button>
                </div>
                <div id="agList" class="max-h-56 overflow-y-auto space-y-1"></div>
              </div>
            </div>
          </div>

          <!-- bot√µes -->
          <div class="flex items-end gap-2">
            <button id="btnClearDates"
              class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Limpar datas</button>
            <button id="btnAplicar"
              class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">Aplicar</button>
          </div>

          <!-- Filtro EXCLUSIVO da aba Mensagens -->
          <div id="fltNomeDisparo" class="md:col-span-2">
            <label class="text-sm text-slate-500">Nome do disparo</label>
            <input id="q" type="text" placeholder="Buscar..."
              class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
          </div>

          <!-- Filtro EXCLUSIVO da aba Hora a hora -->
          <div id="fltMotivo" class="hidden md:col-span-2">
            <label class="text-sm text-slate-500">Motivo de conclus√£o</label>
            <div class="relative">
              <button id="btnMotivos" type="button"
                class="w-full justify-between px-3 py-2 rounded-lg border border-slate-300 bg-white flex items-center gap-2">
                <span class="truncate">Todos</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20"
                  fill="currentColor">
                  <path fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd" />
                </svg>
              </button>
              <!-- dropdown -->
              <div id="panelMotivos"
                class="hidden absolute z-20 mt-2 w-[28rem] bg-white border rounded-lg shadow-lg p-2">
                <div class="flex items-center gap-2 mb-2">
                  <input id="motSearch" type="text" placeholder="Buscar motivo..."
                    class="flex-1 px-2 py-1.5 border rounded-md text-sm">
                  <button id="motSelectAll"
                    class="text-xs px-2 py-1 rounded-md border bg-white hover:bg-slate-50">Selecionar todos</button>
                  <button id="motClear"
                    class="text-xs px-2 py-1 rounded-md border bg-white hover:bg-slate-50">Limpar</button>
                </div>
                <div id="motList" class="max-h-56 overflow-y-auto space-y-1"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Abas -->
    <section class="bg-white rounded-xl shadow-sm border">
      <div class="p-3">
        <div class="inline-flex bg-slate-100 rounded-xl p-1">
          <button class="seg-btn seg-active" data-tab="mensagens">
            <span>‚úâÔ∏è</span><span>Mensagens</span>
          </button>
          <button class="seg-btn" data-tab="atendimentos">
            <span>üéß</span><span>Atendimentos</span>
          </button>
          <button class="seg-btn" data-tab="hora_hora">
            <span>‚è±Ô∏è</span><span>Hora a hora</span>
          </button>
          <button class="seg-btn" data-tab="resumo">
            <span>üìë</span><span>Resumo</span>
          </button>
        </div>
      </div>

      <!-- Aba: Mensagens -->
      <div id="tab-mensagens" class="p-4 space-y-6">
        <div id="cards-mensagens" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
          <div class="balloon">
            <div class="balloon-label">Total</div>
            <div id="k_total" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Enviados</div>
            <div id="k_env" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Entregues</div>
            <div id="k_ent" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Lidos</div>
            <div id="k_lido" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Delivery rate</div>
            <div id="k_dr" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Read rate</div>
            <div id="k_rr" class="balloon-value">‚Äî</div>
          </div>
        </div>

        <div class="space-y-2">
          <div class="text-sm text-slate-500">Entregues x Lidos por disparo</div>
          <div class="h-72"><canvas id="chartMensagens" class="w-full h-full"></canvas></div>
          <div id="chartMensagensEmpty" class="text-sm text-slate-500 hidden">Sem dados para o per√≠odo/filtros.</div>
        </div>

        <div class="overflow-hidden rounded-xl border">
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-slate-50 sticky top-0">
                <tr>
                  <th class="th">Disparo</th>
                  <th class="th">Grupo</th>
                  <th class="th">Data</th>
                  <th class="th text-right">Total</th>
                  <th class="th text-right">Entregues</th>
                  <th class="th text-right">Lidos</th>
                </tr>
              </thead>
              <tbody id="tbodyMensagens" class="bg-white"></tbody>
            </table>
          </div>
          <div id="tblEmpty" class="p-3 text-sm text-slate-500 hidden">Nenhum envio encontrado.</div>
        </div>
      </div>

      <!-- Aba: Atendimentos -->
      <div id="tab-atendimentos" class="p-4 space-y-6 hidden">
        <div id="cards-atend" class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="balloon">
            <div class="balloon-label">Em atendimento</div>
            <div id="a_em" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Conclu√≠dos</div>
            <div id="a_conc" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">TMA</div>
            <div id="a_tma" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">1¬™ resposta</div>
            <div id="a_tmr" class="balloon-value">‚Äî</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-2">
            <div class="text-sm text-slate-500">Motivos de conclus√£o</div>
            <div class="h-72"><canvas id="chartMotivos" class="w-full h-full"></canvas></div>
            <div id="chartMotivosEmpty" class="text-sm text-slate-500 hidden">Sem dados de motivos.</div>
          </div>

          <div class="space-y-2">
            <div class="text-sm text-slate-500">S√©ries di√°rias ‚Äî In / Out / Conclu√≠dos</div>
            <div class="h-72"><canvas id="chartSeries" class="w-full h-full"></canvas></div>
            <div id="chartSeriesEmpty" class="text-sm text-slate-500 hidden">Sem s√©ries no per√≠odo.</div>
          </div>
        </div>
      </div>

      <!-- Aba: Hora a hora -->
      <div id="tab-hora_hora" class="p-4 space-y-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-2">
            <div class="text-sm text-slate-500">Conclu√≠dos por hora (0‚Äì23)</div>
            <div class="h-72"><canvas id="chartHHConc" class="w-full h-full"></canvas></div>
            <div id="hhConcEmpty" class="text-sm text-slate-500 hidden">Sem dados de conclu√≠dos.</div>
          </div>
          <div class="space-y-2">
            <div class="text-sm text-slate-500">Inbound por hora (0‚Äì23)</div>
            <div class="h-72"><canvas id="chartHHIn" class="w-full h-full"></canvas></div>
            <div id="hhInEmpty" class="text-sm text-slate-500 hidden">Sem dados de inbound.</div>
          </div>
        </div>
      </div>

      <!-- Aba: Resumo (carteira -> agentes) -->
      <div id="tab-resumo" class="p-4 space-y-4 hidden">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">Resumo por carteira. Clique para expandir e ver os agentes.</div>
        </div>
        <div id="resumoList" class="space-y-2"></div>
        <div id="resumoEmpty" class="text-sm text-slate-500 hidden">Sem dados para o per√≠odo/filtros.</div>
      </div>

    </section>

    <!-- Avisos -->
    <div id="alert" class="hidden rounded-lg border border-amber-300 bg-amber-50 text-amber-800 p-3 text-sm"></div>
  </main>

  <style>
    .seg-btn {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem .75rem;
      border-radius: .75rem;
      font-weight: 600;
      color: #334155;
      transition: all .15s;
    }

    .seg-btn:hover {
      background: #fff;
    }

    .seg-active {
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .06);
      color: #1d4ed8
    }

    .balloon {
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
      border-radius: 9999px;
      padding: 14px 18px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
      text-align: center;
    }

    .balloon-label {
      font-size: .7rem;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: #64748b;
    }

    .balloon-value {
      font-size: 1.75rem;
      font-weight: 700;
      margin-top: 2px;
    }

    .th {
      padding: .5rem .75rem;
      text-align: left;
      font-size: .75rem;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: #64748b;
    }

    td {
      padding: .5rem .75rem;
      border-top: 1px solid #eef2f7;
    }

    .chip {
      transition: background-color .15s, border-color .15s, color .15s;
    }

    .chip--active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }

    .chip:focus-visible {
      outline: 2px solid rgba(37, 99, 235, .35);
      outline-offset: 2px;
    }

    .acc {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      overflow: hidden
    }

    .acc-header {
      display: flex;
      align-items: center;
      gap: .75rem;
      width: 100%;
      text-align: left;
      padding: .75rem 1rem;
    }

    .acc-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(80px, auto));
      gap: .5rem;
      align-items: center;
      flex: none;
    }

    .acc-k {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .chev {
      transition: transform .15s ease;
    }

    .rot-90 {
      transform: rotate(90deg);
    }

    .acc-body {
      border-top: 1px solid #eef2f7;
      padding: .5rem 1rem .75rem 1rem;
    }

    .mini-th {
      font-size: .7rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .acc-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://dashboard-production-4c05.up.railway.app";
    const phoneIdMap = {
      "828473960349364": "ConnectZap",
      "805610009301153": "Banco PAN",
      "727586317113885": "Recovery PJ",
      "864779140046932": "Recovery PF",
      "802977069563598": "Recovery PF",
      "873637622491517": "Mercado Pago Cobran√ßa",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero",
      "829210283602406": "Arc4U",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };

    // ===== DOM =====
    const startEl = document.getElementById("start");
    const endEl = document.getElementById("end");
    const qEl = document.getElementById("q");

    const fltCarteira = document.getElementById("fltCarteira");
    const fltAgentes = document.getElementById("fltAgentes");
    const fltNomeDisparo = document.getElementById("fltNomeDisparo");
    const fltMotivo = document.getElementById("fltMotivo");

    const cartEl = document.getElementById("carteira");
    const btnAplicar = document.getElementById("btnAplicar");
    const btnClearDates = document.getElementById("btnClearDates");

    const alertEl = document.getElementById("alert");
    const chips = [...document.querySelectorAll("[data-range]")];

    // tabs
    const segBtns = [...document.querySelectorAll(".seg-btn")];
    const tabMensagens = document.getElementById("tab-mensagens");
    const tabAtend = document.getElementById("tab-atendimentos");
    const tabHoraHora = document.getElementById("tab-hora_hora");
    const tabResumo = document.getElementById("tab-resumo");

    // KPIs Mensagens
    const k_total = document.getElementById("k_total");
    const k_env = document.getElementById("k_env");
    const k_ent = document.getElementById("k_ent");
    const k_lido = document.getElementById("k_lido");
    const k_dr = document.getElementById("k_dr");
    const k_rr = document.getElementById("k_rr");

    // Tabela
    const tbodyMensagens = document.getElementById("tbodyMensagens");
    const tblEmpty = document.getElementById("tblEmpty");

    // Charts
    let chartMensagens, chartMotivos, chartSeries;
    let chartHHConc, chartHHIn;
    const chartMensagensEmpty = document.getElementById("chartMensagensEmpty");
    const chartMotivosEmpty = document.getElementById("chartMotivosEmpty");
    const chartSeriesEmpty = document.getElementById("chartSeriesEmpty");
    const hhConcEmpty = document.getElementById("hhConcEmpty");
    const hhInEmpty = document.getElementById("hhInEmpty");

    // KPIs Atend
    const a_em = document.getElementById("a_em");
    const a_conc = document.getElementById("a_conc");
    const a_tma = document.getElementById("a_tma");
    const a_tmr = document.getElementById("a_tmr");

    // ===== Multi-select Agentes =====
    const btnAgentes = document.getElementById("btnAgentes");
    const panelAgentes = document.getElementById("panelAgentes");
    const agSearch = document.getElementById("agSearch");
    const agSelectAll = document.getElementById("agSelectAll");
    const agClear = document.getElementById("agClear");
    const agList = document.getElementById("agList");

    let agentsAll = [];
    const selectedAgents = new Set();

    function togglePanelAgentes(show) {
      panelAgentes.classList.toggle("hidden", !show);
    }
    btnAgentes?.addEventListener("click", (e) => {
      e.stopPropagation();
      togglePanelAgentes(panelAgentes.classList.contains("hidden"));
    });
    document.addEventListener("click", (e) => {
      if (panelAgentes && !panelAgentes.contains(e.target) && !btnAgentes?.contains(e.target)) {
        togglePanelAgentes(false);
      }
    });

    function renderAgentesList(filter = "") {
      if (!agList) return;
      agList.innerHTML = "";
      const term = filter.trim().toLowerCase();
      const data = agentsAll.filter(a => (a.nome || "").toLowerCase().includes(term));
      if (!data.length) {
        agList.innerHTML = '<div class="text-sm text-slate-500 px-2 py-1.5">Nenhum agente</div>';
        return;
      }
      data.forEach(a => {
        const id = `ag_${a.codigo_do_agente}`;
        const row = document.createElement("label");
        row.className = "flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 rounded";
        row.innerHTML = `
          <input type="checkbox" class="w-4 h-4" id="${id}" value="${a.codigo_do_agente}" ${selectedAgents.has(String(a.codigo_do_agente)) ? "checked" : ""}>
          <span class="text-sm">${a.nome || ("Agente " + a.codigo_do_agente)}</span>
        `;
        row.querySelector("input").addEventListener("change", (ev) => {
          const v = String(ev.target.value);
          if (ev.target.checked) selectedAgents.add(v); else selectedAgents.delete(v);
          updateAgentesButtonLabel();
        });
        agList.appendChild(row);
      });
    }
    function updateAgentesButtonLabel() {
      if (!btnAgentes) return;
      const n = selectedAgents.size;
      btnAgentes.querySelector("span").textContent = n ? `${n} selecionado${n > 1 ? "s" : ""}` : "Todos";
    }
    agSearch?.addEventListener("input", () => renderAgentesList(agSearch.value));
    agSelectAll?.addEventListener("click", () => {
      agentsAll.forEach(a => selectedAgents.add(String(a.codigo_do_agente)));
      renderAgentesList(agSearch?.value || "");
      updateAgentesButtonLabel();
    });
    agClear?.addEventListener("click", () => {
      selectedAgents.clear();
      renderAgentesList(agSearch?.value || "");
      updateAgentesButtonLabel();
    });

    // ===== Multi-select Motivos =====
    const btnMotivos = document.getElementById("btnMotivos");
    const panelMotivos = document.getElementById("panelMotivos");
    const motSearch = document.getElementById("motSearch");
    const motSelectAll = document.getElementById("motSelectAll");
    const motClear = document.getElementById("motClear");
    const motList = document.getElementById("motList");

    let motivosAll = [];
    const selectedMotivos = new Set();

    function togglePanelMotivos(show) {
      panelMotivos.classList.toggle("hidden", !show);
    }
    btnMotivos?.addEventListener("click", (e) => {
      e.stopPropagation();
      togglePanelMotivos(panelMotivos.classList.contains("hidden"));
    });
    document.addEventListener("click", (e) => {
      if (panelMotivos && !panelMotivos.contains(e.target) && !btnMotivos?.contains(e.target)) {
        togglePanelMotivos(false);
      }
    });

    function renderMotivosList(filter = "") {
      if (!motList) return;
      motList.innerHTML = "";
      const term = filter.trim().toLowerCase();
      const data = motivosAll.filter(m => (m || "").toLowerCase().includes(term));
      if (!data.length) {
        motList.innerHTML = '<div class="text-sm text-slate-500 px-2 py-1.5">Nenhum motivo</div>';
        return;
      }
      data.forEach(m => {
        const id = `mot_${m.replace(/\s+/g, '_')}`;
        const row = document.createElement("label");
        row.className = "flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 rounded";
        row.innerHTML = `
          <input type="checkbox" class="w-4 h-4" id="${id}">
          <span class="text-sm">${m}</span>
        `;
        const chk = row.querySelector("input");
        chk.checked = selectedMotivos.has(m);
        chk.addEventListener("change", (ev) => {
          if (ev.target.checked) selectedMotivos.add(m); else selectedMotivos.delete(m);
          updateMotivosButtonLabel();
        });
        motList.appendChild(row);
      });
    }
    function updateMotivosButtonLabel() {
      if (!btnMotivos) return;
      const n = selectedMotivos.size;
      btnMotivos.querySelector("span").textContent = n ? `${n} motivo${n > 1 ? "s" : ""}` : "Todos";
    }
    motSearch?.addEventListener("input", () => renderMotivosList(motSearch.value));
    motSelectAll?.addEventListener("click", () => {
      motivosAll.forEach(m => selectedMotivos.add(m));
      renderMotivosList(motSearch?.value || "");
      updateMotivosButtonLabel();
    });
    motClear?.addEventListener("click", () => {
      selectedMotivos.clear();
      renderMotivosList(motSearch?.value || "");
      updateMotivosButtonLabel();
    });

    // ===== Utils =====
    function setAlert(msg) { alertEl.textContent = msg || ""; alertEl.classList.toggle("hidden", !msg); }
    function toPct(part, total) { if (!total) return "‚Äî"; return ((part / total) * 100).toFixed(1) + "%"; }
    function fmtDurSec(s) {
      if (s == null) return "‚Äî";
      const m = Math.floor(s / 60), sec = s % 60;
      if (m >= 60) { const h = Math.floor(m / 60), mm = m % 60; return `${h}h ${mm}m`; }
      return `${m}m ${sec}s`;
    }
    function selectedAgentesCSV() { return [...selectedAgents].join(","); }
    function selectedMotivosCSV() { return [...selectedMotivos].join(","); }
    const HOUR_LABELS = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, "0") + "h");

    function getActiveTab() {
      return document.querySelector(".seg-btn.seg-active")?.dataset.tab || "mensagens";
    }

    function buildParams(tab) {
      const p = new URLSearchParams();
      if (startEl.value) p.set("start", startEl.value);
      if (endEl.value) p.set("end", endEl.value);

      if (tab === "mensagens") {
        if (qEl.value) p.set("q", qEl.value.trim());
      } else if (tab === "atendimentos" || tab === "hora_hora" || tab === "resumo") {
        if (cartEl.value) p.set("phone_id", cartEl.value);
        const ags = selectedAgentesCSV();
        if (ags && tab !== "resumo") p.set("agentes", ags);
        if (tab === "hora_hora") {
          const m = selectedMotivosCSV();
          if (m) p.set("motivo", m);
        }
      }
      p.set("tab", tab);
      return p.toString();
    }

    function savePermalink() {
      const tab = getActiveTab();
      const qs = buildParams(tab);
      const url = location.origin + location.pathname + (qs ? "?" + qs : "");
      history.replaceState(null, "", url);
    }

    let pendingAgents = null;
    let pendingMotivos = null;

    function readFromQS() {
      const u = new URL(location.href);
      const tabQS = u.searchParams.get("tab");
      if (tabQS === "atendimentos" || tabQS === "hora_hora" || tabQS === "resumo") {
        segBtns.forEach(x => x.classList.remove("seg-active"));
        segBtns.find(b => b.dataset.tab === tabQS)?.classList.add("seg-active");
        tabMensagens.classList.toggle("hidden", tabQS !== "mensagens");
        tabAtend.classList.toggle("hidden", tabQS !== "atendimentos");
        tabHoraHora.classList.toggle("hidden", tabQS !== "hora_hora");
        tabResumo.classList.toggle("hidden", tabQS !== "resumo");
        toggleFiltersForTab(tabQS);
      }

      startEl.value = u.searchParams.get("start") || startEl.value;
      endEl.value = u.searchParams.get("end") || endEl.value;

      qEl.value = u.searchParams.get("q") || "";

      const phone = u.searchParams.get("phone_id") || "";
      if (phone) cartEl.value = phone;
      const agentesQS = u.searchParams.get("agentes");
      if (agentesQS) pendingAgents = agentesQS.split(",").map(String);

      const motivosQS = u.searchParams.get("motivo");
      if (motivosQS) pendingMotivos = motivosQS.split(",");
    }

    // AJUSTE: destacar chip ativo via classe dedicada
    function highlightChip(ch) {
      document.querySelectorAll(".chip").forEach(x => x.classList.remove("chip--active"));
      if (ch) ch.classList.add("chip--active");
    }
    const chipsElems = document.querySelectorAll(".chip");
    chipsElems.forEach(ch => ch.addEventListener("click", () => {
      const k = ch.dataset.range;
      if (k !== "custom") setQuickRange(k);
      highlightChip(ch);
    }));

    function setQuickRange(kind) {
      const now = new Date();
      const pad = n => String(n).padStart(2, "0");
      const toISO = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      let a = new Date(), b = new Date();
      if (kind === "hoje") { /* a=b hoje */ }
      if (kind === "7d") { a.setDate(now.getDate() - 6); }
      if (kind === "30d") { a.setDate(now.getDate() - 29); }
      if (kind === "mes") { a = new Date(now.getFullYear(), now.getMonth(), 1); }
      startEl.value = toISO(a); endEl.value = toISO(b);
    }

    // Toggle filtros conforme aba
    function toggleFiltersForTab(tab) {
      const isMsg = tab === "mensagens";
      const isHora = tab === "hora_hora";
      const isRes = tab === "resumo";
      fltNomeDisparo.classList.toggle("hidden", !isMsg);
      fltCarteira.classList.toggle("hidden", isMsg ? true : false);
      fltAgentes.classList.toggle("hidden", isMsg || isRes);
      fltMotivo.classList.toggle("hidden", !isHora);
    }

    // ===== Data loaders (existentes) =====
    async function loadAgentes() {
      const selPhone = cartEl.value || "";
      const url = `${API_BASE}/api/agentes` + (selPhone ? `?phone_id=${encodeURIComponent(selPhone)}` : "");
      const res = await fetch(url);
      const data = await res.json();
      agentsAll = data.map(a => ({ codigo_do_agente: String(a.codigo_do_agente), nome: a.nome || ("Agente " + a.codigo_do_agente) }));
      selectedAgents.clear();
      if (pendingAgents && pendingAgents.length) {
        pendingAgents.forEach(v => selectedAgents.add(String(v)));
        pendingAgents = null;
      }
      agSearch && (agSearch.value = "");
      renderAgentesList("");
      updateAgentesButtonLabel();
    }
    async function loadMotivosOptions() {
      const qsAt = buildParams("atendimentos");
      const res = await fetch(`${API_BASE}/api/atendimentos/motivos?${qsAt}`);
      if (!res.ok) throw new Error("Falha ao carregar motivos");
      const dados = await res.json();
      motivosAll = [...new Set(dados.map(d => d.motivo).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'pt-BR'));
      if (pendingMotivos && pendingMotivos.length) {
        selectedMotivos.clear();
        pendingMotivos.forEach(m => {
          const hit = motivosAll.find(x => x.toLowerCase() === m.toLowerCase());
          if (hit) selectedMotivos.add(hit);
        });
        pendingMotivos = null;
      }
      motSearch && (motSearch.value = "");
      renderMotivosList("");
      updateMotivosButtonLabel();
    }
    async function loadResumoMensagens(qs) {
      const res = await fetch(`${API_BASE}/api/dashboard/resumo?${qs}`);
      if (!res.ok) throw new Error("Falha no resumo (mensagens)");
      return res.json();
    }
    async function loadEnvios(qs) {
      const res = await fetch(`${API_BASE}/api/dashboard/envios?${qs}`);
      if (!res.ok) throw new Error("Falha nos envios");
      return res.json();
    }
    async function loadAtendResumo(qs) {
      const res = await fetch(`${API_BASE}/api/atendimentos/resumo?${qs}`);
      if (!res.ok) throw new Error("Falha no resumo (atendimentos)");
      return res.json();
    }
    async function loadAtendMotivos(qs) {
      const res = await fetch(`${API_BASE}/api/atendimentos/motivos?${qs}`);
      if (!res.ok) throw new Error("Falha nos motivos");
      return res.json();
    }
    async function loadAtendSeries(qs) {
      const res = await fetch(`${API_BASE}/api/atendimentos/series?${qs}`);
      if (!res.ok) throw new Error("Falha nas s√©ries");
      return res.json();
    }
    async function loadHoraHora(qs) {
      const res = await fetch(`${API_BASE}/api/atendimentos/hora_hora?${qs}`);
      if (!res.ok) throw new Error("Falha no hora a hora");
      return res.json();
    }
    // Resumo
    async function loadExtratoMotivos(qs) {
      const res = await fetch(`${API_BASE}/api/dashboard/extrato_motivos?${qs}`);
      if (!res.ok) throw new Error("Falha no extrato de motivos");
      return res.json();
    }

    // ===== Render =====
    async function renderMensagens() {
      const qs = buildParams("mensagens");
      savePermalink();

      try {
        setAlert("");
        k_total.textContent = k_env.textContent = k_ent.textContent = k_lido.textContent = "‚Ä¶";
        const r = await loadResumoMensagens(qs);
        const total = r.total || 0, env = r.enviados || 0, ent = r.entregues || 0, lido = r.lidos || 0;
        k_total.textContent = total; k_env.textContent = env; k_ent.textContent = ent; k_lido.textContent = lido;
        k_dr.textContent = toPct(ent, env || total);
        k_rr.textContent = toPct(lido, ent || total);
      } catch (e) { setAlert(e.message); }

      try {
        tbodyMensagens.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-slate-500">Carregando‚Ä¶</td></tr>';
        const data = await loadEnvios(qs);
        tbodyMensagens.innerHTML = "";
        tblEmpty.classList.toggle("hidden", data.length > 0);

        const labels = [], entregues = [], lidos = [];
        data.forEach(e => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.nome_disparo || "-"}</td>
            <td>${e.grupo_trabalho || "-"}</td>
            <td>${e.criado_em ? new Date(e.criado_em).toLocaleString("pt-BR") : "-"}</td>
            <td class="text-right">${e.total || 0}</td>
            <td class="text-right">${e.entregues || 0}</td>
            <td class="text-right">${e.lidos || 0}</td>`;
          tbodyMensagens.appendChild(tr);
          labels.push(e.nome_disparo || "(sem nome)");
          entregues.push(e.entregues || 0);
          lidos.push(e.lidos || 0);
        });

        if (chartMensagens) { chartMensagens.destroy(); chartMensagens = null; }
        document.getElementById("chartMensagens").classList.remove("hidden");
        chartMensagensEmpty.classList.add("hidden");

        if (labels.length === 0) {
          document.getElementById("chartMensagens").classList.add("hidden");
          chartMensagensEmpty.classList.remove("hidden");
        } else {
          const ctx = document.getElementById("chartMensagens").getContext("2d");
          chartMensagens = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                { label: "Entregues", data: entregues, backgroundColor: "#3b82f6", stack: "s" },
                { label: "Lidos", data: lidos, backgroundColor: "#10b981", stack: "s" }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              resizeDelay: 200,
              plugins: { legend: { position: "top" } },
              scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
            }
          });
        }
      } catch (e) { setAlert(e.message); }
    }

    async function renderAtend() {
      const qs = buildParams("atendimentos");
      savePermalink();

      try {
        a_em.textContent = a_conc.textContent = a_tma.textContent = a_tmr.textContent = "‚Ä¶";
        const r = await loadAtendResumo(qs);
        a_em.textContent = r.em_atendimento ?? 0;
        a_conc.textContent = r.concluidos ?? 0;
        a_tma.textContent = fmtDurSec(r.tma_segundos);
        a_tmr.textContent = fmtDurSec(r.tmr_segundos);
      } catch (e) { setAlert("Aba Atendimentos ‚Äî " + e.message); }

      try {
        const dados = await loadAtendMotivos(qs);
        if (chartMotivos) { chartMotivos.destroy(); chartMotivos = null; }
        document.getElementById("chartMotivos").classList.remove("hidden");
        chartMotivosEmpty.classList.add("hidden");

        if (!dados.length) {
          document.getElementById("chartMotivos").classList.add("hidden");
          chartMotivosEmpty.classList.remove("hidden");
        } else {
          chartMotivos = new Chart(document.getElementById("chartMotivos").getContext("2d"), {
            type: "pie",
            data: { labels: dados.map(d => d.motivo), datasets: [{ data: dados.map(d => d.qtd) }] },
            options: { responsive: true, maintainAspectRatio: false, resizeDelay: 200 }
          });
        }
      } catch (e) { setAlert("Motivos ‚Äî " + e.message); }

      try {
        const s = await loadAtendSeries(qs);

        const map = {};
        (s.mensagens || []).forEach(r => {
          const k = r.dia;
          map[k] = map[k] || { in: 0, out: 0, conc: 0 };
          map[k].in = r.inbound;
          map[k].out = r.outbound;
        });
        (s.concluidos || []).forEach(r => {
          const k = r.dia;
          map[k] = map[k] || { in: 0, out: 0, conc: 0 };
          map[k].conc = r.concluidos;
        });

        function diaToTS(d) {
          if (!d) return 0;
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
            const [y, m, day] = d.split("-").map(Number);
            return Date.UTC(y, m - 1, day);
          }
          if (/^\d{2}\/\d{2}(?:\/\d{4})?$/.test(d)) {
            const [day, mon, year] = d.split("/");
            const y = year ? Number(year) : new Date().getFullYear();
            return Date.UTC(Number(y), Number(mon) - 1, Number(day));
          }
          const t = Date.parse(d);
          return isNaN(t) ? 0 : t;
        }

        const rows = Object.keys(map)
          .map(k => ({ dia: k, ts: diaToTS(k), ...map[k] }))
          .sort((a, b) => a.ts - b.ts);

        const dias = rows.map(r => r.dia);
        const inb = rows.map(r => r.in);
        const outb = rows.map(r => r.out);
        const conc = rows.map(r => r.conc);

        if (chartSeries) { chartSeries.destroy(); chartSeries = null; }
        document.getElementById("chartSeries").classList.remove("hidden");
        chartSeriesEmpty.classList.add("hidden");

        if (!dias.length) {
          document.getElementById("chartSeries").classList.add("hidden");
          chartSeriesEmpty.classList.remove("hidden");
        } else {
          chartSeries = new Chart(document.getElementById("chartSeries").getContext("2d"), {
            type: "line",
            data: {
              labels: dias,
              datasets: [
                { label: "Inbound", data: inb, borderColor: "#2563eb", backgroundColor: "rgba(37,99,235,.15)", fill: true, tension: .3 },
                { label: "Outbound", data: outb, borderColor: "#10b981", backgroundColor: "rgba(16,185,129,.15)", fill: true, tension: .3 },
                { label: "Conclu√≠dos", data: conc, borderColor: "#f59e0b", backgroundColor: "rgba(245,158,11,.15)", fill: true, tension: .3 }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false, resizeDelay: 200,
              plugins: { legend: { position: "top" } },
              scales: { y: { beginAtZero: true } }
            }
          });
        }
      } catch (e) { setAlert("S√©ries ‚Äî " + e.message); }
    }

    // ===== Resumo =====
    const resumoList = document.getElementById("resumoList");
    const resumoEmpty = document.getElementById("resumoEmpty");

    function formatNum(n) { return Number(n || 0).toLocaleString("pt-BR"); }

    function aggByCarteira(rows) {
      const map = new Map();
      rows.forEach(r => {
        const key = r.carteira || "(Sem carteira)";
        const cur = map.get(key) || {
          carteira: key,
          atendimentos: 0,
          cliente_ficou_inativo: 0,
          duvidas_gerais: 0,
          solicitou_2a_via_de_boleto: 0,
          recusou_a_proposta: 0,
          realizou_negociacao: 0,
          agentes: []
        };
        cur.atendimentos += Number(r.atendimentos || 0);
        cur.cliente_ficou_inativo += Number(r.cliente_ficou_inativo || 0);
        cur.duvidas_gerais += Number(r.duvidas_gerais || 0);
        cur.solicitou_2a_via_de_boleto += Number(r.solicitou_2a_via_de_boleto || 0);
        cur.recusou_a_proposta += Number(r.recusou_a_proposta || 0);
        cur.realizou_negociacao += Number(r.realizou_negociacao || 0);
        cur.agentes.push({
          codigo_do_agente: r.codigo_do_agente,
          nome_agente: r.nome_agente,
          atendimentos: r.atendimentos,
          cliente_ficou_inativo: r.cliente_ficou_inativo,
          duvidas_gerais: r.duvidas_gerais,
          solicitou_2a_via_de_boleto: r.solicitou_2a_via_de_boleto,
          recusou_a_proposta: r.recusou_a_proposta,
          realizou_negociacao: r.realizou_negociacao,
        });
        map.set(key, cur);
      });
      return Array.from(map.values()).sort((a, b) => b.atendimentos - a.atendimentos);
    }

    function carteiraRowTemplate(c) {
      const total = c.atendimentos || 0;
      const pct = (x) => total ? ((x / total) * 100).toFixed(1) + "%" : "‚Äî";
      return `
        <div class="acc" data-carteira="${c.carteira}">
          <button class="acc-header hover:bg-slate-50" title="${c.carteira}">
            <svg class="w-4 h-4 text-slate-500 chev" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
            <div class="flex-1 font-semibold acc-name">${c.carteira}</div><!-- AJUSTE: sem quebra, com ellipsis -->
            <div class="acc-grid text-sm">
              <div class="acc-k"><span class="text-slate-500">Atend.</span> <span class="font-semibold">${formatNum(total)}</span></div>
              <div class="acc-k"><span class="text-slate-500">Inativo</span> <span class="font-semibold">${formatNum(c.cliente_ficou_inativo)}</span> <span class="text-slate-500">(${pct(c.cliente_ficou_inativo)})</span></div>
              <div class="acc-k"><span class="text-slate-500">D√∫vidas</span> <span class="font-semibold">${formatNum(c.duvidas_gerais)}</span> <span class="text-slate-500">(${pct(c.duvidas_gerais)})</span></div>
              <div class="acc-k"><span class="text-slate-500">2¬™ via</span> <span class="font-semibold">${formatNum(c.solicitou_2a_via_de_boleto)}</span> <span class="text-slate-500">(${pct(c.solicitou_2a_via_de_boleto)})</span></div>
              <div class="acc-k"><span class="text-slate-500">Recusou</span> <span class="font-semibold">${formatNum(c.recusou_a_proposta)}</span> <span class="text-slate-500">(${pct(c.recusou_a_proposta)})</span></div>
              <div class="acc-k"><span class="text-slate-500">Negoc.</span> <span class="font-semibold">${formatNum(c.realizou_negociacao)}</span> <span class="text-slate-500">(${pct(c.realizou_negociacao)})</span></div>
            </div>
          </button>
          <div class="acc-body hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr>
                    <th class="mini-th text-left">C√≥digo</th>
                    <th class="mini-th text-left">Agente</th>
                    <th class="mini-th text-right">Atend.</th>
                    <th class="mini-th text-right">Inativo</th>
                    <th class="mini-th text-right">D√∫vidas</th>
                    <th class="mini-th text-right">2¬™ via</th>
                    <th class="mini-th text-right">Recusou</th>
                    <th class="mini-th text-right">Negoc.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`;
    }

    function renderResumoRows(groups) {
      resumoList.innerHTML = "";
      if (!groups.length) { resumoEmpty.classList.remove("hidden"); return; }
      resumoEmpty.classList.add("hidden");
      const frag = document.createDocumentFragment();
      groups.forEach(c => {
        const wrapper = document.createElement("div");
        wrapper.innerHTML = carteiraRowTemplate(c);
        const acc = wrapper.firstElementChild;
        const header = acc.querySelector(".acc-header");
        const body = acc.querySelector(".acc-body");
        const chev = acc.querySelector(".chev");
        header.addEventListener("click", () => {
          const open = body.classList.contains("hidden");
          document.querySelectorAll("#resumoList .acc-body").forEach(el => el.classList.add("hidden"));
          document.querySelectorAll("#resumoList .chev").forEach(el => el.classList.remove("rot-90"));
          if (open) {
            body.classList.remove("hidden");
            chev.classList.add("rot-90");
            fillAgentesTable(body.querySelector("tbody"), c.agentes);
          }
        });
        frag.appendChild(acc);
      });
      resumoList.appendChild(frag);
    }

    function fillAgentesTable(tbody, agentes) {
      tbody.innerHTML = "";
      const rows = [...agentes].sort((a, b) => b.atendimentos - a.atendimentos);
      rows.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-1.5 pr-2">${a.codigo_do_agente ?? "-"}</td>
          <td class="py-1.5 pr-2">${a.nome_agente ?? "-"}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.atendimentos)}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.cliente_ficou_inativo)}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.duvidas_gerais)}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.solicitou_2a_via_de_boleto)}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.recusou_a_proposta)}</td>
          <td class="py-1.5 pl-2 text-right">${formatNum(a.realizou_negociacao)}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function renderResumo() {
      const qs = buildParams("resumo");
      savePermalink();
      setAlert("");
      try {
        const data = await loadExtratoMotivos(qs);
        const rows = data.map(r => ({
          codigo_do_agente: r.codigo_do_agente ?? r[0],
          nome_agente: r.nome_agente ?? r[1],
          carteira: r.carteira ?? r[2],
          atendimentos: Number(r.atendimentos ?? r[3] ?? 0),
          cliente_ficou_inativo: Number(r.cliente_ficou_inativo ?? r[4] ?? 0),
          duvidas_gerais: Number(r.duvidas_gerais ?? r[5] ?? 0),
          solicitou_2a_via_de_boleto: Number((r.solicitou_2¬™_via_de_boleto ?? r.solicitou_2a_via_de_boleto) ?? r[6] ?? 0),
          recusou_a_proposta: Number(r.recusou_a_proposta ?? r[7] ?? 0),
          realizou_negociacao: Number(r.realizou_negociacao ?? r[8] ?? 0),
        }));
        const groups = aggByCarteira(rows);
        window.__lastResumo = groups;
        renderResumoRows(groups);
      } catch (e) {
        setAlert("Resumo ‚Äî " + e.message);
        resumoList.innerHTML = "";
        resumoEmpty.classList.remove("hidden");
      }
    }

    async function render() {
      const tab = getActiveTab();
      if (tab === "mensagens") await renderMensagens();
      else if (tab === "atendimentos") {
        if (cartEl.value && !agentsAll.length) await loadAgentes();
        await renderAtend();
      } else if (tab === "hora_hora") {
        if (cartEl.value && !agentsAll.length) await loadAgentes();
        await loadMotivosOptions();
        await renderHoraHora();
      } else { // resumo
        await renderResumo();
      }
    }

    // ===== Eventos =====
    segBtns.forEach(btn => btn.addEventListener("click", async () => {
      segBtns.forEach(x => x.classList.remove("seg-active"));
      btn.classList.add("seg-active");
      const tab = btn.dataset.tab;
      tabMensagens.classList.toggle("hidden", tab !== "mensagens");
      tabAtend.classList.toggle("hidden", tab !== "atendimentos");
      tabHoraHora.classList.toggle("hidden", tab !== "hora_hora");
      tabResumo.classList.toggle("hidden", tab !== "resumo");
      toggleFiltersForTab(tab);
      if ((tab === "atendimentos" || tab === "hora_hora") && cartEl.value) {
        await loadAgentes();
      }
      if (tab === "hora_hora") {
        await loadMotivosOptions();
      }
      render();
    }));

    // preencher carteiras
    (function fillCarteiras() {
      const frag = document.createDocumentFragment();
      Object.keys(phoneIdMap).forEach(id => {
        const opt = document.createElement("option");
        opt.value = id; opt.textContent = phoneIdMap[id];
        frag.appendChild(opt);
      });
      document.getElementById("carteira").appendChild(frag);
    })();

    // mudan√ßas de carteira
    document.getElementById("carteira").addEventListener("change", async () => {
      const tab = getActiveTab();
      if (tab !== "mensagens") {
        await loadAgentes();
        if (tab === "hora_hora") await loadMotivosOptions();
      }
      if (tab === "resumo") {
        await renderResumo();
      }
    });

    // Limpar datas
    btnClearDates.addEventListener("click", () => {
      startEl.value = ""; endEl.value = "";
      document.querySelectorAll(".chip").forEach(x => x.classList.remove("chip--active"));
    });

    // Aplicar
    btnAplicar.addEventListener("click", render);

    // ===== Init =====
    function initDefaults(){
      setQuickRange("hoje");
      const chipHoje = document.querySelector('.chip[data-range="hoje"]');
      highlightChip(chipHoje);
    }

    initDefaults();
    readFromQS();
    toggleFiltersForTab(getActiveTab());
    render();
  </script>
</body>

</html>