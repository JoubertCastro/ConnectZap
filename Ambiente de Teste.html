<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConnectZap — Supervisão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --ok: #16a34a;
      --warn: #d97706;
      --err: #dc2626
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px
    }

    .kpi {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      background: #fff;
      padding: 14px
    }

    .pill {
      padding: 2px 8px;
      border-radius: 9999px;
      background: #f3f4f6;
      font-size: 12px
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
      margin-right: 6px
    }

    .dot.online {
      background: #16a34a
    }

    .dot.offline {
      background: #9ca3af
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px
    }

    .btn-primary {
      background: #2563eb;
      color: #fff
    }

    .btn-muted {
      background: #f3f4f6
    }

    details>summary {
      cursor: pointer;
      list-style: none
    }

    details>summary::-webkit-details-marker {
      display: none
    }

    .summary-row {
      display: flex;
      align-items: center;
      gap: .5rem
    }

    details.card summary {
      border-radius: 12px;
      padding: 10px 12px;
      margin: -8px;
      margin-bottom: 8px;
      transition: background .18s ease, box-shadow .18s ease, transform .12s ease;
    }

    details.card:hover summary {
      background: #f9fafb;
    }

    details.card[open] summary {
      background: #eef2ff;
      box-shadow: 0 0 0 2px #6366f1 inset;
    }

    details.card summary:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px #2563eb inset;
    }

    .table-th {
      white-space: nowrap;
      font-weight: 600;
      font-size: 12px;
      color: #374151;
    }

    .table-td {
      vertical-align: top;
      font-size: 13px;
    }

    .switch {
      position: relative; display: inline-block; width: 42px; height: 24px;
    }
    .switch input {opacity:0;width:0;height:0;}
    .slider {
      position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;transition:.2s;border-radius:9999px;
    }
    .slider:before {
      position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.2s;border-radius:9999px; box-shadow: 0 1px 2px rgba(0,0,0,.12);
    }
    input:checked + .slider {background:#22c55e;}
    input:checked + .slider:before {transform: translateX(18px);}
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-lg md:text-xl font-semibold">ConnectZap — Supervisão</h1>
        <span class="hidden md:inline text-sm text-gray-500">Administração de agentes & visão operacional</span>
      </div>
      <div class="flex items-center gap-2">
        <label for="filtroGlobalCarteira" class="text-sm text-gray-600">Carteira:</label>
        <select id="filtroGlobalCarteira" class="border rounded-md p-2 text-sm">
          <option value="">Todas</option>
        </select>
        <span id="autoInfo" class="text-xs text-gray-400">Atualização automática a cada 10s</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="kpi">
        <div class="text-gray-500 text-sm">Agentes online</div>
        <div id="kpiOnlineTotal" class="text-3xl font-bold mt-1">—</div>
        <div id="kpiOnlineCarteiras" class="text-xs text-gray-500 mt-2 space-x-1"></div>
      </div>
      <div class="kpi">
        <div class="text-gray-500 text-sm">Conversas em andamento</div>
        <div id="kpiEmAndamento" class="text-3xl font-bold mt-1">—</div>
        <div class="text-xs text-gray-500 mt-2">Somatório dos tickets dos agentes online</div>
      </div>
      <div class="kpi">
        <div class="text-gray-500 text-sm">Pendentes na fila (24hrs)</div>
        <div id="kpiPendentesFila" class="text-3xl font-bold mt-1">—</div>
        <div id="kpiPendentesPorCarteira" class="text-xs text-gray-500 mt-2 space-x-1"></div>
      </div>
      <div class="kpi">
        <div class="text-gray-500 text-sm">Última atualização</div>
        <div id="kpiAtualizado" class="text-lg font-semibold mt-1">—</div>
        <div id="kpiMsg" class="text-xs mt-2 text-gray-500"></div>
      </div>
    </section>

    <!-- Cadastrar/Editar -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <details class="card">
        <summary class="summary-row">
          <span class="font-bold text-lg">Cadastrar agente</span>
          <span class="pill">formulário</span>
        </summary>
        <div class="mt-3">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
              <label class="text-sm text-gray-700">Código (SIC)</label>
              <input id="cadCodigo" type="number" min="1" class="w-full border rounded-md p-2" placeholder="Ex: 123" />
            </div>
            <div class="md:col-span-2">
              <label class="text-sm text-gray-700">Nome completo</label>
              <input id="cadNome" type="text" class="w-full border rounded-md p-2" placeholder="Nome e sobrenome" />
            </div>
            <div>
              <label class="text-sm text-gray-700">Carteira</label>
              <select id="cadCarteira" class="w-full border rounded-md p-2"></select>
            </div>
            <div>
              <label class="text-sm text-gray-700">Origem BD</label>
              <select id="cadOrigem" class="w-full border rounded-md p-2">
                <option value="">Selecione</option>
                <option>Bd4</option>
                <option>Bd5</option>
                <option>Bd7</option>
                <option>Bd8</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2 mt-4">
            <button id="btnCadastrar" class="btn btn-primary">Salvar</button>
            <div id="cadMsg" class="text-sm hidden"></div>
          </div>
        </div>
      </details>

      <details class="card">
        <summary class="summary-row">
          <span class="font-bold text-lg">Buscar e editar agente</span>
          <span class="pill">edição</span>
        </summary>
        <div class="mt-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-gray-700">Código (SIC)</label>
              <input id="buscaCodigo" type="number" min="1" class="w-full border rounded-md p-2"
                placeholder="Ex: 123" />
            </div>
            <div class="flex items-end">
              <button id="btnBuscar" class="btn btn-primary w-full">Buscar</button>
            </div>
            <div class="flex items-end">
              <button id="btnLimparBusca" class="btn btn-muted w-full">Limpar</button>
            </div>
          </div>

          <div id="editBox" class="mt-4 hidden border rounded-lg p-3 bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div>
                <span class="text-xs text-gray-500 block">Código</span>
                <span id="edCodigo" class="font-medium">—</span>
              </div>
              <div class="md:col-span-2">
                <span class="text-xs text-gray-500 block">Nome</span>
                <span id="edNome" class="font-medium">—</span>
              </div>
              <div>
                <label class="text-sm text-gray-700">Carteira</label>
                <select id="edCarteira" class="w-full border rounded-md p-2"></select>
              </div>
              <div>
                <span class="text-xs text-gray-500 block">Origem BD</span>
                <span id="edOrigem" class="font-medium">—</span>
              </div>
            </div>
            <div class="flex gap-2 mt-3">
              <button id="btnSalvarEdicao" class="btn btn-primary">Salvar carteira</button>
              <div id="editMsg" class="text-sm hidden"></div>
            </div>
          </div>
        </div>
      </details>
    </section>

    <!-- Agentes online -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Agentes online agora</h2>
        <span class="pill"><span class="dot online"></span> Online</span>
      </div>

      <div class="overflow-auto border rounded-lg mt-3">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left px-3 py-2 table-th">Código</th>
              <th class="text-left px-3 py-2 table-th">Nome</th>
              <th class="text-left px-3 py-2 table-th">Carteira</th>
              <th class="text-left px-3 py-2 table-th">Desde</th>
              <th class="text-left px-3 py-2 table-th">Tickets ativos</th>
              <th class="text-left px-3 py-2 table-th">Inatividade</th>
              <th class="text-left px-3 py-2 table-th">Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyOnline"></tbody>
        </table>
      </div>
      <div id="onlineMsg" class="text-sm text-gray-500 mt-2"></div>
    </section>

    <!-- Limite de tickets -->
    <details class="card">
      <summary class="summary-row">
        <span class="font-bold text-lg">Configurar limite de tickets em andamento</span>
        <span class="pill">por carteira</span>
      </summary>
      <div class="mt-3 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-700">Carteira</label>
            <select id="tlCarteira" class="w-full border rounded-md p-2"></select>
          </div>
          <div>
            <label class="text-sm text-gray-700">Máximo por operador (0 = sem limite)</label>
            <input id="tlLimit" type="number" min="0" max="50" value="0" class="w-full border rounded-md p-2">
          </div>
          <div class="flex items-end gap-2">
            <button id="btnSalvarTicketsLimit" class="btn btn-primary w-full">Salvar limite</button>
            <button id="btnResetTicketsLimit" class="btn btn-muted w-full">Zerar</button>
          </div>
        </div>

        <div class="text-xs text-gray-500">
          Observação: o limite é aplicado <b>por carteira</b> no momento do “Pegar Próxima”. Se o agente já tiver
          atingido o teto naquela carteira, o sistema bloqueia a reserva e retorna uma mensagem para o Agente.
        </div>

        <div>
          <div class="text-sm text-gray-700 mb-2">Carteiras configuradas:</div>
          <div id="tlChips" class="flex flex-wrap gap-2"></div>
          <div id="tlMsg" class="text-sm text-gray-600 mt-2"></div>
        </div>
      </div>
    </details>

    <!-- ====== NOVO BLOCO: Painel de Avisos ====== -->
    <details class="card" open>
      <summary class="summary-row">
        <span class="font-bold text-lg">Painel de avisos</span>
        <span class="pill">criar / listar / editar</span>
      </summary>

      <!-- Filtros e ações -->
      <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="text-sm text-gray-700">Filtrar por carteira</label>
          <select id="pvFiltroCarteira" class="w-full border rounded-md p-2">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="flex items-center gap-3">
          <label class="text-sm text-gray-700 flex items-center gap-2">
            <span>Somente ativos</span>
            <label class="switch">
              <input id="pvSomenteAtivos" type="checkbox" checked>
              <span class="slider"></span>
            </label>
          </label>
        </div>
        <div class="flex items-center gap-2">
          <button id="pvBtnRecarregar" class="btn btn-muted">Recarregar</button>
          <span id="pvMsg" class="text-sm text-gray-600"></span>
        </div>
      </div>

      <!-- Criar novo aviso -->
      <div class="mt-4 p-3 border rounded-lg bg-gray-50">
        <div class="font-medium mb-2">Novo aviso</div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">Título</label>
            <input id="pvNovoTitulo" type="text" class="w-full border rounded-md p-2" placeholder="Ex: Atenção, não deixe o cliente esperando resposta">
          </div>
          <div>
            <label class="text-sm text-gray-700">Ordem do aviso (0 até 10)</label>
            <input id="pvNovoPrioridade" type="number" min="0" max="10" value="0" class="w-full border rounded-md p-2">
          </div>
          <div class="flex items-end gap-2">
            <label class="text-sm text-gray-700 flex items-center gap-2">
              <input id="pvNovoEnabled" type="checkbox" checked>
              Ativo
            </label>
          </div>
          <div class="md:col-span-4">
            <label class="text-sm text-gray-700">Conteúdo</label>
            <textarea id="pvNovoConteudo" rows="3" class="w-full border rounded-md p-2" placeholder="Mensagem detalhada"></textarea>
          </div>
          <div class="md:col-span-4">
            <label class="text-sm text-gray-700">Carteiras (opcional)</label>
            <div id="pvNovoCarteiras" class="flex flex-wrap gap-2 mt-1"></div>
            <div class="text-xs text-gray-500 mt-1">Se nenhuma carteira for marcada, o aviso será <b>global</b>.</div>
          </div>
          <div class="md:col-span-4 flex gap-2">
            <button id="pvBtnCriar" class="btn btn-primary">Criar aviso</button>
            <span id="pvNovoMsg" class="text-sm"></span>
          </div>
        </div>
      </div>

      <!-- Editar aviso (inline) -->
      <div id="pvEditBox" class="hidden mt-4 p-3 border rounded-lg bg-indigo-50/40">
        <div class="flex items-center justify-between">
          <div class="font-medium">Editar aviso <span id="pvEditId" class="px-2 py-[2px] rounded bg-indigo-100 text-indigo-900 text-xs"></span></div>
          <button id="pvBtnCancelarEdicao" class="btn btn-muted">Cancelar</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">Título</label>
            <input id="pvEditTitulo" type="text" class="w-full border rounded-md p-2">
          </div>
          <div>
            <label class="text-sm text-gray-700">Prioridade (0..10)</label>
            <input id="pvEditPrioridade" type="number" min="0" max="10" class="w-full border rounded-md p-2" value="0">
          </div>
          <div class="flex items-end gap-2">
            <label class="text-sm text-gray-700 flex items-center gap-2">
              <input id="pvEditEnabled" type="checkbox"> Ativo
            </label>
          </div>
          <div class="md:col-span-4">
            <label class="text-sm text-gray-700">Conteúdo</label>
            <textarea id="pvEditConteudo" rows="3" class="w-full border rounded-md p-2"></textarea>
          </div>
          <div class="md:col-span-4">
            <label class="text-sm text-gray-700">Carteiras</label>
            <div id="pvEditCarteiras" class="flex flex-wrap gap-2 mt-1"></div>
          </div>
          <div class="md:col-span-4 flex gap-2">
            <button id="pvBtnSalvarEdicao" class="btn btn-primary">Salvar alterações</button>
            <span id="pvEditMsg" class="text-sm"></span>
          </div>
        </div>
      </div>

      <!-- Lista de avisos -->
      <div class="mt-4">
        <div class="text-sm text-gray-700 mb-2">Avisos cadastrados</div>
        <div class="overflow-auto border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left px-3 py-2 table-th">ID</th>
                <th class="text-left px-3 py-2 table-th">Ativo</th>
                <th class="text-left px-3 py-2 table-th">Prior.</th>
                <th class="text-left px-3 py-2 table-th">Título</th>
                <th class="text-left px-3 py-2 table-th">Carteiras</th>
                <th class="text-left px-3 py-2 table-th">Criado em</th>
                <th class="text-left px-3 py-2 table-th">Ações</th>
              </tr>
            </thead>
            <tbody id="pvTbody"></tbody>
          </table>
        </div>
      </div>
    </details>
    <!-- ====== FIM Painel de Avisos ====== -->

    <!-- ====== BLOCO: Textos padrão (existente) ====== -->
    <details class="card">
      <summary class="summary-row">
        <span class="font-bold text-lg">Gerenciar textos padrão</span>
        <span class="pill">novo/editar/apagar</span>
      </summary>

      <div class="mt-3 space-y-6">
        <!-- NOVO TEXTO -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-700">Chave (única)</label>
            <input id="txChaveNovo" type="text" class="w-full border rounded-md p-2" placeholder="ex: boas_vindas">
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">Texto</label>
            <textarea id="txConteudoNovo" rows="4" class="w-full border rounded-md p-2" placeholder="Conteúdo do texto padrão"></textarea>
          </div>
          <div class="md:col-span-3 flex gap-2">
            <button id="btnNovoTexto" class="btn btn-primary">Salvar novo texto</button>
            <div id="txNovoMsg" class="text-sm hidden"></div>
          </div>
        </div>

        <hr class="border-gray-200">

        <!-- EDITAR TEXTO -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-700">ID (opcional)</label>
            <input id="txIdEdit" type="number" min="1" class="w-full border rounded-md p-2" placeholder="ex: 12">
            <span class="text-xs text-gray-500">Preencha <b>ID</b> ou <b>Chave</b>.</span>
          </div>
          <div>
            <label class="text-sm text-gray-700">Chave (alternativa ao ID)</label>
            <input id="txChaveEdit" type="text" class="w-full border rounded-md p-2" placeholder="ex: boas_vindas">
          </div>
          <div>
            <label class="text-sm text-gray-700">Novo texto</label>
            <textarea id="txConteudoEdit" rows="4" class="w-full border rounded-md p-2" placeholder="Conteúdo atualizado"></textarea>
          </div>
          <div class="md:col-span-3 flex gap-2">
            <button id="btnEditarTexto" class="btn btn-primary">Aplicar edição</button>
            <div id="txEditarMsg" class="text-sm hidden"></div>
          </div>
        </div>

        <hr class="border-gray-200">

        <!-- APAGAR TEXTO -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-700">ID (opcional)</label>
            <input id="txIdDelete" type="number" min="1" class="w-full border rounded-md p-2" placeholder="ex: 12">
            <span class="text-xs text-gray-500">Preencha <b>ID</b> ou <b>Chave</b>.</span>
          </div>
          <div>
            <label class="text-sm text-gray-700">Chave (alternativa ao ID)</label>
            <input id="txChaveDelete" type="text" class="w-full border rounded-md p-2" placeholder="ex: boas_vindas">
          </div>
          <div class="flex items-end">
            <button id="btnApagarTexto" class="btn btn-muted w-full">Apagar texto</button>
          </div>
          <div class="md:col-span-3">
            <div id="txApagarMsg" class="text-sm hidden"></div>
          </div>
        </div>
      </div>
    </details>
    <!-- ====== FIM BLOCO Textos ====== -->
    <!-- Logout automático -->
    <details class="card">
      <summary class="summary-row">
        <span class="font-bold text-lg">Logout automático por carteira</span>
        <span class="pill">agendamento</span>
      </summary>
      <div class="mt-3 space-y-3">
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="lgEnabled" type="checkbox" class="w-4 h-4">
            Ativar logout automático
          </label>
          <label class="text-sm text-gray-700">Horário (HH:MM)
            <input id="lgTime" type="time" value="18:00" class="border rounded-md p-2 ml-2">
          </label>
        </div>
        <div>
          <div class="text-sm text-gray-700 mb-1">Carteiras para logout:</div>
          <div id="lgCarteiras" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
        </div>
        <div class="flex gap-2">
          <button id="btnSalvarLogout" class="btn btn-primary">Salvar configuração</button>
          <button id="btnForcarLogout" class="btn btn-muted">Forçar logout agora</button>
          <span id="lgMsg" class="text-sm text-gray-600"></span>
        </div>
      </div>
    </details>
  </main>

  <script>
    /* === Bases de API === */
    const API_BASE = (window.ATEND_API_BASE || "https://whatsapp-webhook-production-9a27.up.railway.app/api").replace(/\/+$/, ''); // fila/agentes + textos + painel
    const CONV_API = (window.CONV_API || "https://conversas-api-production.up.railway.app").replace(/\/+$/, ''); // conversas/limits

    /* === Carteiras === */
    const CARTEIRAS = [
      "ConnectZap", "Banco PAN", "Recovery PJ", "Recovery PF",
      "Mercado Pago Cobrança", "DivZero", "Arc4U", "Serasa", "Mercado Pago Vendas"
    ];

    /* === Helpers === */
    function showMsg(el, text, type = "ok") { el.classList.remove("hidden"); el.textContent = text; el.style.color = (type === "ok" ? "var(--ok)" : type === "warn" ? "var(--warn)" : "var(--err)"); }
    function hideMsg(el) { el.classList.add("hidden"); el.textContent = ""; el.style.color = ""; }
    function fmt(dt) { try { return new Date(dt).toLocaleString("pt-BR"); } catch { return dt || "—"; } }
    function fillSelect(sel, vals, includeEmpty = true) {
      sel.innerHTML = includeEmpty ? `<option value="">Todas</option>` : "";
      vals.forEach(v => { const o = document.createElement("option"); o.value = v; o.textContent = v; sel.appendChild(o); });
    }
    function sig(obj) { try { return JSON.stringify(obj); } catch { return String(obj); } }

    // >>> Helpers para inatividade
    function parseTempoInativo(v) {
      if (v == null) return null;
      if (typeof v === 'number' && isFinite(v)) return v;
      if (typeof v === 'string' && /^\d{1,2}:\d{2}:\d{2}$/.test(v)) {
        const [h, m, s] = v.split(':').map(n => parseInt(n, 10));
        return (h * 3600) + (m * 60) + s;
      }
      return null;
    }
    function fmtDuracao(seg) {
      if (seg == null) return '—';
      const h = Math.floor(seg / 3600);
      const m = Math.floor((seg % 3600) / 60);
      const s = Math.floor(seg % 60);
      const hh = h.toString().padStart(2, '0');
      const mm = m.toString().padStart(2, '0');
      const ss = s.toString().padStart(2, '0');
      return h > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
    }
    // <<< FIM helpers inatividade

    // >>> Helpers Painel de Avisos
    function makeCarteirasChecklist(containerEl, selected = new Set()) {
      containerEl.innerHTML = CARTEIRAS.map(c =>
        `<label class="flex items-center gap-2 text-sm border rounded-md p-2 bg-white">
          <input type="checkbox" value="${c}" ${selected.has(c) ? "checked" : ""}> ${c}
        </label>`
      ).join("");
    }
    function readChecklist(containerEl) {
      return Array.from(containerEl.querySelectorAll('input[type="checkbox"]:checked')).map(ch => ch.value);
    }
    function badge(str, variant = "muted") {
      const map = { muted: "bg-gray-100 text-gray-800", ok: "bg-green-100 text-green-800", warn: "bg-amber-100 text-amber-800", err: "bg-red-100 text-red-800", indigo: "bg-indigo-100 text-indigo-800", blue: "bg-blue-100 text-blue-800" };
      return `<span class="inline-block text-xs px-2 py-[2px] rounded ${map[variant] || map.muted}">${str}</span>`;
    }
    // <<< FIM Helpers Painel

    /* === Estados === */
    let filtroCarteira = "";
    let ultimoOnline = [];
    let mapaTicketsAtivos = {};
    let pendentesCarteiraAgg = [];
    let lastSig = { online: "", contagem: "", pendentes: "" };

    // Painel de Avisos estados
    let pvItems = [];
    let pvSomenteAtivos = true;
    let pvFiltroCar = "";
    let pvEditId = null;

    /* === Init UI === */
    (function initUI() {
      fillSelect(document.getElementById("filtroGlobalCarteira"), CARTEIRAS);
      const cadCarteira = document.getElementById("cadCarteira");
      cadCarteira.innerHTML = `<option value="">Selecione</option>` + CARTEIRAS.map(c => `<option>${c}</option>`).join("");
      const edCarteira = document.getElementById("edCarteira");
      fillSelect(edCarteira, CARTEIRAS, false);

      // logout checkboxes
      const wrap = document.getElementById("lgCarteiras");
      wrap.innerHTML = CARTEIRAS.map(c => `
        <label class="flex items-center gap-2 text-sm border rounded-md p-2 bg-white">
          <input type="checkbox" class="lg-check" value="${c}"> ${c}
        </label>
      `).join("");

      // bloco limites
      const tlCarteira = document.getElementById("tlCarteira");
      tlCarteira.innerHTML = `<option value="">Selecione</option>` + CARTEIRAS.map(c => `<option>${c}</option>`).join("");

      // Painel de Avisos: filtros e checklists
      fillSelect(document.getElementById("pvFiltroCarteira"), CARTEIRAS);
      makeCarteirasChecklist(document.getElementById("pvNovoCarteiras"));
      makeCarteirasChecklist(document.getElementById("pvEditCarteiras"));

      // carregar config de logout
      fetch(`${API_BASE}/supervisao/logout-config`).then(r => r.json()).then(cfg => {
        document.getElementById("lgEnabled").checked = !!cfg.enabled;
        document.getElementById("lgTime").value = (cfg.time || "18:00").slice(0, 5);
        const set = new Set(cfg.carteiras || []);
        document.querySelectorAll(".lg-check").forEach(ch => { ch.checked = set.has(ch.value); });
      }).catch(() => { });

      // carrega chips + valor inicial do limite
      carregarTicketsLimitList();

      // Painel de Avisos: primeira carga
      pvRecarregar();
    })();

    /* === Ciclo de atualização estável (1 requisição em voo) === */
    const REFRESH_MS = 10000;
    let refreshTimer = null;
    let refreshAbort = null;
    let isRefreshing = false;

    function scheduleRefresh(delay = REFRESH_MS) {
      clearTimeout(refreshTimer);
      refreshTimer = setTimeout(() => carregarTudo("auto"), delay);
    }

    // fetch JSON com timeout e abort composto
    async function fetchJSON(url, { signal, timeoutMs = 9000, ...init } = {}) {
      const own = new AbortController();
      const t = setTimeout(() => own.abort("timeout"), timeoutMs);

      // compor sinais (parent + timeout)
      let finalSignal = own.signal;
      if (signal) {
        const comp = new AbortController();
        signal.addEventListener("abort", () => comp.abort("parent"), { once: true });
        own.signal.addEventListener("abort", () => comp.abort("timeout"), { once: true });
        finalSignal = comp.signal;
      }

      try {
        const r = await fetch(url, { signal: finalSignal, ...init });
        const ct = r.headers.get("content-type") || "";
        if (!ct.includes("application/json")) return await r.text(); // fallback
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    async function carregarTudo(reason = "manual") {
      if (isRefreshing) { try { refreshAbort?.abort("superseded"); } catch { } }
      isRefreshing = true;
      refreshAbort = new AbortController();
      const { signal } = refreshAbort;

      const kpiMsg = document.getElementById("kpiMsg");
      kpiMsg.textContent = reason === "auto" ? "Atualizando…" : "Atualizando (forçado)…";

      try {
        const urlOnline = filtroCarteira ? `${API_BASE}/fila/status?carteira=${encodeURIComponent(filtroCarteira)}` : `${API_BASE}/fila/status`;
        const urlCnt = filtroCarteira ? `${CONV_API}/api/tickets/contagem_por_agente?carteira=${encodeURIComponent(filtroCarteira)}` : `${CONV_API}/api/tickets/contagem_por_agente`;
        const urlPend = `${API_BASE}/fila/pendentes_por_carteira`;

        const [lista, contagem, pend] = await Promise.allSettled([
          fetchJSON(urlOnline, { signal }),
          fetchJSON(urlCnt, { signal }),
          fetchJSON(urlPend, { signal })
        ]);

        // ONLINE
        if (lista.status === "fulfilled" && Array.isArray(lista.value)) {
          const sigOnline = sig(lista.value);
          if (sigOnline !== lastSig.online) {
            lastSig.online = sigOnline;
            ultimoOnline = lista.value;

            const porCarteira = {};
            ultimoOnline.forEach(a => { porCarteira[a.carteira] = (porCarteira[a.carteira] || 0) + 1; });

            document.getElementById("kpiOnlineTotal").textContent = ultimoOnline.length;
            const wrap = document.getElementById("kpiOnlineCarteiras");
            wrap.innerHTML = "";
            Object.entries(porCarteira).forEach(([car, qt]) => {
              const span = document.createElement("span");
              span.className = "pill";
              span.textContent = `${car}: ${qt}`;
              wrap.appendChild(span);
            });
          }
        }

        // CONTAGEM 
        if (contagem.status === "fulfilled" && contagem.value && contagem.value.ok && contagem.value.mapa) {
          const sigCont = sig(contagem.value.mapa);
          if (sigCont !== lastSig.contagem) {
            lastSig.contagem = sigCont;
            mapaTicketsAtivos = contagem.value.mapa;
          }
          const totalTickets = ultimoOnline.reduce((s, a) => {
            const key = `${a.codigo_do_agente}-${a.carteira}`;
            const val = mapaTicketsAtivos[key];

            const qtd = (typeof val === 'object' && val)
              ? (val.qtd ?? 0)
              : (Number(val) || 0);
            return s + qtd;
          }, 0);
          document.getElementById("kpiEmAndamento").textContent = totalTickets;
        }

        // PENDENTES
        if (pend.status === "fulfilled" && Array.isArray(pend.value)) {
          const sigPend = sig(pend.value);
          if (sigPend !== lastSig.pendentes) {
            lastSig.pendentes = sigPend;
            pendentesCarteiraAgg = pend.value; // 
          }

          const norm = s => (s || "")
            .normalize("NFD")
            .replace(/\p{Diacritic}/gu, "")
            .trim()
            .toLowerCase();

          const filtroN = norm(filtroCarteira);
          const filtrados = pendentesCarteiraAgg.filter(x => !filtroN || norm(x.carteira) === filtroN);

          const totalPend = filtrados.reduce((s, x) => s + (Number(x.total) || 0), 0);
          document.getElementById("kpiPendentesFila").textContent = totalPend;

          const chips = document.getElementById("kpiPendentesPorCarteira");
          chips.innerHTML = "";
          filtrados.forEach(({ carteira, total }) => {
            const span = document.createElement("span");
            span.className = "pill";
            span.textContent = `${carteira}: ${total}`;
            chips.appendChild(span);
          });
        }

        // Render tabela
        renderOnlineTable();

        document.getElementById("kpiAtualizado").textContent = new Date().toLocaleTimeString("pt-BR");
        kpiMsg.textContent = "OK";
      } catch (e) {
        if (String(e) !== "AbortError" && String(e) !== "superseded") {
          kpiMsg.textContent = "Falha ao atualizar. Verifique APIs.";
        }
      } finally {
        isRefreshing = false;
        scheduleRefresh();
      }
    }

    function renderOnlineTable() {
      const tbody = document.getElementById("tbodyOnline");
      tbody.innerHTML = "";
      const filtrados = ultimoOnline;

      filtrados.forEach(a => {
        const tr = document.createElement("tr");
        const key = `${a.codigo_do_agente}-${a.carteira}`;
        const val = mapaTicketsAtivos[key];

        const tickets = (typeof val === 'object' && val) ? (val.qtd ?? 0) : (mapaTicketsAtivos[key] ?? 0);

        let tempoSeg = null;
        if (val && typeof val === 'object') {
          tempoSeg = parseTempoInativo(val.tempo_inativo_seconds ?? val.tempo_inativo ?? null);
        }

        const critico = (tempoSeg != null && tempoSeg >= 3600); // 1h+

        tr.className = "border-b";
        if (critico) tr.classList.add("bg-amber-50");

        tr.innerHTML = `
          <td class="px-3 py-2 table-td">${a.codigo_do_agente}</td>
          <td class="px-3 py-2 table-td">${a.nome || "-"}</td>
          <td class="px-3 py-2 table-td">${a.carteira}</td>
          <td class="px-3 py-2 table-td">${fmt(a.data_hora)}</td>
          <td class="px-3 py-2 table-td">${tickets}</td>
          <td class="px-3 py-2 table-td ${critico ? 'text-amber-700 font-medium' : 'text-gray-600'}">
            ${tempoSeg != null ? fmtDuracao(tempoSeg) : '—'}
            ${critico ? '<span class="ml-2 inline-block px-2 py-[2px] text-[11px] rounded-full bg-amber-200 text-amber-900">1h+</span>' : ''}
          </td>
          <td class="px-3 py-2 table-td">
            <button class="px-2 py-1 bg-gray-100 rounded-md hover:bg-gray-200"
              onclick="forcarOffline(${a.codigo_do_agente}, '${a.carteira.replace(/'/g, "\\'")}')">Forçar offline</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      const msg = document.getElementById("onlineMsg");
      msg.textContent = filtrados.length ? "" : (filtroCarteira ? `Nenhum agente online na carteira "${filtroCarteira}".` : "Nenhum agente online no momento.");
    }

    async function forcarOffline(codigo, carteira) {
      if (!confirm(`Forçar o agente #${codigo} a ficar offline da carteira ${carteira}?`)) return;
      try {
        const r = await fetch(`${API_BASE}/fila/offline`, {
          method: "DELETE", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: codigo, carteira })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha ao forçar offline");
        carregarTudo("acao");
      } catch (e) { alert(e.message || "Erro ao forçar offline"); }
    }

    /* === Cadastro de agente === */
    document.getElementById("btnCadastrar").onclick = async () => {
      const msg = document.getElementById("cadMsg"); hideMsg(msg);
      const codigo = Number(document.getElementById("cadCodigo").value);
      const nome = (document.getElementById("cadNome").value || "").trim();
      const carteira = document.getElementById("cadCarteira").value;
      const origem = document.getElementById("cadOrigem").value;

      if (!codigo || !Number.isInteger(codigo)) return showMsg(msg, "Código precisa ser inteiro.", "warn");
      if (!nome || nome.split(" ").length < 2) return showMsg(msg, "Informe o nome completo.", "warn");
      if (!carteira) return showMsg(msg, "Selecione a carteira.", "warn");
      if (!origem) return showMsg(msg, "Selecione a origem BD.", "warn");

      try {
        const r = await fetch(`${API_BASE}/agentes`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codigo_do_agente: codigo, nome, carteira, origem_bd: origem })
        });
        const j = await r.json();
        if (!j.ok) return showMsg(msg, j.erro || "Erro ao cadastrar.", "err");
        showMsg(msg, "Agente cadastrado com sucesso.", "ok");

        document.getElementById("cadCodigo").value = "";
        document.getElementById("cadNome").value = "";
        document.getElementById("cadCarteira").value = "";
        document.getElementById("cadOrigem").value = "";

        carregarTudo("acao");
      } catch (e) { showMsg(msg, "Erro de rede ao cadastrar.", "err"); }
    };

    /* === Buscar/editar agente === */
    document.getElementById("btnBuscar").onclick = async () => {
      const cod = Number(document.getElementById("buscaCodigo").value);
      const msg = document.getElementById("editMsg"); hideMsg(msg);
      if (!cod || !Number.isInteger(cod)) return showMsg(msg, "Informe um código inteiro válido.", "warn");

      try {
        const r = await fetch(`${API_BASE}/agentes/${cod}`);
        const j = await r.json();
        if (!j.ok) {
          showMsg(msg, j.erro || "Não encontrado.", "warn");
          document.getElementById("editBox").classList.add("hidden");
          return;
        }
        const ag = j.agente;
        document.getElementById("edCodigo").textContent = ag.codigo_do_agente;
        document.getElementById("edNome").textContent = ag.nome;
        document.getElementById("edCarteira").value = ag.carteira;
        document.getElementById("edOrigem").textContent = ag.origem_bd;
        document.getElementById("editBox").classList.remove("hidden");
      } catch (e) { showMsg(msg, "Erro ao buscar agente.", "err"); }
    };
    document.getElementById("btnLimparBusca").onclick = () => {
      document.getElementById("buscaCodigo").value = "";
      document.getElementById("editBox").classList.add("hidden");
      hideMsg(document.getElementById("editMsg"));
    };
    document.getElementById("btnSalvarEdicao").onclick = async () => {
      const msg = document.getElementById("editMsg"); hideMsg(msg);
      const codigo = Number(document.getElementById("edCodigo").textContent);
      const nova = document.getElementById("edCarteira").value;
      if (!nova) return showMsg(msg, "Selecione uma carteira.", "warn");

      try {
        const r = await fetch(`${API_BASE}/agentes/${codigo}`, {
          method: "PUT", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ carteira: nova })
        });
        const j = await r.json();
        if (!j.ok) return showMsg(msg, j.erro || "Erro ao atualizar carteira.", "err");
        showMsg(msg, "Carteira atualizada.", "ok");
        carregarTudo("acao");
      } catch (e) { showMsg(msg, "Erro de rede ao salvar.", "err"); }
    };

    /* === Limite de tickets por carteira === */
    async function carregarTicketsLimitList() {
      try {
        const list = await fetch(`${CONV_API}/api/supervisao/tickets-limit`).then(r => r.json());
        renderTicketsLimitChips(Array.isArray(list) ? list : []);
      } catch {
        renderTicketsLimitChips([]);
      }
    }
    function renderTicketsLimitChips(items) {
      const wrap = document.getElementById("tlChips");
      wrap.innerHTML = "";
      if (!items.length) {
        wrap.innerHTML = `<span class="text-xs text-gray-500">Nenhuma carteira configurada — limite padrão 0 (sem restrição).</span>`;
        return;
      }
      items.forEach(({ carteira, limit_per_agent }) => {
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = `${carteira}: ${limit_per_agent}`;
        wrap.appendChild(span);
      });
    }
    async function carregarTicketsLimitValor(carteira) {
      const tlMsg = document.getElementById("tlMsg");
      if (!carteira) { document.getElementById("tlLimit").value = 0; return; }
      tlMsg.textContent = "Carregando...";
      try {
        const j = await fetch(`${CONV_API}/api/supervisao/tickets-limit?carteira=${encodeURIComponent(carteira)}`).then(r => r.json());
        document.getElementById("tlLimit").value = Number(j.limit_per_agent || 0);
        tlMsg.textContent = "";
      } catch (e) { tlMsg.textContent = "Falha ao carregar valor."; }
    }
    async function salvarTicketsLimit(limit, carteira) {
      const tlMsg = document.getElementById("tlMsg");
      tlMsg.textContent = "Salvando...";
      try {
        const r = await fetch(`${CONV_API}/api/supervisao/tickets-limit`, {
          method: "PUT", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ carteira, limit_per_agent: Number(limit || 0) })
        });
        const j = await r.json();
        tlMsg.textContent = j.ok ? "Limite salvo." : (j.erro || "Erro ao salvar.");
        await carregarTicketsLimitList();
      } catch (e) { tlMsg.textContent = "Erro de rede ao salvar."; }
    }

    document.getElementById("tlCarteira").addEventListener("change", (e) => {
      const car = e.target.value || "";
      carregarTicketsLimitValor(car);
    });
    document.getElementById("btnSalvarTicketsLimit").onclick = async () => {
      const carteira = document.getElementById("tlCarteira").value;
      const v = Number(document.getElementById("tlLimit").value || 0);
      const tlMsg = document.getElementById("tlMsg");
      if (!carteira) { tlMsg.textContent = "Selecione uma carteira."; return; }
      if (!Number.isInteger(v) || v < 0 || v > 50) { tlMsg.textContent = "Informe um valor entre 0 e 50."; return; }
      await salvarTicketsLimit(v, carteira);
    };
    document.getElementById("btnResetTicketsLimit").onclick = async () => {
      const carteira = document.getElementById("tlCarteira").value;
      const tlMsg = document.getElementById("tlMsg");
      if (!carteira) { tlMsg.textContent = "Selecione uma carteira."; return; }
      document.getElementById("tlLimit").value = 0;
      await salvarTicketsLimit(0, carteira);
    };

    /* === BLOCO Textos padrão (existente) === */
    function buildIdOrChavePayload(idVal, chaveVal) {
      const payload = {};
      const id = Number(idVal);
      const chave = (chaveVal || "").trim();
      if (Number.isInteger(id) && id > 0) payload.id = id;
      if (chave) payload.chave = chave;
      return payload;
    }

    // Novo texto
    document.getElementById("btnNovoTexto").onclick = async () => {
      const msg = document.getElementById("txNovoMsg"); hideMsg(msg);
      const chave = (document.getElementById("txChaveNovo").value || "").trim();
      const texto = (document.getElementById("txConteudoNovo").value || "").trim();

      if (!chave) return showMsg(msg, "Informe a chave (única) do texto.", "warn");
      if (!texto) return showMsg(msg, "Informe o conteúdo do texto.", "warn");

      try {
        const r = await fetch(`${API_BASE}/textos/novo_texto`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chave, texto })
        });
        const j = await r.json();
        if (!j.ok) return showMsg(msg, j.erro || "Erro ao salvar novo texto.", "err");
        showMsg(msg, "Texto cadastrado com sucesso.", "ok");
        document.getElementById("txChaveNovo").value = "";
        document.getElementById("txConteudoNovo").value = "";
      } catch (e) { showMsg(msg, "Erro de rede ao salvar texto.", "err"); }
    };

    // Editar texto
    document.getElementById("btnEditarTexto").onclick = async () => {
      const msg = document.getElementById("txEditarMsg"); hideMsg(msg);
      const idVal = document.getElementById("txIdEdit").value;
      const chaveVal = document.getElementById("txChaveEdit").value;
      const texto = (document.getElementById("txConteudoEdit").value || "").trim();

      if (!texto) return showMsg(msg, "Informe o novo conteúdo.", "warn");
      const base = buildIdOrChavePayload(idVal, chaveVal);
      if (!base.id && !base.chave) return showMsg(msg, "Informe ID ou Chave para localizar o registro.", "warn");

      try {
        const r = await fetch(`${API_BASE}/textos/editar_texto`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...base, texto })
        });
        const j = await r.json();
        if (!j.ok) return showMsg(msg, j.erro || "Erro ao editar texto.", "err");
        showMsg(msg, "Texto atualizado com sucesso.", "ok");
        document.getElementById("txIdEdit").value = "";
        document.getElementById("txChaveEdit").value = "";
        document.getElementById("txConteudoEdit").value = "";
      } catch (e) { showMsg(msg, "Erro de rede ao editar texto.", "err"); }
    };

    // Apagar texto
    document.getElementById("btnApagarTexto").onclick = async () => {
      const msg = document.getElementById("txApagarMsg"); hideMsg(msg);
      const idVal = document.getElementById("txIdDelete").value;
      const chaveVal = document.getElementById("txChaveDelete").value;

      const base = buildIdOrChavePayload(idVal, chaveVal);
      if (!base.id && !base.chave) return showMsg(msg, "Informe ID ou Chave para apagar.", "warn");

      if (!confirm(`Confirmar exclusão do texto (${base.id ? 'ID ' + base.id : 'chave ' + base.chave})?`)) return;

      try {
        const r = await fetch(`${API_BASE}/textos/apagar_texto`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(base)
        });
        const j = await r.json();
        if (!j.ok) return showMsg(msg, j.erro || "Erro ao apagar texto.", "err");
        showMsg(msg, "Texto apagado com sucesso.", "ok");
        document.getElementById("txIdDelete").value = "";
        document.getElementById("txChaveDelete").value = "";
      } catch (e) { showMsg(msg, "Erro de rede ao apagar texto.", "err"); }
    };

    /* === Logout automático === */
    document.getElementById("btnSalvarLogout").onclick = async () => {
      const lgMsg = document.getElementById("lgMsg");
      const enabled = document.getElementById("lgEnabled").checked;
      const time = document.getElementById("lgTime").value || "18:00";
      const carteiras = Array.from(document.querySelectorAll(".lg-check:checked")).map(x => x.value);
      lgMsg.textContent = "Salvando...";
      try {
        const r = await fetch(`${API_BASE}/supervisao/logout-config`, {
          method: "PUT", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enabled, time, carteiras })
        });
        const j = await r.json();
        lgMsg.textContent = j.ok ? "Configuração salva." : (j.erro || "Erro ao salvar.");
      } catch (e) { lgMsg.textContent = "Erro de rede ao salvar."; }
    };
    document.getElementById("btnForcarLogout").onclick = async () => {
      const lgMsg = document.getElementById("lgMsg");
      const carteiras = Array.from(document.querySelectorAll(".lg-check:checked")).map(x => x.value);
      if (!carteiras.length) { lgMsg.textContent = "Selecione ao menos uma carteira."; return; }
      if (!confirm(`Forçar logout agora das carteiras:\n- ${carteiras.join("\n- ")}`)) return;
      lgMsg.textContent = "Executando...";
      try {
        const r = await fetch(`${API_BASE}/fila/forcar_logout`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ carteiras })
        });
        const j = await r.json();
        lgMsg.textContent = j.ok ? `Logout concluído. Afetados: ${j.afetados}` : (j.erro || "Erro ao forçar logout.");
        carregarTudo("acao");
      } catch (e) { lgMsg.textContent = "Erro de rede ao forçar logout."; }
    };

    /* === Eventos globais === */
    document.getElementById("filtroGlobalCarteira").addEventListener("change", (e) => {
      filtroCarteira = e.target.value || "";
      carregarTudo("filtro");
    });

    /* === Painel de Avisos: lógica === */
    async function pvRecarregar() {
      const msg = document.getElementById("pvMsg");
      msg.textContent = "Carregando...";
      pvSomenteAtivos = document.getElementById("pvSomenteAtivos").checked;
      pvFiltroCar = document.getElementById("pvFiltroCarteira").value || "";

      try {
        // GET básico (sem parâmetros obrigatórios). Se sua API suportar filtros, pode-se anexar querystring aqui.
        let url = `${API_BASE}/painel/avisos`;
        const qs = [];
        if (pvSomenteAtivos) qs.push("enabled_only=1");
        if (pvFiltroCar) qs.push(`carteira=${encodeURIComponent(pvFiltroCar)}`);
        if (qs.length) url += "?" + qs.join("&");

        const data = await fetchJSON(url);
        pvItems = Array.isArray(data) ? data : (data?.avisos || []); // aceita {avisos:[...]} ou array direto
        pvRenderLista();
        msg.textContent = `${pvItems.length} avisos`;
      } catch (e) {
        pvItems = [];
        pvRenderLista();
        msg.textContent = "Falha ao carregar.";
      }
    }

    function pvRenderLista() {
      const tbody = document.getElementById("pvTbody");
      tbody.innerHTML = "";
      if (!pvItems.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="px-3 py-2 text-sm text-gray-500" colspan="7">Nenhum aviso encontrado.</td>`;
        tbody.appendChild(tr);
        return;
      }

      // Ordena por prioridade desc e created_at desc, se disponíveis
      const items = [...pvItems].sort((a, b) => {
        const pa = Number(a.prioridade ?? 0), pb = Number(b.prioridade ?? 0);
        if (pb !== pa) return pb - pa;
        const da = new Date(a.created_at || 0).getTime();
        const db = new Date(b.created_at || 0).getTime();
        return db - da;
      });

      items.forEach(av => {
        const tr = document.createElement("tr");
        tr.className = "border-b align-top";
        const carteiras = Array.isArray(av.carteiras) ? av.carteiras : [];
        const enabled = !!av.enabled;
        const deleted = !!av.deleted_at;

        tr.innerHTML = `
          <td class="px-3 py-2 table-td">${av.id ?? "-"}</td>
          <td class="px-3 py-2 table-td">
            ${enabled ? badge("Ativo", "ok") : badge("Inativo", "warn")}
            ${deleted ? `<div class="mt-1">${badge("Removido", "err")}</div>` : ""}
          </td>
          <td class="px-3 py-2 table-td">${Number(av.prioridade ?? 0)}</td>
          <td class="px-3 py-2 table-td">
            <div class="font-medium">${(av.titulo || "—")}</div>
            <div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">${(av.conteudo || "").slice(0, 400)}${(av.conteudo||"").length>400?"…":""}</div>
          </td>
          <td class="px-3 py-2 table-td">
            ${carteiras.length ? carteiras.map(c => badge(c, "blue")).join(" ") : badge("Global", "indigo")}
          </td>
          <td class="px-3 py-2 table-td">
            <div>${fmt(av.created_at)}</div>
            ${av.updated_at ? `<div class="text-xs text-gray-500">upd: ${fmt(av.updated_at)}</div>` : ""}
          </td>
          <td class="px-3 py-2 table-td">
            <div class="flex flex-wrap gap-2">
              <button class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200" onclick="pvToggleEnabled(${av.id}, ${enabled ? 'false' : 'true'})">${enabled ? 'Desativar' : 'Ativar'}</button>
              <button class="px-2 py-1 bg-indigo-100 text-indigo-900 rounded hover:bg-indigo-200" onclick="pvAbrirEdicao(${av.id})">Editar</button>
              <button class="px-2 py-1 bg-amber-100 text-amber-900 rounded hover:bg-amber-200" onclick="pvRemover(${av.id})">Remover</button>
              <button class="px-2 py-1 bg-red-100 text-red-900 rounded hover:bg-red-200" onclick="pvApagarDef(${av.id})">Apagar definitivo</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Criar
    document.getElementById("pvBtnCriar").onclick = async () => {
      const m = document.getElementById("pvNovoMsg");
      m.textContent = "";
      const titulo = (document.getElementById("pvNovoTitulo").value || "").trim();
      const conteudo = (document.getElementById("pvNovoConteudo").value || "").trim();
      const prioridade = Number(document.getElementById("pvNovoPrioridade").value || 0);
      const enabled = document.getElementById("pvNovoEnabled").checked;
      const carteiras = readChecklist(document.getElementById("pvNovoCarteiras"));

      if (!titulo) { m.textContent = "Informe o título."; m.style.color = "var(--warn)"; return; }
      if (!conteudo) { m.textContent = "Informe o conteúdo."; m.style.color = "var(--warn)"; return; }
      if (!Number.isInteger(prioridade) || prioridade < 0 || prioridade > 10) { m.textContent = "Prioridade deve ser 0..10."; m.style.color = "var(--warn)"; return; }

      try {
        m.textContent = "Salvando...";
        const r = await fetch(`${API_BASE}/painel/novo_texto`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ titulo, conteudo, prioridade, enabled, carteiras })
        });
        const j = await r.json();
        if (!j.ok) { m.textContent = j.erro || "Erro ao salvar."; m.style.color = "var(--err)"; return; }
        m.textContent = "Criado com sucesso!";
        m.style.color = "var(--ok)";
        document.getElementById("pvNovoTitulo").value = "";
        document.getElementById("pvNovoConteudo").value = "";
        document.getElementById("pvNovoPrioridade").value = "0";
        document.getElementById("pvNovoEnabled").checked = true;
        document.querySelectorAll("#pvNovoCarteiras input[type='checkbox']").forEach(ch => ch.checked = false);
        pvRecarregar();
      } catch (e) {
        m.textContent = "Erro de rede.";
        m.style.color = "var(--err)";
      }
    };

    // Abrir edição
    window.pvAbrirEdicao = (id) => {
      const item = pvItems.find(x => x.id === id);
      if (!item) return;
      pvEditId = id;
      document.getElementById("pvEditId").textContent = `#${id}`;
      document.getElementById("pvEditTitulo").value = item.titulo || "";
      document.getElementById("pvEditConteudo").value = item.conteudo || "";
      document.getElementById("pvEditPrioridade").value = Number(item.prioridade ?? 0);
      document.getElementById("pvEditEnabled").checked = !!item.enabled;
      makeCarteirasChecklist(document.getElementById("pvEditCarteiras"), new Set(Array.isArray(item.carteiras) ? item.carteiras : []));
      document.getElementById("pvEditBox").classList.remove("hidden");
      document.getElementById("pvEditMsg").textContent = "";
    };

    document.getElementById("pvBtnCancelarEdicao").onclick = () => {
      pvEditId = null;
      document.getElementById("pvEditBox").classList.add("hidden");
      document.getElementById("pvEditMsg").textContent = "";
    };

    // Salvar edição
    document.getElementById("pvBtnSalvarEdicao").onclick = async () => {
      const msg = document.getElementById("pvEditMsg");
      if (!pvEditId) { msg.textContent = "Nada para salvar."; msg.style.color = "var(--warn)"; return; }
      const titulo = (document.getElementById("pvEditTitulo").value || "").trim();
      const conteudo = (document.getElementById("pvEditConteudo").value || "").trim();
      const prioridade = Number(document.getElementById("pvEditPrioridade").value || 0);
      const enabled = document.getElementById("pvEditEnabled").checked;
      const carteiras = readChecklist(document.getElementById("pvEditCarteiras"));

      if (!titulo) { msg.textContent = "Informe o título."; msg.style.color = "var(--warn)"; return; }
      if (!conteudo) { msg.textContent = "Informe o conteúdo."; msg.style.color = "var(--warn)"; return; }
      if (!Number.isInteger(prioridade) || prioridade < 0 || prioridade > 10) { msg.textContent = "Prioridade deve ser 0..10."; msg.style.color = "var(--warn)"; return; }

      try {
        msg.textContent = "Salvando...";
        msg.style.color = "";
        const r = await fetch(`${API_BASE}/painel/editar_texto`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: pvEditId, titulo, conteudo, enabled, prioridade, carteiras })
        });
        const j = await r.json();
        if (!j.ok) { msg.textContent = j.erro || "Erro ao salvar."; msg.style.color = "var(--err)"; return; }
        msg.textContent = "Salvo.";
        msg.style.color = "var(--ok)";
        pvRecarregar();
      } catch (e) {
        msg.textContent = "Erro de rede.";
        msg.style.color = "var(--err)";
      }
    };

    // Toggle enabled
    window.pvToggleEnabled = async (id, enabled) => {
      try {
        const r = await fetch(`${API_BASE}/painel/editar_texto`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, enabled })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha ao atualizar status");
        pvRecarregar();
      } catch (e) {
        alert(e.message || "Erro ao atualizar status");
      }
    };

    // Remover (soft)
    window.pvRemover = async (id) => {
      if (!confirm(`Remover (soft delete) o aviso #${id}?`)) return;
      try {
        const r = await fetch(`${API_BASE}/painel/apagar_texto`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, hard: false })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha ao remover");
        pvRecarregar();
      } catch (e) {
        alert(e.message || "Erro ao remover");
      }
    };

    // Apagar definitivo (hard)
    window.pvApagarDef = async (id) => {
      if (!confirm(`APAGAR DEFINITIVAMENTE o aviso #${id}? Essa ação não pode ser desfeita.`)) return;
      try {
        const r = await fetch(`${API_BASE}/painel/apagar_texto`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, hard: true })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.erro || "Falha ao apagar");
        pvRecarregar();
      } catch (e) {
        alert(e.message || "Erro ao apagar");
      }
    };

    // Filtros/ações UI Painel
    document.getElementById("pvSomenteAtivos").addEventListener("change", pvRecarregar);
    document.getElementById("pvFiltroCarteira").addEventListener("change", pvRecarregar);
    document.getElementById("pvBtnRecarregar").addEventListener("click", pvRecarregar);

    /* === Start === */
    carregarTudo("primeiro");
  </script>
</body>

</html>
