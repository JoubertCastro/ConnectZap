<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoria de Conversas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
/* ===== Bolhas de mensagem (ajustadas) ===== */
.msg{
  display:inline-block;                         /* encolhe ao conteúdo */
  max-width:min(68%, 560px);
  padding:10px 14px 18px;
  border-radius:18px;
  margin:6px 0;
  position:relative;
  word-break:break-word;
  overflow-wrap:anywhere;
  line-height:1.45;
  font-size:14px;
  box-shadow:0 1px 2px rgba(0,0,0,.06);
  transition:background .18s ease;
}
@media (max-width:768px){ .msg{ max-width:86%; } }

.msg.enviada{
  align-self:flex-end;
  background:linear-gradient(120deg,#eef2ff,#e0e7ff); /* indigo-50 -> indigo-100 */
  color:#111827;
}
.msg.recebida{
  align-self:flex-start;
  background:#ffffff;
  border:1px solid #e5e7eb;                      /* slate-200 */
}

.msg .hora{
  position:absolute; right:8px; bottom:4px;
  font-size:11px; color:#64748b;                 /* slate-500 */
}

/* Caudas das bolhas */
.msg.enviada::after,.msg.recebida::after{
  content:""; position:absolute; bottom:0; width:14px; height:14px;
  clip-path:polygon(0 0, 100% 0, 0 100%);
}
.msg.enviada::after{
  right:-7px;
  background:linear-gradient(120deg,#eef2ff,#e0e7ff);
}
.msg.recebida::after{
  left:-7px;
  background:#fff;
  border-left:1px solid #e5e7eb;
  border-bottom:1px solid #e5e7eb;
}

/* Separador de dia */
.dia{
  text-align:center; margin:12px 0; font-size:12px; color:#64748b;
}

/* ===== Pills / badges ===== */
.chip-btn{
  padding:.4rem .7rem;border:1px solid #e2e8f0;border-radius:.6rem;background:#fff;color:#334155;font-weight:600;font-size:.8rem;
}
.chip-btn.active{ background:#1d4ed8;color:#fff;border-color:#1d4ed8; }

.badge{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem; border-radius:9999px; font-size:.7rem; font-weight:700; }
.badge-blue{ background:#eff6ff; color:#1d4ed8; }
.badge-amber{ background:#fffbeb; color:#b45309; }
.badge-slate{ background:#f1f5f9; color:#334155; }

.contato-item:hover{ background:#f8fafc; }

/* ===== details/summary ===== */
details.filter-block{ border:1px solid #e2e8f0; border-radius:.75rem; background:#fff; }
details.filter-block > summary{
  list-style:none; cursor:pointer; padding:.6rem .8rem;
  display:flex; align-items:center; justify-content:space-between;
  font-weight:700; color:#334155;
}
details.filter-block > summary::-webkit-details-marker{ display:none; }
details.filter-block[open] > summary{ border-bottom:1px dashed #e2e8f0; }
.summary-label{ display:flex; align-items:center; gap:.5rem; }
.summary-chevron{ transition: transform .2s ease; }
details.filter-block[open] .summary-chevron{ transform: rotate(180deg); }

/* borda sutil do painel direito */
aside.right-pane{ border-left:1px solid #e5e7eb; }
</style>
</head>
<body class="h-screen flex bg-gray-100">

<!-- ============== SIDEBAR ============== -->
<aside class="w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
  <div class="p-3 border-b space-y-4">
    <h2 class="font-bold text-lg">Monitoria</h2>

    <!-- Filtro básico: carteira + período (minimizável) -->
    <details id="fltBasico" class="filter-block" open>
      <summary>
        <span class="summary-label">
          <span>Filtro básico</span>
          <span id="fltBasicoResumo" class="text-xs font-normal text-slate-500"></span>
        </span>
        <svg class="summary-chevron w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
      </summary>
      <div class="p-3 space-y-3">
        <div>
          <label class="text-xs text-gray-500 font-medium">Carteira</label>
          <select id="filtroConta" class="w-full p-2 border rounded-md text-sm">
            <option value="">— selecione —</option>
            <option value="*">Todas as contas</option>
            <option value="828473960349364">ConnectZap</option>
            <option value="805610009301153">Banco PAN</option>
            <option value="727586317113885">Recovery PJ</option>
            <option value="864779140046932">Recovery PF</option>
            <option value="873637622491517">Mercado Pago Cobrança</option>
            <option value="779797401888141">DivZero</option>
            <option value="829210283602406">Arc4U</option>
            <option value="713021321904495">Serasa</option>
            <option value="803535039503723">Mercado Pago Vendas</option>
          </select>
        </div>

        <div>
          <div class="text-xs text-gray-500 font-medium">Período</div>
          <div class="flex flex-wrap gap-2 mt-1">
            <button class="chip-btn" data-range="hoje">Hoje</button>
            <button class="chip-btn" data-range="ontem">Ontem</button>
            <button class="chip-btn" data-range="7d">Últimos 7 dias</button>
            <button class="chip-btn" data-range="30d">Últimos 30 dias</button>
            <button class="chip-btn" data-range="mes">Mês atual</button>
            <button class="chip-btn" data-range="custom">Personalizado</button>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <input id="dataInicioLista" type="date" class="p-2 border rounded-md text-sm" />
            <input id="dataFimLista" type="date" class="p-2 border rounded-md text-sm" />
          </div>
        </div>

        <div class="flex gap-2">
          <button id="btnAplicarLista" class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Aplicar</button>
          <button id="btnLimparLista" class="px-3 py-2 rounded-md border text-sm">Limpar</button>
        </div>

        <div class="space-y-1">
          <label class="text-xs text-gray-500 font-medium">Buscar contato/numero</label>
          <input id="searchInput" type="text" placeholder="🔍 digite para filtrar..." class="w-full p-2 rounded-md border text-sm" autocomplete="off" oninput="filtrarContatos(this.value)" />
        </div>

        <div id="hintLista" class="text-xs text-gray-500 bg-slate-50 border border-dashed rounded-md p-2">
          Selecione a <b>carteira</b> e um <b>período</b>, depois clique em <b>Aplicar</b> para carregar os contatos.
        </div>
      </div>
    </details>

    <!-- Filtro Avançado (conversas_em_andamento) -->
    <details id="fx" class="filter-block">
      <summary>
        <span class="summary-label">
          <span>Filtro avançado — conversas em andamento</span>
        </span>
        <svg class="summary-chevron w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
      </summary>
      <div class="p-3 space-y-2">
        <div>
          <label class="text-xs text-gray-500 font-medium">Carteira</label>
          <select id="fxCarteira" class="w-full p-2 border rounded-md text-sm">
            <option value="">— todas —</option>
            <option value="ConnectZap">ConnectZap</option>
            <option value="ConnectZap_teste">ConnectZap teste</option>
            <option value="Banco PAN">Banco PAN</option>
            <option value="Recovery PJ">Recovery PJ</option>
            <option value="Recovery PF">Recovery PF</option>
            <option value="Mercado Pago Cobrança">Mercado Pago Cobrança</option>
            <option value="DivZero">DivZero</option>
            <option value="Arc4U">Arc4U</option>
            <option value="Serasa">Serasa</option>
            <option value="Mercado Pago Vendas">Mercado Pago Vendas</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500 font-medium">Nome do agente</label>
          <input id="fxAgente" type="text" class="w-full p-2 border rounded-md text-sm" placeholder="Ex.: Maria Silva" />
        </div>
        <div>
          <label class="text-xs text-gray-500 font-medium">Telefone</label>
          <input id="fxTelefone" type="text" class="w-full p-2 border rounded-md text-sm" placeholder="Ex.: 5511999999999" />
        </div>
        <button id="btnBuscarFX" class="w-full mt-1 bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700 text-sm font-semibold">Buscar tickets</button>

        <div id="fxHint" class="text-xs text-slate-500 mt-2 hidden"></div>
        <ul id="fxLista" class="mt-2 max-h-60 overflow-y-auto space-y-2"></ul>
      </div>
    </details>
  </div>

  <!-- Lista de contatos (após aplicar) -->
  <ul id="contatos" class="flex-1 overflow-y-auto"></ul>

  <div class="p-2 text-xs text-gray-500 border-t">
    Lista atualiza automaticamente após aplicar filtros.
  </div>
</aside>

<!-- ============== MAIN ============== -->
<main class="flex-1 flex flex-col">
  <header class="flex items-center justify-between p-3 border-b bg-white">
    <div class="min-w-0">
      <h2 id="tituloConversa" class="font-bold text-lg truncate">Selecione uma conversa</h2>
      <div id="subInfo" class="text-sm text-gray-500 truncate"></div>
    </div>
    <div class="space-x-2">
      <button onclick="exportarTXT()" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Exportar TXT</button>
      <button onclick="exportarPDF()" class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Exportar PDF</button>
    </div>
  </header>

  <div class="flex flex-1">
    <!-- Chat -->
    <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col bg-gray-50">
      <p class="text-center text-gray-500">Selecione um contato para ver as mensagens...</p>
    </div>

    <!-- Resumo + filtros da conversa (minimizáveis) -->
    <aside class="right-pane w-1/3 lg:w-1/4 bg-white p-4 space-y-3">
      <details class="filter-block" open>
        <summary>
          <span class="summary-label"><span>Resumo</span></span>
          <svg class="summary-chevron w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
        </summary>
        <div id="resumoCards" class="grid gap-2 p-3"></div>
      </details>

      <details class="filter-block" open>
        <summary>
          <span class="summary-label"><span>Filtros da conversa</span></span>
          <svg class="summary-chevron w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
        </summary>
        <div class="p-3 space-y-2">
          <label class="block text-sm">Data Inicial:</label>
          <input type="date" id="dataInicio" class="border p-1 rounded w-full">
          <label class="block text-sm mt-2">Data Final:</label>
          <input type="date" id="dataFim" class="border p-1 rounded w-full">
          <label class="block text-sm mt-2">Tipo:</label>
          <select id="filtroTipo" class="border p-1 rounded w-full">
            <option value="">Todas</option>
            <option value="in">Recebidas</option>
            <option value="out">Enviadas</option>
          </select>
          <button onclick="carregarMensagens()" class="w-full mt-3 bg-green-500 text-white p-2 rounded hover:bg-green-600">Aplicar Filtros</button>

          <div id="janelaTicket" class="text-xs text-slate-600 mt-2 hidden"></div>
        </div>
      </details>
    </aside>
  </div>
</main>

<script>
/* ====== CONFIG & MAPAS ====== */
const API_BASE = "https://conversas-api-production.up.railway.app";
const phoneIdMap = {
  "828473960349364": "ConnectZap",
  "805610009301153": "Banco PAN",
  "727586317113885": "Recovery PJ",
  "864779140046932": "Recovery PF",
  "873637622491517": "Mercado Pago Cobrança",
  "779797401888141": "DivZero",
  "829210283602406": "Arc4U",
  "713021321904495": "Serasa",
  "803535039503723": "Mercado Pago Vendas"
};
const carteiraToPhone = {
  "ConnectZap": "828473960349364",
  "Banco PAN": "805610009301153",
  "Recovery PJ": "727586317113885",
  "Recovery PF": "864779140046932",
  "Mercado Pago Cobrança": "873637622491517",
  "DivZero": "779797401888141",
  "Arc4U": "829210283602406",
  "Serasa": "713021321904495",
  "Mercado Pago Vendas": "803535039503723"
};

/* ====== ESTADO ====== */
let filtrosListaAplicados = false;
let contatoSelecionado = null, phoneIdAtual = null;
let mensagens = [];
let janelaAtiva = null; // {inicio:'YYYY-MM-DD', fim:'YYYY-MM-DD'}

/* ====== HELPERS ====== */
const pad = n => String(n).padStart(2,"0");
const toYMD = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function escapeHtml(s){ if(!s) return ""; return s.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
function gerarCor(nome){ let hash=0; for(let i=0;i<nome.length;i++){ hash=nome.charCodeAt(i)+((hash<<5)-hash);} return `hsl(${hash % 360},70%,60%)`; }
function toLocalYMD(iso){
  const d = new Date(iso);
  const parts = new Date(d.toLocaleString("en-US", { timeZone: "America/Sao_Paulo" }));
  return `${parts.getFullYear()}-${pad(parts.getMonth()+1)}-${pad(parts.getDate())}`;
}

/* Heurística robusta para direção da mensagem */
function isIncoming(m){
  const s = (m.status || "").toLowerCase();
  if (typeof m.from_me === "boolean") return !m.from_me;
  if (m.direction) return String(m.direction).toLowerCase().startsWith("in");
  if (["in","received","incoming"].includes(s)) return true;
  if (["out","sent","delivered","read","outgoing"].includes(s)) return false;
  return s === "in"; // fallback
}

/* ====== UI: período rápido (lista) ====== */
const chipBtns = [...document.querySelectorAll(".chip-btn")];
const filtroContaEl = document.getElementById("filtroConta");
const diListaEl = document.getElementById("dataInicioLista");
const dfListaEl = document.getElementById("dataFimLista");
const hintLista = document.getElementById("hintLista");
function setQuickRange(kind){
  const now = new Date();
  let a = new Date(), b = new Date();
  if(kind==="hoje"){ /* a=b hoje */ }
  if(kind==="ontem"){ a.setDate(now.getDate()-1); b.setDate(now.getDate()-1); }
  if(kind==="7d"){ a.setDate(now.getDate()-6); }
  if(kind==="30d"){ a.setDate(now.getDate()-29); }
  if(kind==="mes"){ a = new Date(now.getFullYear(), now.getMonth(), 1); }
  diListaEl.value = toYMD(a); dfListaEl.value = toYMD(b);
}
function highlightChip(btn){ chipBtns.forEach(b=>b.classList.remove("active")); if(btn) btn.classList.add("active"); }
chipBtns.forEach(btn=>btn.addEventListener("click", ()=>{ const k=btn.dataset.range; if(k!=="custom") setQuickRange(k); highlightChip(btn); }));
setQuickRange("hoje"); highlightChip(document.querySelector('[data-range="hoje"]'));

/* resumo no summary do filtro básico */
function atualizarResumoBasico(){
  const carteira = filtroContaEl.value || "—";
  const di = diListaEl.value || "—";
  const df = dfListaEl.value || "—";
  const span = document.getElementById("fltBasicoResumo");
  span.textContent = `(carteira: ${carteira === "*" ? "todas" : carteira} • ${di} → ${df})`;
}
[filtroContaEl, diListaEl, dfListaEl].forEach(el => el.addEventListener("change", atualizarResumoBasico));
atualizarResumoBasico();

/* ====== LISTA DE CONTATOS ====== */
const contatosUL = document.getElementById("contatos");
document.getElementById("btnAplicarLista").addEventListener("click", ()=>{
  if(!filtroContaEl.value){ alert("Selecione uma carteira (ou 'Todas as contas')."); return; }
  filtrosListaAplicados = true; hintLista.classList.add("hidden");
  startContactsPolling();
});
document.getElementById("btnLimparLista").addEventListener("click", ()=>{
  filtroContaEl.value=""; diListaEl.value=""; dfListaEl.value="";
  document.getElementById("searchInput").value="";
  filtrosListaAplicados = false; hintLista.classList.remove("hidden");
  contatosUL.innerHTML="";
  if(contactsInterval) clearInterval(contactsInterval);
  atualizarResumoBasico();
});
function filtrarContatos(q){
  q=(q||"").toLowerCase().trim();
  document.querySelectorAll("#contatos li").forEach(li=>{
    const hay=li.textContent.toLowerCase();
    li.style.display = hay.includes(q) ? "flex" : "none";
  });
}

let contactsInterval=null, ultimoSnapshot={};
async function carregarContatos(){
  if(!filtrosListaAplicados) return;
  try{
    if(!contatosUL.children.length){
      contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Carregando contatos…</li>`;
    }
    const res = await fetch(`${API_BASE}/api/conversas/contatos`);
    if(!res.ok) throw new Error("Falha ao buscar contatos");
    const contatos = await res.json();

    const carteirafiltro = filtroContaEl.value; // * | phone_id
    const di = diListaEl.value || null;
    const df = dfListaEl.value || null;
    const busc = document.getElementById("searchInput").value.toLowerCase().trim();

    let filtrados = contatos;
    if(carteirafiltro && carteirafiltro !== "*"){
      filtrados = filtrados.filter(c => c.phone_id === carteirafiltro);
    }
    if(di || df){
      filtrados = filtrados.filter(c=>{
        if(!c.data_hora) return false;
        const ymd = toLocalYMD(c.data_hora);
        if(di && ymd < di) return false;
        if(df && ymd > df) return false;
        return true;
      });
    }
    if(busc){
      filtrados = filtrados.filter(c=>{
        const nome = (c.nome_exibicao||"").toLowerCase();
        const num  = (c.remetente||"").toLowerCase();
        return nome.includes(busc) || num.includes(busc);
      });
    }

    const stateKey = JSON.stringify(filtrados.map(c=>c.remetente+"|"+c.data_hora));
    if(ultimoSnapshot.stateKey === stateKey) return;
    ultimoSnapshot.stateKey = stateKey;

    contatosUL.innerHTML = "";
    if(!filtrados.length){
      contatosUL.innerHTML = `<li class="p-3 text-sm text-gray-500">Nenhum contato no período/filtros.</li>`;
      return;
    }
    filtrados.forEach(c=>{
      const nome = c.nome_exibicao||c.remetente;
      const hora = c.data_hora?new Date(c.data_hora).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):"";
      const li = document.createElement("li");
      li.className="contato-item flex items-center p-3 cursor-pointer border-b";
      li.innerHTML = `
        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium" style="background:${gerarCor(nome)};color:white;">
          ${(nome||c.remetente).charAt(0).toUpperCase()}
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-bold truncate">${escapeHtml(nome)}</div>
          <div class="text-xs text-slate-500 truncate">${escapeHtml(c.mensagem_final||"")}</div>
        </div>
        <div class="text-[11px] text-slate-400 pl-2">${hora}</div>
      `;
      li.onclick=()=>abrirConversaBasica(c);
      contatosUL.appendChild(li);
    });
  }catch(e){
    console.error(e);
    contatosUL.innerHTML = `<li class="p-3 text-sm text-red-600">Erro ao carregar contatos.</li>`;
  }
}
function startContactsPolling(){
  if(contactsInterval) clearInterval(contactsInterval);
  carregarContatos();
  contactsInterval = setInterval(()=>{ if(filtrosListaAplicados) carregarContatos(); }, 10000);
}

/* ====== ABRIR CONVERSA ====== */
async function abrirConversaBasica(c){
  janelaAtiva = null;
  contatoSelecionado=c.remetente; phoneIdAtual=c.phone_id;
  document.getElementById("tituloConversa").innerText = c.nome_exibicao ? `${c.nome_exibicao} (${c.remetente})` : c.remetente;
  document.getElementById("subInfo").innerText = c.phone_id ? `Conta: ${phoneIdMap[c.phone_id]||c.phone_id}` : "";
  document.getElementById("janelaTicket").classList.add("hidden");
  await carregarMensagens();
}
async function abrirConversaComJanela(telefone, phone_id, started_at, ended_at, nomeAgente, carteira){
  contatoSelecionado = telefone;
  phoneIdAtual = phone_id;
  const inicio = toLocalYMD(started_at);
  const fim = ended_at ? toLocalYMD(ended_at) : toYMD(new Date());
  janelaAtiva = {inicio, fim};

  document.getElementById("tituloConversa").innerText = `${telefone}`;
  const carteiraNome = carteira || Object.keys(carteiraToPhone).find(k=>carteiraToPhone[k]===phone_id) || phone_id;
  document.getElementById("subInfo").innerText = `Conta: ${carteiraNome}${nomeAgente? " • Agente: "+nomeAgente : ""}`;
  document.getElementById("dataInicio").value = inicio;
  document.getElementById("dataFim").value = fim;
  const jDiv = document.getElementById("janelaTicket");
  jDiv.innerHTML = `Janela do ticket: <span class="badge badge-amber">${inicio} → ${fim}</span>`;
  jDiv.classList.remove("hidden");

  await carregarMensagens();
}

/* ====== CARREGAR MENSAGENS ====== */
async function carregarMensagens(){
  if(!contatoSelecionado || !phoneIdAtual) return;
  const chat=document.getElementById("chat");
  chat.innerHTML = `<p class="text-center text-gray-500">Carregando…</p>`;

  const di = janelaAtiva?.inicio || document.getElementById("dataInicio").value || "";
  const df = janelaAtiva?.fim    || document.getElementById("dataFim").value || "";
  const tipo = document.getElementById("filtroTipo").value;

  let url = `${API_BASE}/api/conversas/${contatoSelecionado}?phone_id=${encodeURIComponent(phoneIdAtual)}`;
  if(di) url += `&data_inicio=${encodeURIComponent(di)}`;
  if(df) url += `&data_fim=${encodeURIComponent(df)}`;

  try{
    const res=await fetch(url);
    if(!res.ok) throw new Error("Erro ao obter histórico");
    let todas = await res.json();

    if(tipo === "in") mensagens = todas.filter(m => isIncoming(m));
    else if(tipo === "out") mensagens = todas.filter(m => !isIncoming(m));
    else mensagens = todas;

    chat.innerHTML=""; let ultimoDia=""; let enviadas=0, recebidas=0;

    mensagens.forEach(m=>{
      const incoming = isIncoming(m);
      if(incoming) recebidas++; else enviadas++;

      const data=new Date(m.data_hora);
      const dia=data.toLocaleDateString("pt-BR",{timeZone:"America/Sao_Paulo"});
      const hora=data.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",timeZone:"America/Sao_Paulo"});

      if(dia!==ultimoDia){
        const sep = document.createElement("div");
        sep.className = "dia";
        sep.textContent = `— ${dia} —`;
        chat.appendChild(sep);
        ultimoDia = dia;
      }

      const div = document.createElement("div");
      div.className = `msg ${incoming ? "recebida" : "enviada"}`;
      div.innerHTML = `<div>${escapeHtml(m.mensagem_final||"")}</div><span class="hora">${hora}</span>`;
      chat.appendChild(div);
    });

    document.getElementById("resumoCards").innerHTML=`
      <div class="p-2 bg-green-100 text-green-800 rounded">Enviadas: ${enviadas}</div>
      <div class="p-2 bg-blue-100 text-blue-800 rounded">Recebidas: ${recebidas}</div>
      <div class="p-2 bg-gray-100 text-gray-800 rounded">Total: ${mensagens.length}</div>
      <div class="p-2 bg-yellow-100 text-yellow-800 rounded">Última: ${(mensagens[mensagens.length-1]?.data_hora)||"-"}</div>
    `;

    chat.scrollTo({top:chat.scrollHeight,behavior:"smooth"});
  }catch(err){
    console.error("Erro ao carregar mensagens",err);
    chat.innerHTML = `<p class="text-center text-red-600">Falha ao carregar histórico.</p>`;
  }
}

/* ====== EXPORTS ====== */
function exportarTXT(){
  if(!mensagens.length){alert("Nenhuma conversa carregada");return;}
  let conteudo = mensagens.map(m=>{
    const data=new Date(m.data_hora).toLocaleString("pt-BR");
    const dir = isIncoming(m) ? "Recebida" : "Enviada";
    return `[${data}] (${dir}) ${m.mensagem_final||""}`;
  }).join("\n");
  const blob=new Blob([conteudo],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=`conversa_${contatoSelecionado}.txt`;a.click();
  URL.revokeObjectURL(url);
}
function exportarPDF(){
  if(!mensagens.length){alert("Nenhuma conversa carregada");return;}
  const body = mensagens.map(m=>[
    new Date(m.data_hora).toLocaleString("pt-BR"),
    isIncoming(m) ? "Recebida" : "Enviada",
    m.mensagem_final||""
  ]);
  const docDefinition = {
    content: [
      { text: "Monitoria de Conversas WhatsApp", style: "header", alignment:"center" },
      { text: `Contato: ${contatoSelecionado} | Conta: ${phoneIdMap[phoneIdAtual]||phoneIdAtual}`, margin:[0,10,0,10] },
      { text: janelaAtiva ? `Janela do ticket: ${janelaAtiva.inicio} → ${janelaAtiva.fim}` : "", margin:[0,0,0,10] },
      {
        table: { headerRows: 1, widths: ["25%","15%","60%"], body: [["Data/Hora","Direção","Mensagem"], ...body] },
        layout: "lightHorizontalLines"
      },
      { text: `Exportado em: ${new Date().toLocaleString("pt-BR")}`, style: "footer", margin:[0,20,0,0] }
    ],
    styles: { header: { fontSize: 16, bold: true }, footer: { fontSize: 9, italics: true, alignment:"right" } },
    defaultStyle: { font: "Roboto" }
  };
  pdfMake.createPdf(docDefinition).download(`conversa_${contatoSelecionado}.pdf`);
}

/* ====== FILTRO AVANÇADO (conversas_em_andamento) ====== */
const fxLista = document.getElementById("fxLista");
const fxHint  = document.getElementById("fxHint");
document.getElementById("btnBuscarFX").addEventListener("click", buscarAvancado);

async function buscarAvancado(){
  const carteira = document.getElementById("fxCarteira").value.trim();
  const nome_agente = document.getElementById("fxAgente").value.trim();
  const telefone = document.getElementById("fxTelefone").value.trim();

  fxLista.innerHTML = `<li class="text-sm text-slate-600">Buscando…</li>`;
  fxHint.classList.add("hidden");

  let url = `${API_BASE}/api/monitoria/em_andamento?`;
  if(carteira) url += `carteira=${encodeURIComponent(carteira)}&`;
  if(nome_agente) url += `nome_agente=${encodeURIComponent(nome_agente)}&`;
  if(telefone) url += `telefone=${encodeURIComponent(telefone)}&`;

  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error("endpoint indisponível");
    const dados = await res.json(); // [{telefone, phone_id, carteira, nome_agente, started_at, ended_at}]
    renderFX(dados);
  }catch(e){
    fxLista.innerHTML = "";
    fxHint.textContent = "Não foi possível consultar as conversas em andamento. Verifique se o endpoint /api/monitoria/em_andamento existe no backend.";
    fxHint.classList.remove("hidden");
  }
}

function renderFX(rows){
  fxLista.innerHTML = "";
  if(!rows || !rows.length){
    fxLista.innerHTML = `<li class="text-sm text-slate-600">Nenhum ticket encontrado nos filtros informados.</li>`;
    return;
  }
  rows.forEach(t=>{
    const li = document.createElement("li");
    li.className = "p-2 border rounded-lg hover:bg-slate-50 cursor-pointer";
    const inicio = toLocalYMD(t.started_at);
    const fim = t.ended_at ? toLocalYMD(t.ended_at) : toYMD(new Date());
    li.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-semibold">${t.telefone}</div>
        <span class="badge badge-blue">${t.carteira || (phoneIdMap[t.phone_id]||t.phone_id)}</span>
      </div>
      <div class="text-xs text-slate-600 mt-1">
        Agente: <span class="badge badge-slate">${t.nome_agente || "-"}</span>
      </div>
      <div class="text-xs text-slate-600 mt-1">
        Janela: <span class="badge badge-amber">${inicio} → ${fim}</span>
      </div>
    `;
    li.onclick = ()=> abrirConversaComJanela(t.telefone, t.phone_id, t.started_at, t.ended_at, t.nome_agente, t.carteira);
    fxLista.appendChild(li);
  });
}

/* ====== START ====== */
carregarContatos(); // só mostra “carregando” depois que aplicar
setInterval(()=>{ if(filtrosListaAplicados) carregarContatos(); }, 10000);
</script>
</body>
</html>
