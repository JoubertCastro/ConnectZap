<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoria de Conversas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
/* Bolhas estilo WhatsApp */
.msg {
  max-width: 70%;
  padding: 10px 14px 24px 14px;
  border-radius: 18px;
  margin: 4px 0;
  position: relative;
  word-wrap: break-word;
  white-space: pre-wrap;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  transition: background 0.2s;
  font-size: 14px;
  line-height: 1.4;
}
.msg.enviada {
  background: linear-gradient(120deg, #dcf8c6, #b8f0a4);
  align-self: flex-end;
}
.msg.recebida {
  background: #fff;
  align-self: flex-start;
  border: 1px solid #e2e8f0;
}
.msg .hora {
  font-size: 11px;
  color: #555;
  position: absolute;
  bottom: 4px;
  right: 8px;
}
.dia {
  text-align: center;
  margin: 12px 0;
  font-size: 12px;
  color: #888;
}
</style>
</head>
<body class="h-screen flex bg-gray-100">

<!-- Sidebar -->
<aside class="w-1/4 bg-white border-r flex flex-col">
  <div class="p-3 border-b space-y-2">
    <h2 class="font-bold text-lg">Contatos</h2>
    <select id="filtroConta" class="w-full p-2 border rounded-md text-sm" onchange="carregarContatos()">
      <option value="">Todas as contas</option>
      <option value="732661079928516">ConnectZap</option>
      <option value="727586317113885">Recovery PJ</option>
      <option value="802977069563598">Recovery PF</option>
      <option value="821562937700669">Mercado Pago Cobran√ßa</option>
      <option value="779797401888141">DivZero</option>
      <option value="829210283602406">Arc4U</option>
      <option value="713021321904495">Serasa</option>
      <option value="803535039503723">Mercado Pago Vendas</option>
    </select>
    <input id="searchInput" type="text" placeholder="üîç Buscar contato"
      class="w-full p-2 rounded-md border" oninput="filtrarContatos(this.value)" autocomplete="off"/>
  </div>
  <ul id="contatos" class="flex-1 overflow-y-auto"></ul>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col">
  <header class="flex items-center justify-between p-3 border-b bg-white">
    <div>
      <h2 id="tituloConversa" class="font-bold text-lg truncate">Selecione uma conversa</h2>
      <div id="subInfo" class="text-sm text-gray-500"></div>
    </div>
    <div class="space-x-2">
      <button onclick="exportarTXT()" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Exportar TXT</button>
      <button onclick="exportarPDF()" class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Exportar PDF</button>
    </div>
  </header>

  <div class="flex flex-1">
    <!-- Chat -->
    <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-3 bg-gray-50">
      <p class="text-center text-gray-500">Selecione um contato para ver as mensagens...</p>
    </div>

    <!-- Resumo -->
    <aside class="w-1/4 bg-white border-l p-4 space-y-3 hidden lg:block">
      <h3 class="font-bold text-gray-700 mb-2">Resumo</h3>
      <div id="resumoCards" class="grid gap-2"></div>

      <h3 class="font-bold text-gray-700 mt-4">Filtros</h3>
      <label class="block text-sm">Data Inicial:</label>
      <input type="date" id="dataInicio" class="border p-1 rounded w-full">
      <label class="block text-sm mt-2">Data Final:</label>
      <input type="date" id="dataFim" class="border p-1 rounded w-full">
      <label class="block text-sm mt-2">Tipo:</label>
      <select id="filtroTipo" class="border p-1 rounded w-full">
        <option value="">Todas</option>
        <option value="in">Recebidas</option>
        <option value="out">Enviadas</option>
      </select>
      <button onclick="carregarMensagens()" class="w-full mt-3 bg-green-500 text-white p-2 rounded hover:bg-green-600">Aplicar Filtros</button>
    </aside>
  </div>
</main>

<script>
const API_BASE = "https://conversas-api-production.up.railway.app";
let contatoSelecionado = null, phoneIdAtual = null;
let mensagens = [];
const phoneIdMap = {
  "732661079928516": "ConnectZap",
  "727586317113885": "Recovery PJ",
  "802977069563598": "Recovery PF",
  "821562937700669": "Mercado Pago Cobran√ßa",
  "779797401888141": "DivZero",
  "829210283602406": "Arc4U",
  "713021321904495": "Serasa",
  "803535039503723": "Mercado Pago Vendas"
};

function escapeHtml(s){ if(!s) return ""; return s.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
function gerarCor(nome){ let hash=0; for(let i=0;i<nome.length;i++){ hash=nome.charCodeAt(i)+((hash<<5)-hash);} return `hsl(${hash % 360},70%,60%)`; }

async function carregarContatos(){
  try{
    const res = await fetch(`${API_BASE}/api/conversas/contatos`);
    const contatos = await res.json();
    const lista = document.getElementById("contatos");
    lista.innerHTML = "";
    const filtroConta = document.getElementById("filtroConta").value;

    contatos.filter(c => !filtroConta || c.phone_id === filtroConta)
      .forEach(c=>{
        const nome = c.nome_exibicao||c.remetente;
        const li = document.createElement("li");
        li.className="flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b";
        li.innerHTML=`
          <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 font-medium"
               style="background:${gerarCor(nome)};color:white;">
            ${(nome||c.remetente).charAt(0).toUpperCase()}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-bold truncate">${escapeHtml(nome)}</div>
            <div class="text-sm text-gray-600 truncate">${escapeHtml(c.mensagem_final||"")}</div>
          </div>`;
        li.onclick=()=>abrirConversa(c);
        lista.appendChild(li);
      });
  }catch(err){console.error("Erro ao carregar contatos",err);}
}

async function abrirConversa(c){
  contatoSelecionado=c.remetente; phoneIdAtual=c.phone_id;
  document.getElementById("tituloConversa").innerText=c.nome_exibicao||c.remetente;
  document.getElementById("subInfo").innerText=c.phone_id?`Conta: ${phoneIdMap[c.phone_id]||c.phone_id}`:"";
  await carregarMensagens();
}

async function carregarMensagens(){
  if(!contatoSelecionado) return;
  try{
    // ‚úÖ agora busca pelo telefone e phone_id
    const res=await fetch(`${API_BASE}/api/conversas/${contatoSelecionado}?phone_id=${phoneIdAtual}`);
    let todas = await res.json();

    const inicio = document.getElementById("dataInicio").value;
    const fim = document.getElementById("dataFim").value;
    const tipo = document.getElementById("filtroTipo").value;
    mensagens = todas.filter(m=>{
      let data = new Date(m.data_hora);
      if(inicio && data < new Date(inicio)) return false;
      if(fim && data > new Date(fim+"T23:59:59")) return false;
      if(tipo && m.status !== tipo) return false;
      return true;
    });

    const chat=document.getElementById("chat");
    chat.innerHTML=""; let ultimoDia="";
    let enviadas=0, recebidas=0;

    mensagens.forEach(m=>{
      if(m.status==="in") recebidas++; else enviadas++;
      const data=new Date(m.data_hora);
      const dia=data.toLocaleDateString("pt-BR",{timeZone:"America/Sao_Paulo"});
      const hora=data.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",timeZone:"America/Sao_Paulo"});
      if(dia!==ultimoDia){ chat.innerHTML+=`<div class="dia">‚Äî ${dia} ‚Äî</div>`; ultimoDia=dia; }
      chat.innerHTML+=`
        <div class="msg ${m.status==="in"?"recebida":"enviada"}">
          <div>${escapeHtml(m.mensagem_final)}</div>
          <span class="hora">${hora}</span>
        </div>`;
    });

    document.getElementById("resumoCards").innerHTML=`
      <div class="p-2 bg-green-100 text-green-800 rounded">Enviadas: ${enviadas}</div>
      <div class="p-2 bg-blue-100 text-blue-800 rounded">Recebidas: ${recebidas}</div>
      <div class="p-2 bg-gray-100 text-gray-800 rounded">Total: ${mensagens.length}</div>
      <div class="p-2 bg-yellow-100 text-yellow-800 rounded">√öltima: ${(mensagens[mensagens.length-1]?.data_hora)||"-"}</div>
    `;

    chat.scrollTo({top:chat.scrollHeight,behavior:"smooth"});
  }catch(err){console.error("Erro ao carregar mensagens",err);}
}

function exportarTXT(){
  if(!mensagens.length){alert("Nenhuma conversa carregada");return;}
  let conteudo = mensagens.map(m=>{
    const data=new Date(m.data_hora).toLocaleString("pt-BR");
    return `[${data}] (${m.status==="in"?"Recebida":"Enviada"}) ${m.mensagem_final}`;
  }).join("\n");
  const blob=new Blob([conteudo],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=`conversa_${contatoSelecionado}.txt`;a.click();
  URL.revokeObjectURL(url);
}

function exportarPDF(){
  if(!mensagens.length){alert("Nenhuma conversa carregada");return;}
  const body = mensagens.map(m=>[
    new Date(m.data_hora).toLocaleString("pt-BR"),
    m.status==="in"?"Recebida":"Enviada",
    m.mensagem_final
  ]);

  const docDefinition = {
    content: [
      { text: "Monitoria de Conversas WhatsApp", style: "header", alignment:"center" },
      { text: `Contato: ${contatoSelecionado} | Conta: ${phoneIdMap[phoneIdAtual]||phoneIdAtual}`, margin:[0,10,0,10] },
      {
        table: {
          headerRows: 1,
          widths: ["25%","15%","60%"],
          body: [["Data/Hora","Dire√ß√£o","Mensagem"], ...body]
        },
        layout: "lightHorizontalLines"
      },
      { text: `Exportado em: ${new Date().toLocaleString("pt-BR")}`, style: "footer", margin:[0,20,0,0] }
    ],
    styles: {
      header: { fontSize: 16, bold: true },
      footer: { fontSize: 9, italics: true, alignment:"right" }
    },
    defaultStyle: {
      font: "Roboto"   // ‚úÖ usa Roboto, que j√° vem no vfs_fonts
    }
  };

  pdfMake.createPdf(docDefinition).download(`conversa_${contatoSelecionado}.pdf`);
}

carregarContatos();
setInterval(carregarContatos,10000);
</script>
</body>
</html>
