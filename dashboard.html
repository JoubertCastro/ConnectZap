<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äî ConnectZap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="bg-blue-600 text-white py-4">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-xl sm:text-2xl font-semibold">üìä Dashboard ‚Äî ConnectZap</h1>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Filtros -->
    <section class="bg-white rounded-xl shadow-sm border p-4">
      <div class="flex flex-col gap-3">
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm text-slate-500 mr-1">Per√≠odo:</span>

          <!-- #1 chips com cara de bot√£o -->
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-600"
                  data-range="hoje">Hoje</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-600"
                  data-range="7d">√öltimos 7 dias</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-600"
                  data-range="30d">√öltimos 30 dias</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-600"
                  data-range="mes">M√™s atual</button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-600"
                  data-range="custom">Personalizado</button>

          <!-- #2 bot√£o exportar discreto -->
          <div class="ml-auto flex gap-2">
            <button id="btnExport"
              class="px-3 py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 text-sm">Exportar CSV</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm text-slate-500">In√≠cio</label>
            <input id="start" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
          </div>
          <div>
            <label class="text-sm text-slate-500">Fim</label>
            <input id="end" type="date" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
          </div>
          <div>
            <label class="text-sm text-slate-500">Carteira</label>
            <select id="carteira" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="text-sm text-slate-500">Nome do disparo</label>
              <input id="q" type="text" placeholder="Buscar..." class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" />
            </div>
            <!-- #3 bot√£o aplicar com cara de bot√£o prim√°rio -->
            <div class="flex items-end">
              <button id="btnAplicar" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium">
                Aplicar
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- #5 Segmented control (abas) -->
    <section class="bg-white rounded-xl shadow-sm border">
      <div class="p-3">
        <div class="inline-flex bg-slate-100 rounded-xl p-1">
          <button class="seg-btn seg-active" data-tab="mensagens">
            <span>‚úâÔ∏è</span><span>Mensagens</span>
          </button>
          <button class="seg-btn" data-tab="atendimentos">
            <span>üéß</span><span>Atendimentos</span>
          </button>
        </div>
      </div>

      <!-- Conte√∫do: Mensagens -->
      <div id="tab-mensagens" class="p-4 space-y-6">
        <!-- #4 KPIs em ‚Äúbal√µes‚Äù -->
        <div id="cards-mensagens" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
          <div class="balloon">
            <div class="balloon-label">Total</div>
            <div id="k_total" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Enviados</div>
            <div id="k_env" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Entregues</div>
            <div id="k_ent" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Lidos</div>
            <div id="k_lido" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Delivery rate</div>
            <div id="k_dr" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Read rate</div>
            <div id="k_rr" class="balloon-value">‚Äî</div>
          </div>
        </div>

        <!-- Gr√°fico -->
        <div class="space-y-2">
          <div class="text-sm text-slate-500">Entregues x Lidos por disparo</div>
          <!-- #6 wrapper com altura fixa -->
          <div class="h-72">
            <canvas id="chartMensagens" class="w-full h-full"></canvas>
          </div>
          <div id="chartMensagensEmpty" class="text-sm text-slate-500 hidden">Sem dados para o per√≠odo/filtros.</div>
        </div>

        <!-- Tabela -->
        <div class="overflow-hidden rounded-xl border">
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-slate-50 sticky top-0">
                <tr>
                  <th class="th">Disparo</th>
                  <th class="th">Grupo</th>
                  <th class="th">Data</th>
                  <th class="th text-right">Total</th>
                  <th class="th text-right">Entregues</th>
                  <th class="th text-right">Lidos</th>
                </tr>
              </thead>
              <tbody id="tbodyMensagens" class="bg-white"></tbody>
            </table>
          </div>
          <div id="tblEmpty" class="p-3 text-sm text-slate-500 hidden">Nenhum envio encontrado.</div>
        </div>
      </div>

      <!-- Conte√∫do: Atendimentos -->
      <div id="tab-atendimentos" class="p-4 space-y-6 hidden">
        <div id="cards-atend" class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="balloon">
            <div class="balloon-label">Em atendimento</div>
            <div id="a_em" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">Conclu√≠dos</div>
            <div id="a_conc" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">TMA</div>
            <div id="a_tma" class="balloon-value">‚Äî</div>
          </div>
          <div class="balloon">
            <div class="balloon-label">1¬™ resposta</div>
            <div id="a_tmr" class="balloon-value">‚Äî</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-2">
            <div class="text-sm text-slate-500">Motivos de conclus√£o</div>
            <div class="h-72">
              <canvas id="chartMotivos" class="w-full h-full"></canvas>
            </div>
            <div id="chartMotivosEmpty" class="text-sm text-slate-500 hidden">Sem dados de motivos.</div>
          </div>

          <div class="space-y-2">
            <div class="text-sm text-slate-500">S√©ries di√°rias ‚Äî In / Out / Conclu√≠dos</div>
            <div class="h-72">
              <canvas id="chartSeries" class="w-full h-full"></canvas>
            </div>
            <div id="chartSeriesEmpty" class="text-sm text-slate-500 hidden">Sem s√©ries no per√≠odo.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Avisos -->
    <div id="alert" class="hidden rounded-lg border border-amber-300 bg-amber-50 text-amber-800 p-3 text-sm"></div>
  </main>

  <style>
    .seg-btn{
      display:flex; align-items:center; gap:.5rem;
      padding:.5rem .75rem; border-radius:.75rem;
      font-weight:600; color:#334155; transition:all .15s;
    }
    .seg-btn:hover{ background:#fff; }
    .seg-active{ background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06); color:#1d4ed8 }
    .balloon{
      background: linear-gradient(180deg,#ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
      border-radius: 9999px; /* p√≠lula */
      padding: 14px 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
      text-align:center;
    }
    .balloon-label{ font-size:.7rem; letter-spacing:.05em; text-transform:uppercase; color:#64748b; }
    .balloon-value{ font-size:1.75rem; font-weight:700; margin-top:2px; }
    .th{ padding:.5rem .75rem; text-align:left; font-size:.75rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; color:#64748b; }
    td{ padding:.5rem .75rem; border-top:1px solid #eef2f7; }
  </style>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://dashboard-production-4c05.up.railway.app";
    const phoneIdMap = {
      "732661079928516": "ConnectZap",
      "727586317113885": "Recovery PJ",
      "802977069563598": "Recovery PF",
      "821562937700669": "Mercado Pago Cobran√ßa",
      "779797401888141": "DivZero",
      "829210283602406": "Arc4U",
      "713021321904495": "Serasa",
      "803535039503723": "Mercado Pago Vendas"
    };

    // ===== DOM =====
    const startEl = document.getElementById("start");
    const endEl = document.getElementById("end");
    const cartEl = document.getElementById("carteira");
    const qEl = document.getElementById("q");
    const alertEl = document.getElementById("alert");
    const chips = [...document.querySelectorAll("[data-range]")];

    // tabs
    const segBtns = [...document.querySelectorAll(".seg-btn")];
    const tabMensagens = document.getElementById("tab-mensagens");
    const tabAtend = document.getElementById("tab-atendimentos");

    // KPIs Mensagens
    const k_total = document.getElementById("k_total");
    const k_env   = document.getElementById("k_env");
    const k_ent   = document.getElementById("k_ent");
    const k_lido  = document.getElementById("k_lido");
    const k_dr    = document.getElementById("k_dr");
    const k_rr    = document.getElementById("k_rr");

    // Tabela
    const tbodyMensagens = document.getElementById("tbodyMensagens");
    const tblEmpty = document.getElementById("tblEmpty");

    // Charts (uma inst√¢ncia por gr√°fico)
    let chartMensagens, chartMotivos, chartSeries;
    const chartMensagensEmpty = document.getElementById("chartMensagensEmpty");
    const chartMotivosEmpty = document.getElementById("chartMotivosEmpty");
    const chartSeriesEmpty = document.getElementById("chartSeriesEmpty");

    // KPIs Atend
    const a_em = document.getElementById("a_em");
    const a_conc = document.getElementById("a_conc");
    const a_tma = document.getElementById("a_tma");
    const a_tmr = document.getElementById("a_tmr");

    // ===== Utils =====
    function setAlert(msg){ alertEl.textContent = msg||""; alertEl.classList.toggle("hidden", !msg); }
    function toPct(part, total){ if(!total) return "‚Äî"; return ((part/total)*100).toFixed(1)+"%"; }
    function fmtDurSec(s){
      if(s == null) return "‚Äî";
      const m = Math.floor(s/60), sec = s%60; 
      if(m>=60){ const h=Math.floor(m/60), mm=m%60; return `${h}h ${mm}m`; }
      return `${m}m ${sec}s`;
    }
    function params(){ 
      const p = new URLSearchParams();
      if(startEl.value) p.set("start", startEl.value);
      if(endEl.value) p.set("end", endEl.value);
      if(cartEl.value) p.set("phone_id", cartEl.value);
      if(qEl.value) p.set("q", qEl.value.trim());
      return p.toString();
    }
    function savePermalink(){
      const qs = params();
      const url = location.origin + location.pathname + (qs ? "?"+qs : "");
      history.replaceState(null, "", url);
    }
    function readFromQS(){
      const u = new URL(location.href);
      startEl.value = u.searchParams.get("start") || startEl.value;
      endEl.value   = u.searchParams.get("end") || endEl.value;
      cartEl.value  = u.searchParams.get("phone_id") || "";
      qEl.value     = u.searchParams.get("q") || "";
    }
    function setQuickRange(kind){
      const now = new Date();
      const pad = n => String(n).padStart(2,"0");
      const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      let a = new Date(), b = new Date();
      if(kind==="hoje"){ /* a=b hoje */ }
      if(kind==="7d"){ a.setDate(now.getDate()-6); }
      if(kind==="30d"){ a.setDate(now.getDate()-29); }
      if(kind==="mes"){ a = new Date(now.getFullYear(), now.getMonth(), 1); }
      startEl.value = toISO(a); endEl.value = toISO(b);
    }

    // chips comportamento visual
    function highlightChip(ch){
      chips.forEach(x => x.classList.remove("bg-blue-600","text-white","border-blue-600"));
      if(ch) ch.classList.add("bg-blue-600","text-white","border-blue-600");
    }
    chips.forEach(ch => ch.addEventListener("click", () => {
      const k = ch.dataset.range;
      if(k!=="custom") setQuickRange(k);
      highlightChip(ch);
    }));

    // segmented tabs
    segBtns.forEach(btn => btn.addEventListener("click", () => {
      segBtns.forEach(x => x.classList.remove("seg-active"));
      btn.classList.add("seg-active");
      const id = btn.dataset.tab;
      tabMensagens.classList.toggle("hidden", id!=="mensagens");
      tabAtend.classList.toggle("hidden", id!=="atendimentos");
      render(); // recarrega o conte√∫do vis√≠vel
    }));

    // Preenche carteiras
    (function fillCarteiras(){
      const frag = document.createDocumentFragment();
      Object.keys(phoneIdMap).forEach(id => {
        const opt = document.createElement("option");
        opt.value = id; opt.textContent = phoneIdMap[id];
        frag.appendChild(opt);
      });
      cartEl.appendChild(frag);
    })();

    // ===== Data loaders =====
    async function loadResumoMensagens(){
      const res = await fetch(`${API_BASE}/api/dashboard/resumo?${params()}`);
      if(!res.ok) throw new Error("Falha no resumo (mensagens)");
      return res.json();
    }
    async function loadEnvios(){
      const res = await fetch(`${API_BASE}/api/dashboard/envios?${params()}`);
      if(!res.ok) throw new Error("Falha nos envios");
      return res.json();
    }
    async function loadAtendResumo(){
      const res = await fetch(`${API_BASE}/api/atendimentos/resumo?${params()}`);
      if(!res.ok) throw new Error("Falha no resumo (atendimentos)");
      return res.json();
    }
    async function loadAtendMotivos(){
      const res = await fetch(`${API_BASE}/api/atendimentos/motivos?${params()}`);
      if(!res.ok) throw new Error("Falha nos motivos");
      return res.json();
    }
    async function loadAtendSeries(){
      const res = await fetch(`${API_BASE}/api/atendimentos/series?${params()}`);
      if(!res.ok) throw new Error("Falha nas s√©ries");
      return res.json();
    }

    // ===== Render =====
    async function renderMensagens(){
      try{
        setAlert(""); 
        k_total.textContent = k_env.textContent = k_ent.textContent = k_lido.textContent = "‚Ä¶";
        const r = await loadResumoMensagens();
        const total = r.total||0, env=r.enviados||0, ent=r.entregues||0, lido=r.lidos||0;
        k_total.textContent = total; k_env.textContent = env; k_ent.textContent = ent; k_lido.textContent = lido;
        k_dr.textContent = toPct(ent, env || total);
        k_rr.textContent = toPct(lido, ent || total);
      }catch(e){ setAlert(e.message); }

      try{
        tbodyMensagens.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-slate-500">Carregando‚Ä¶</td></tr>';
        const data = await loadEnvios();
        tbodyMensagens.innerHTML = "";
        tblEmpty.classList.toggle("hidden", data.length>0);

        const labels = [], entregues=[], lidos=[];
        data.forEach(e => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.nome_disparo||"-"}</td>
            <td>${e.grupo_trabalho||"-"}</td>
            <td>${e.criado_em ? new Date(e.criado_em).toLocaleString("pt-BR") : "-"}</td>
            <td class="text-right">${e.total||0}</td>
            <td class="text-right">${e.entregues||0}</td>
            <td class="text-right">${e.lidos||0}</td>`;
          tbodyMensagens.appendChild(tr);
          labels.push(e.nome_disparo||"(sem nome)");
          entregues.push(e.entregues||0);
          lidos.push(e.lidos||0);
        });

        if(chartMensagens){ chartMensagens.destroy(); chartMensagens = null; }
        document.getElementById("chartMensagens").classList.remove("hidden");
        chartMensagensEmpty.classList.add("hidden");

        if(labels.length===0){
          document.getElementById("chartMensagens").classList.add("hidden");
          chartMensagensEmpty.classList.remove("hidden");
        }else{
          const ctx = document.getElementById("chartMensagens").getContext("2d");
          chartMensagens = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {label:"Entregues", data:entregues, backgroundColor:"#3b82f6", stack:"s"},
                {label:"Lidos", data:lidos, backgroundColor:"#10b981", stack:"s"}
              ]
            },
            options: {
              responsive:true,
              maintainAspectRatio:false,   // <- evita loop; usamos altura fixa no pai
              resizeDelay: 200,
              plugins:{ legend:{ position:"top" } },
              scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
            }
          });
        }
      }catch(e){ setAlert(e.message); }
    }

    async function renderAtend(){
      try{
        a_em.textContent=a_conc.textContent=a_tma.textContent=a_tmr.textContent="‚Ä¶";
        const r = await loadAtendResumo();
        a_em.textContent = r.em_atendimento ?? 0;
        a_conc.textContent = r.concluidos ?? 0;
        a_tma.textContent = fmtDurSec(r.tma_segundos);
        a_tmr.textContent = fmtDurSec(r.tmr_segundos);
      }catch(e){ setAlert("Aba Atendimentos ‚Äî " + e.message); }

      // Motivos (pizza)
      try{
        const dados = await loadAtendMotivos();
        if(chartMotivos){ chartMotivos.destroy(); chartMotivos=null; }
        document.getElementById("chartMotivos").classList.remove("hidden");
        chartMotivosEmpty.classList.add("hidden");

        if(!dados.length){
          document.getElementById("chartMotivos").classList.add("hidden");
          chartMotivosEmpty.classList.remove("hidden");
        }else{
          chartMotivos = new Chart(document.getElementById("chartMotivos").getContext("2d"), {
            type:"pie",
            data:{ labels: dados.map(d=>d.motivo), datasets:[{ data: dados.map(d=>d.qtd) }] },
            options:{ responsive:true, maintainAspectRatio:false, resizeDelay:200 }
          });
        }
      }catch(e){ setAlert("Motivos ‚Äî " + e.message); }

      // S√©ries (linha)
      try{
        const s = await loadAtendSeries();
        const map = {};
        (s.mensagens||[]).forEach(r => { const k=r.dia; map[k]=map[k]||{in:0,out:0,conc:0}; map[k].in=r.inbound; map[k].out=r.outbound; });
        (s.concluidos||[]).forEach(r => { const k=r.dia; map[k]=map[k]||{in:0,out:0,conc:0}; map[k].conc=r.concluidos; });
        const dias = Object.keys(map).sort();
        const inb = dias.map(d=>map[d].in), outb = dias.map(d=>map[d].out), conc = dias.map(d=>map[d].conc);

        if(chartSeries){ chartSeries.destroy(); chartSeries=null; }
        document.getElementById("chartSeries").classList.remove("hidden");
        chartSeriesEmpty.classList.add("hidden");

        if(!dias.length){
          document.getElementById("chartSeries").classList.add("hidden");
          chartSeriesEmpty.classList.remove("hidden");
        }else{
          chartSeries = new Chart(document.getElementById("chartSeries").getContext("2d"), {
            type:"line",
            data:{
              labels: dias,
              datasets: [
                {label:"Inbound", data:inb, borderColor:"#2563eb", backgroundColor:"rgba(37,99,235,.15)", fill:true, tension:.3},
                {label:"Outbound", data:outb, borderColor:"#10b981", backgroundColor:"rgba(16,185,129,.15)", fill:true, tension:.3},
                {label:"Conclu√≠dos", data:conc, borderColor:"#f59e0b", backgroundColor:"rgba(245,158,11,.15)", fill:true, tension:.3}
              ]
            },
            options:{ responsive:true, maintainAspectRatio:false, resizeDelay:200, plugins:{legend:{position:"top"}}, scales:{y:{beginAtZero:true}} }
          });
        }
      }catch(e){ setAlert("S√©ries ‚Äî " + e.message); }
    }

    async function render(){
      savePermalink();
      const active = document.querySelector(".seg-btn.seg-active")?.dataset.tab || "mensagens";
      if(active==="mensagens") await renderMensagens();
      else await renderAtend();
    }

    // Export CSV
    document.getElementById("btnExport").addEventListener("click", () => {
      const rows = [["Nome Disparo","Grupo","Data","Total","Entregues","Lidos"]];
      [...tbodyMensagens.querySelectorAll("tr")].forEach(tr => {
        const tds = [...tr.querySelectorAll("td")].map(td => `"${(td.innerText||"").replace(/"/g,'""')}"`);
        rows.push(tds);
      });
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `envios_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    // Aplicar
    document.getElementById("btnAplicar").addEventListener("click", render);

    // Init: per√≠odo padr√£o √∫ltimos 7 dias
    function initDefaults(){
      const now = new Date(); const pad = n=>String(n).padStart(2,"0");
      const toISO = d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const b = new Date(); const a = new Date(); a.setDate(b.getDate()-6);
      startEl.value = toISO(a); endEl.value = toISO(b);
      readFromQS(); // respeita par√¢metros se vierem na URL
      highlightChip(document.querySelector('[data-range="7d"]'));
    }

    initDefaults();
    render();
  </script>
</body>
</html>
